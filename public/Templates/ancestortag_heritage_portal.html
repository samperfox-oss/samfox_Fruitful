<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë§ AncestorTag‚Ñ¢ Heritage Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* Define a consistent color palette */
        :root {
            --primary-color: #22c55e; /* Vibrant green (Fruitful primary) */
            --secondary-color: #3b82f6; /* Blue for accents (Fruitful secondary) */
            --ancestortag-primary: #a78bfa; /* Purple for AncestorTag accents */
            --ancestortag-dark: #6d28d9; /* Deeper purple for AncestorTag buttons */
            --dark-bg: #1a1a1d; /* Deep charcoal */
            --medium-dark-bg: #2a2a2e; /* Slightly lighter charcoal */
            --card-bg: #374151; /* Dark gray for cards */
            --input-bg: #4b5563; /* Even lighter gray for inputs */
            --text-light: #e0e0e0;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Utility classes for consistency */
        .header-bg { background-color: var(--medium-dark-bg); }
        .sidebar-bg { background-color: var(--medium-dark-bg); }
        .main-content-bg { background-color: var(--dark-bg); }
        .card-bg { background-color: var(--card-bg); }
        .input-field {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-light);
            padding: 0.75rem 1rem; /* Enhanced padding for inputs */
            border-radius: 0.5rem; /* Rounded corners for inputs */
        }
        .primary-text { color: var(--primary-color); }
        .secondary-text { color: var(--secondary-color); }
        .muted-text { color: var(--text-muted); }
        .border-dark { border-color: var(--border-color); }
        .hover-bg-light { background-color: rgba(255, 255, 255, 0.1); } /* Slightly lighter on hover */

        /* AncestorTag specific colors */
        .at-primary-text { color: var(--ancestortag-primary); }
        .at-dark-bg { background-color: var(--ancestortag-dark); }
        .at-btn-primary {
            background-color: var(--ancestortag-dark);
            color: white;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .at-btn-primary:hover {
            background-color: #5b21b6; /* slightly lighter purple */
            transform: translateY(-1px);
        }
        .at-btn-secondary {
            background-color: var(--card-bg); /* Use card-bg for secondary */
            color: var(--text-light);
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .at-btn-secondary:hover {
            background-color: #4b5563; /* slightly lighter gray */
            transform: translateY(-1px);
        }
        .at-badge {
            background-color: #4c1d95; /* Accent purple */
            color: var(--text-light);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .at-provenance-step {
            background-color: var(--input-bg);
            border-left: 3px solid var(--ancestortag-dark);
            padding-left: 0.75rem;
            position: relative;
        }
        .at-provenance-step::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-color: var(--ancestortag-dark);
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }
        .at-gradient-heading {
            background: linear-gradient(to right, var(--ancestortag-primary), #c4b5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 1rem;
            }
            .sidebar-nav-item {
                justify-content: center; /* Center items on small screens */
            }
            .dashboard-container {
                flex-direction: column;
            }
            .main-content {
                width: 100%;
            }
            .grid-cols-2-md {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            /* Adjust main content padding when sidebars stack */
            .main-content-wrapper {
                flex-direction: column;
            }
            .music-sub-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 1rem;
            }
            .music-content-area {
                width: 100%;
            }
        }
        /* Style for the active navigation item in the sidebar */
        .active-nav-item {
            background-color: var(--primary-color);
            color: white !important; /* !important to override hover */
        }
        .active-nav-item:hover {
            background-color: var(--primary-color) !important; /* Ensure hover doesn't change color */
        }
        .code-block {
            background-color: #2b2b2b;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            overflow-x: auto;
        }
        .api-key-warning {
            color: #ef4444; /* red-500 */
            background-color: #fecaca; /* red-200 */
            border-left: 4px solid #ef4444;
            padding: 1rem;
            margin-top: 1rem;
            font-weight: 600;
        }
        /* Styles for map containers */
        gmp-map, #leaflet-map-container { /* Updated selector for gmp-map */
            height: 400px; /* Adjust height as needed */
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: var(--card-bg); /* card-bg */
        }

        /* Family Tree Specific Styles */
        .family-member-card {
            background-color: #2a2a2e; /* Slightly darker card */
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: transform 0.2s ease-in-out;
        }
        .family-member-card:hover {
            transform: translateY(-2px);
        }
        .family-member-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        @media (min-width: 640px) {
            .family-member-details {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .family-member-details strong {
            color: var(--primary-color);
        }
        .family-tree-link {
            text-decoration: underline;
            color: var(--secondary-color);
            cursor: pointer;
        }
        .tree-node {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .tree-line {
            position: absolute;
            background-color: #6b7280; /* Gray line */
            z-index: 0;
        }
        .leaflet-map-container { /* Re-used for family map */
            height: 400px; /* Adjust height as needed */
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: var(--card-bg); /* card-bg */
        }

        /* To-Do list specific styles */
        .todo-item {
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .todo-item.completed {
            text-decoration: line-through;
            color: var(--text-muted);
            background-color: rgba(75, 85, 99, 0.5); /* gray-600 with transparency */
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px; /* For vertical scrollbar */
            height: 8px; /* For horizontal scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--card-bg);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="header-bg p-4 shadow-lg sticky top-0 z-50 flex items-center justify-between border-b border-dark">
        <div class="flex items-center gap-3">
            <i class="fas fa-sitemap text-3xl at-primary-text"></i> <!-- Changed icon and color -->
            <span class="text-2xl font-bold text-light">AncestorTag‚Ñ¢ Heritage Portal</span> <!-- Updated title -->
        </div>
        <div class="flex items-center gap-4">
            <!-- Enhanced Search Bar -->
            <div class="relative w-64">
                <input 
                    type="text" 
                    placeholder="Search portal..." 
                    class="w-full px-4 py-2 pl-10 rounded-full bg-gray-700 border border-dark text-text-light placeholder-muted-text focus:outline-none focus:ring-2 focus:ring-primary-color transition-all duration-300"
                >
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-muted-text"></i>
            </div>
            <button class="text-text-light hover:text-primary-color transition duration-200">
                <i class="fas fa-bell text-xl"></i>
            </button>
            <button class="text-text-light hover:text-primary-color transition duration-200">
                <i class="fas fa-user-circle text-xl"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-grow dashboard-container">
        <nav class="sidebar-bg w-64 p-6 border-r border-dark flex flex-col items-start space-y-4 shadow-md sidebar">
            <h2 class="text-xl font-semibold primary-text mb-4">Navigation</h2>
            <a href="#" id="nav-ancestor-tag-section" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-seedling"></i> AncestorTag‚Ñ¢
            </a>
            <a href="#" id="nav-family-hub" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-house-user"></i> Family Hub
            </a>
            <a href="#" id="nav-travel-commerce" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-suitcase-rolling"></i> Travel & Commerce
            </a>
            <a href="#" id="nav-productivity" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-tasks"></i> Productivity
            </a>
            <a href="#" id="nav-utilities" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-tools"></i> Utilities
            </a>
            <a href="#" id="nav-profile" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-user-circle"></i> Profile
            </a>
            <a href="#" id="nav-graphs" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-chart-pie"></i> Graphs
            </a>

            <div class="w-full h-px bg-gray-700 my-2"></div> <!-- Separator -->

            <a href="#" id="nav-overview" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-tachometer-alt"></i> Overview
            </a>
            <a href="#" id="nav-analytics" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-chart-line"></i> Data Analytics
            </a>
            <a href="#" id="nav-admin-panel" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-users-cog"></i> Admin Panel
            </a>
            <a href="#" id="nav-music" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-music"></i> Music & Media
            </a>
            <a href="#" id="nav-ai-gemini" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-robot"></i> AI Gemini
            </a>
            <a href="#" id="nav-maps" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-map-marked-alt"></i> Maps
            </a>
            <a href="#" id="nav-meeting-minutes" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-clipboard-list"></i> Meeting Minutes
            </a>
            <a href="#" id="nav-settings" class="sidebar-nav-item flex items-center gap-3 w-full p-3 rounded-lg text-lg font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                <i class="fas fa-cog"></i> Settings
            </a>
        </nav>

        <main class="flex-grow p-8 main-content-bg overflow-y-auto main-content">
            <div class="flex h-full main-content-wrapper">
                <nav id="musicSubSidebar" class="sidebar-bg w-48 p-4 border-r border-dark flex-col items-start space-y-3 shadow-md mr-8 hidden music-sub-sidebar">
                    <h3 class="text-lg font-semibold primary-text mb-3">Music Library</h3>
                    <a href="#" id="music-sub-allMusic" class="sidebar-nav-item flex items-center gap-2 w-full p-2 rounded-lg text-base font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                        <i class="fas fa-compact-disc"></i> All Music
                    </a>
                    <a href="#" id="music-sub-musicPlaylists" class="sidebar-nav-item flex items-center gap-2 w-full p-2 rounded-lg text-base font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                        <i class="fas fa-list-music"></i> Playlists
                    </a>
                    <a href="#" id="music-sub-artists" class="sidebar-nav-item flex items-center gap-2 w-full p-2 rounded-lg text-base font-medium transition duration-200 text-text-light hover:bg-hover-bg-light">
                        <i class="fas fa-microphone-alt"></i> Artists
                    </a>
                </nav>

                <div class="flex-grow">
                    <!-- AncestorTag Main Section -->
                    <section id="ancestor-tag-section" class="mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold at-primary-text mb-6">AncestorTag‚Ñ¢ Protocols in Action</h2>
                        <p class="muted-text mb-8">
                            Experience AncestorTag: Linking Generations in the Digital Cosmos. Seamlessly connect your invaluable cultural content to its ancestral lineage, providing irrefutable digital provenance and enriching history for eons to come.
                        </p>
                        <button id="openAddModalBtn" class="px-10 py-4 at-btn-primary rounded-full text-lg font-bold hover:shadow-lg">
                            ‚ûï Tag New Ancestral Content
                        </button>

                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mt-12">
                            <!-- Left Sidebar: Filters & Quick Stats -->
                            <aside class="lg:col-span-1 space-y-6">
                                <div class="card-bg p-6">
                                    <h3 class="text-xl font-bold mb-4 at-primary-text">Dashboard Metrics</h3>
                                    <ul class="space-y-3 text-sm text-gray-300">
                                        <li>Total Tags: <span id="totalTagsCount" class="font-bold text-white">0</span></li>
                                        <li>Unique Ancestors: <span id="uniqueAncestorsCount" class="font-bold text-white">0</span></li>
                                        <li>Documents Tagged: <span id="docCount" class="font-bold text-white">0</span></li>
                                        <li>Oral Histories Tagged: <span id="oralCount" class="font-bold text-white">0</span></li>
                                        <li>Rituals Tagged: <span id="ritualCount" class="font-bold text-white">0</span></li>
                                    </ul>
                                </div>

                                <div class="card-bg p-6">
                                    <h3 class="text-xl font-bold mb-4 at-primary-text">Filter Tags</h3>
                                    <input type="text" id="filterAncestor" placeholder="Filter by Ancestor Name..." class="w-full p-2 rounded input-field mb-3" onkeyup="filterAncestralRecords()">
                                    <select id="filterContentType" class="w-full p-2 rounded input-field mb-3" onchange="filterAncestralRecords()">
                                        <option value="">All Content Types</option>
                                        <option value="Document">Document</option>
                                        <option value="Oral History">Oral History</option>
                                        <option value="Ritual Description">Ritual Description</option>
                                        <option value="Artifact">Artifact</option>
                                        <option value="Visual Record">Visual Record</option>
                                    </select>
                                    <!-- Fixed button sizing with w-full and mt-2 for proper stacking -->
                                    <button onclick="clearFilters()" class="at-btn-secondary w-full py-2 rounded mt-2">Clear Filters</button>
                                </div>
                            </aside>

                            <!-- Main Content: Ancestral Records Display -->
                            <section class="lg:col-span-3">
                                <h3 class="text-2xl font-bold mb-6 at-primary-text">Your Tagged Ancestral Records</h3>
                                <div id="ancestralRecordsList" class="space-y-6">
                                    <p class="text-gray-400 text-center">No records found. Click "‚ûï Tag New Ancestral Content" to add your first!</p>
                                </div>
                            </section>
                        </div>
                    </section>
                    <!-- End AncestorTag Main Section -->

                    <!-- Family Hub Section -->
                    <section id="family-hub" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Family Hub: Connect & Cherish üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h2>
                        <p class="muted-text mb-8">
                            A central space for all your family's needs: from tracking lineage and managing finances to celebrating milestones.
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Family Tree Card -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Family Tree üå≥</h3>
                                <p class="text-muted-text mb-4">Visualize and manage your family's atom-level lineage.</p>
                                <button onclick="showSection('family-tree')" class="btn btn-primary bg-secondary-color hover:bg-blue-600 text-white py-2 px-4 rounded w-full">
                                    Go to Family Tree
                                </button>
                            </div>

                            <!-- Financial Hub Card -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Financial Hub üí∞</h3>
                                <p class="text-muted-text mb-4">Manage family savings, personal wallets, and emergency funds.</p>
                                <button onclick="showSection('financial-hub')" class="btn btn-primary bg-secondary-color hover:bg-blue-600 text-white py-2 px-4 rounded w-full">
                                    Go to Financial Hub
                                </button>
                            </div>

                            <!-- Gift Lists Card -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Gift Lists üéÅ</h3>
                                <p class="text-muted-text mb-4">Keep track of Christmas and Birthday gift ideas for every family member.</p>
                                <button onclick="showSection('gift-lists')" class="btn btn-primary bg-secondary-color hover:bg-blue-600 text-white py-2 px-4 rounded w-full">
                                    Go to Gift Lists
                                </button>
                            </div>

                             <!-- Family Calendar Card -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Family Calendar üóìÔ∏è</h3>
                                <p class="text-muted-text mb-4">Keep track of all important family events, birthdays, anniversaries, and travel plans.</p>
                                <button onclick="showSection('family-calendar')" class="btn btn-primary bg-secondary-color hover:bg-blue-600 text-white py-2 px-4 rounded w-full">
                                    Go to Family Calendar
                                </button>
                            </div>
                        </div>
                    </section>
                    <!-- End Family Hub Section -->

                    <!-- Financial Hub Section -->
                    <section id="financial-hub" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Financial Hub: Fruitful's Secure Wallets üí≥</h2>
                        <p class="muted-text mb-8">
                            Manage your family's finances with secure, integrated saving funds and direct connections to personal wallets via Fruitful's financial protocols.
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Family Saving Fund -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Family Saving Fund üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h3>
                                <p class="text-lg font-bold text-light mb-2">Balance: $<span id="familySavingFundBalance">0.00</span></p>
                                <input type="number" id="familySavingAmount" placeholder="Amount" class="w-full p-2 rounded input-field mb-2" step="0.01">
                                <div class="flex space-x-2">
                                    <button onclick="updateFund('familySavingFund', 'add')" class="bg-primary-color hover:bg-green-600 text-white px-4 py-2 rounded flex-grow">Add</button>
                                    <button onclick="updateFund('familySavingFund', 'subtract')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded flex-grow">Withdraw</button>
                                </div>
                                <button onclick="simulatePayPalTransfer('familySavingFund')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full mt-3">Transfer via PayPal (Simulated)</button>
                            </div>

                            <!-- Personal Saving Fund (Wallet) -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Personal Saving Fund (Wallet) üë§</h3>
                                <p class="text-lg font-bold text-light mb-2">Balance: $<span id="personalSavingFundBalance">0.00</span></p>
                                <input type="number" id="personalSavingAmount" placeholder="Amount" class="w-full p-2 rounded input-field mb-2" step="0.01">
                                <div class="flex space-x-2">
                                    <button onclick="updateFund('personalSavingFund', 'add')" class="bg-primary-color hover:bg-green-600 text-white px-4 py-2 rounded flex-grow">Add</button>
                                    <button onclick="updateFund('personalSavingFund', 'subtract')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded flex-grow">Withdraw</button>
                                </div>
                                <button onclick="simulatePayPalTransfer('personalSavingFund')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full mt-3">Transfer via PayPal (Simulated)</button>
                            </div>

                            <!-- Family Emergency Fund -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Family Emergency Fund üö®</h3>
                                <p class="text-lg font-bold text-light mb-2">Balance: $<span id="emergencyFundBalance">0.00</span></p>
                                <input type="number" id="emergencyFundAmount" placeholder="Amount" class="w-full p-2 rounded input-field mb-2" step="0.01">
                                <div class="flex space-x-2">
                                    <button onclick="updateFund('emergencyFund', 'add')" class="bg-primary-color hover:bg-green-600 text-white px-4 py-2 rounded flex-grow">Add</button>
                                    <button onclick="updateFund('emergencyFund', 'subtract')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded flex-grow">Withdraw</button>
                                </div>
                                <button onclick="simulatePayPalTransfer('emergencyFund')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full mt-3">Transfer via PayPal (Simulated)</button>
                            </div>
                            
                            <!-- PayPal Wallets for Members (Simulated Display) -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Member PayPal Wallets (Simulated) üí≥</h3>
                                <div id="memberWalletsList" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                                    <p class="text-muted-text">Connect to PayPal for real wallet integration. Showing mock data.</p>
                                    <p>John Doe: <span class="font-bold text-light">$250.00</span> (PayPal ID: JDoe123)</p>
                                    <p>Jane Smith: <span class="font-bold text-light">$120.50</span> (PayPal ID: JSmith456)</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full mt-3">Connect to PayPal</button>
                            </div>

                            <div class="lg:col-span-2 text-center text-red-400 p-4 border border-red-500 rounded-lg">
                                <p class="font-bold">Important: All financial transactions are SIMULATED for demo purposes.</p>
                                <p class="text-sm">Real PayPal integration requires secure API keys, OAuth, and server-side processing.</p>
                            </div>
                        </div>
                    </section>
                    <!-- End Financial Hub Section -->

                    <!-- Gift Lists Section -->
                    <section id="gift-lists" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Gift Lists: Celebrate Milestones üéÅ</h2>
                        <p class="muted-text mb-8">
                            Never miss a special occasion! Keep track of gift ideas for Christmas and birthdays for everyone in the family.
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Christmas List -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Christmas List üéÑ</h3>
                                <form id="christmasListForm" class="flex mb-4">
                                    <input type="text" id="christmasItemInput" placeholder="Add gift idea for whom?" class="w-full p-2 rounded-l input-field flex-grow">
                                    <button type="submit" class="bg-primary-color hover:bg-green-600 text-white px-4 py-2 rounded-r">Add</button>
                                </form>
                                <div id="christmasList" class="space-y-2 max-h-64 overflow-y-auto">
                                    <p class="text-muted-text text-center">No Christmas gift ideas yet.</p>
                                </div>
                            </div>

                            <!-- Birthday List -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Birthday List üéÇ</h3>
                                <form id="birthdayListForm" class="flex mb-4">
                                    <input type="text" id="birthdayItemInput" placeholder="Add gift idea for whom?" class="w-full p-2 rounded-l input-field flex-grow">
                                    <button type="submit" class="bg-primary-color hover:bg-green-600 text-white px-4 py-2 rounded-r">Add</button>
                                </form>
                                <div id="birthdayList" class="space-y-2 max-h-64 overflow-y-auto">
                                    <p class="text-muted-text text-center">No Birthday gift ideas yet.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- End Gift Lists Section -->

                    <!-- Profile Section -->
                    <section id="profile" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">My Profile üë§</h2>
                        <p class="muted-text mb-8">
                            Manage your personal information and profile image within the Heritage Portal.
                        </p>

                        <div class="flex flex-col items-center space-y-6">
                            <div class="w-32 h-32 bg-gray-600 rounded-full flex items-center justify-center overflow-hidden border-4 border-primary-color">
                                <img id="profileImagePreview" src="https://placehold.co/128x128/374151/e0e0e0?text=Upload" alt="Profile" class="w-full h-full object-cover">
                            </div>
                            <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="previewProfileImage(event)">
                            <button onclick="document.getElementById('profileImageInput').click()" class="bg-secondary-color hover:bg-blue-600 text-white px-6 py-2 rounded-full">
                                <i class="fas fa-camera mr-2"></i> Upload Image
                            </button>
                            
                            <div class="w-full max-w-md space-y-4 mt-8">
                                <h3 class="text-xl font-bold primary-text mb-2">Personal Details</h3>
                                <div>
                                    <label for="userName" class="block text-sm font-medium text-gray-300">Name</label>
                                    <input type="text" id="userName" class="w-full p-2 rounded input-field" value="Portal User" disabled>
                                </div>
                                <div>
                                    <label for="userEmail" class="block text-sm font-medium text-gray-300">Email</label>
                                    <input type="email" id="userEmail" class="w-full p-2 rounded input-field" value="user@ancestortag.com" disabled>
                                </div>
                                <button class="bg-primary-color hover:bg-green-600 text-white px-6 py-2 rounded-full w-full">Save Changes</button>
                            </div>
                        </div>
                    </section>
                    <!-- End Profile Section -->

                    <!-- Travel & Commerce Section -->
                    <section id="travel-commerce" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Travel & Commerce: Fruitful Global Network üåç</h2>
                        <p class="muted-text mb-8">
                            Plan and book global travel for your family and access integrated e-commerce services, all powered by Fruitful's secure protocols.
                        </p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Travel Hub Card -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Travel Hub ‚úàÔ∏è</h3>
                                <p class="text-muted-text mb-4">Book flights, trains, taxis, movies, and holiday packages via Fruitful.</p>
                                <button onclick="showSection('travel-hub')" class="btn btn-primary bg-secondary-color hover:bg-blue-600 text-white py-2 px-4 rounded w-full">
                                    Go to Travel Hub
                                </button>
                            </div>

                            <!-- Homemart.africa Integration -->
                            <div class="card-bg p-6">
                                <h3 class="text-xl font-bold primary-text mb-4">Homemart.africa E-commerce üõí</h3>
                                <p class="text-muted-text mb-4">Access our company's integrated e-commerce platform directly.</p>
                                <div class="w-full h-80 border border-dark rounded-lg overflow-hidden relative mb-4">
                                    <iframe src="https://www.homemart.africa/" class="w-full h-full border-none" title="Homemart.africa"></iframe>
                                    <div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 text-center text-text-light text-sm">
                                        <p><i class="fas fa-info-circle mr-2"></i> For security, direct sign-up/login within this iframe is restricted by browser policies.</p>
                                        <p class="mt-2">Please use the <a href="https://www.homemart.africa/" target="_blank" class="text-primary-color hover:underline">Homemart.africa website</a> directly for full interaction, or integrate your dashboard login with Homemart's API (future feature).</p>
                                    </div>
                                </div>
                                <a href="https://www.homemart.africa/" target="_blank" class="btn btn-primary bg-primary-color hover:bg-green-600 text-white py-2 px-4 rounded w-full mt-2">
                                    Visit Homemart.africa
                                </a>
                            </div>
                        </div>
                    </section>
                    <!-- End Travel & Commerce Section -->


                    <section id="overview" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Dashboard Overview</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Total Users</h3>
                                <p class="text-4xl font-bold primary-text">15,420</p>
                            </div>
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Active Projects</h3>
                                <p class="text-4xl font-bold secondary-text">245</p>
                            </div>
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Data Processed (TB)</h3>
                                <p class="text-4xl font-bold text-teal-400">89.5</p>
                            </div>
                        </div>
                        <div class="mt-8">
                            <h3 class="text-2xl font-semibold text-text-light mb-4">Quick Stats</h3>
                            <ul class="list-disc list-inside text-muted-text space-y-2">
                                <li>Daily Active Users: 3,120</li>
                                <li>New Registrations This Week: 125</li>
                                <li>Average Session Duration: 12 min</li>
                                <li>System Uptime: 99.9%</li>
                            </ul>
                        </div>
                    </section>

                    <section id="analytics" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Data Analytics</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 grid-cols-2-md">
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Usage Trends</h3>
                                <p class="muted-text">Graph showing daily user activity and data consumption.</p>
                                <div class="mt-4 bg-gray-800 h-48 flex items-center justify-center rounded-md">
                                    <span class="text-muted-text">Placeholder Chart</span>
                                </div>
                            </div>
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Performance Metrics</h3>
                                <p class="muted-text">Key performance indicators over time.</p>
                                <div class="mt-4 bg-gray-800 h-48 flex items-center justify-center rounded-md">
                                    <span class="text-muted-text">Placeholder Chart</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="admin-panel" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Admin Panel</h2>
                        <p class="muted-text mb-4">Manage users, review content, and configure system settings.</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Total Active Admins</h3>
                                <p class="text-4xl font-bold secondary-text">7</p>
                            </div>
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">Pending Approvals</h3>
                                <p class="text-4xl font-bold text-yellow-400">12</p>
                            </div>
                            <div class="p-5 bg-gray-700 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-light mb-2">System Health</h3>
                                <p class="text-4xl font-bold text-green-400">Optimal</p>
                            </div>
                        </div>

                        <h3 class="text-2xl font-semibold text-text-light mb-4">User Management</h3>
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <input 
                                type="text" 
                                placeholder="Search users..." 
                                class="flex-grow px-4 py-2 rounded-lg bg-gray-700 border border-dark text-text-light placeholder-muted-text focus:outline-none focus:ring-2 focus:ring-primary-color"
                            >
                            <select class="px-4 py-2 rounded-lg bg-gray-700 border border-dark text-text-light focus:outline-none focus:ring-2 focus:ring-primary-color">
                                <option value="">Filter by Role</option>
                                <option value="admin">Admin</option>
                                <option value="user">User</option>
                                <option value="moderator">Moderator</option>
                            </select>
                            <button class="px-4 py-2 bg-primary-color text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200">Apply Filters</button>
                        </div>
                        <div class="overflow-x-auto mb-8">
                            <table class="min-w-full bg-gray-700 rounded-lg shadow-md">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-muted-text uppercase tracking-wider border-b border-dark">User ID</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-muted-text uppercase tracking-wider border-b border-dark">Name</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-muted-text uppercase tracking-wider border-b border-dark">Email</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-muted-text uppercase tracking-wider border-b border-dark">Role</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-muted-text uppercase tracking-wider border-b border-dark">Status</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-muted-text uppercase tracking-wider border-b border-dark">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="hover:bg-gray-600 transition duration-200">
                                        <td class="py-3 px-4 border-b border-dark">FRTL-001</td>
                                        <td class="py-3 px-4 border-b border-dark">Alice Smith</td>
                                        <td class="py-3 px-4 border-b border-dark">alice@example.com</td>
                                        <td class="py-3 px-4 border-b border-dark">Admin</td>
                                        <td class="py-3 px-4 border-b border-dark"><span class="bg-green-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full">Active</span></td>
                                        <td class="py-3 px-4 border-b border-dark">
                                            <button class="text-blue-400 hover:text-blue-300 mr-2">Edit</button>
                                            <button class="text-red-400 hover:text-red-300">Delete</button>
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-gray-600 transition duration-200">
                                        <td class="py-3 px-4 border-b border-dark">FRTL-002</td>
                                        <td class="py-3 px-4 border-b border-dark">Bob Johnson</td>
                                        <td class="py-3 px-4 border-b border-dark">bob@example.com</td>
                                        <td class="py-3 px-4 border-b border-dark">User</td>
                                        <td class="py-3 px-4 border-b border-dark"><span class="bg-yellow-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full">Pending</span></td>
                                        <td class="py-3 px-4 border-b border-dark">
                                            <button class="text-blue-400 hover:text-blue-300 mr-2">Edit</button>
                                            <button class="text-red-400 hover:text-red-300">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h3 class="text-2xl font-semibold text-text-light mb-4">Admin Assistant (AI Powered)</h3>
                        <p class="muted-text mb-3">Ask Gemini AI for insights on administrative tasks, user trends, or content moderation advice.</p>
                        <textarea id="adminAIPrompt" rows="4" class="w-full p-3 rounded-lg bg-gray-700 border border-dark text-text-light placeholder-muted-text focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., 'Summarize recent user activity trends for the past week.', 'Suggest a policy for handling spam content.'"></textarea>
                        <button id="sendAdminAIPrompt" class="px-6 py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-200 mt-4 self-end">
                            Ask Admin Assistant
                        </button>
                        <div class="mt-4 p-4 bg-gray-700 rounded-lg border border-dark">
                            <h4 class="text-lg font-semibold text-text-light mb-2">Admin Assistant Response:</h4>
                            <div id="adminAIResponse" class="text-text-light whitespace-pre-wrap">
                                Your AI-powered admin assistant response will appear here.
                            </div>
                            <div id="adminAIError" class="text-red-400 mt-2 hidden"></div>
                        </div>

                    </section>

                    <section id="music" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark flex-grow music-content-area">
                        <h2 class="text-3xl font-bold primary-text mb-6">Music & Media</h2>
                        <p class="muted-text text-center mb-6">Explore curated music and media content from our partners.</p>

                        <div id="allMusicContent" class="flex flex-col items-center justify-center space-y-6">
                            <h3 class="text-xl font-semibold text-text-light mb-2">All Music Tracks</h3>
                            <div class="w-full max-w-xl">
                                <h4 class="text-lg font-semibold text-text-light mb-2">Album: The Fated Sky</h4>
                                <iframe style="border-radius:12px" src="https://open.spotify.com/embed/album/3RyjFxsU9hcmg14vqzUUMy?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                            </div>

                            <div class="w-full max-w-xl">
                                <h4 class="text-lg font-semibold text-text-light mb-2">Track: No Reason</h4>
                                <iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/2kdQY3b6dDRGonyIzcWljc?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                            </div>

                            <div class="w-full max-w-xl">
                                <h4 class="text-lg font-semibold text-text-light mb-2">Track: Space Song</h4>
                                <iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/6Xe9wT5xeZETPwtaP2ynUz?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                            </div>
                        </div>

                        <div id="musicPlaylistsContent" class="hidden">
                            <h3 class="text-xl font-semibold text-text-light mb-4">Your Music Playlists</h3>
                            <ul class="list-disc list-inside text-muted-text space-y-2">
                                <li>Fruitful Focus Playlist</li>
                                <li>Deep Work Rhythms</li>
                                <li>Relax & Grow Collection</li>
                            </ul>
                        </div>

                        <div id="artistsContent" class="hidden">
                            <h3 class="text-xl font-semibold text-text-light mb-4">Featured Artists</h3>
                            <ul class="list-disc list-inside text-muted-text space-y-2">
                                <li>Artist A - Genre: Ambient</li>
                                <li>Artist B - Genre: Lo-Fi</li>
                                <li>Artist C - Genre: Classical</li>
                            </ul>
                        </div>
                    </section>

                    <section id="ai-gemini" class="mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">AI Gemini Integration</h2>
                        <p class="muted-text mb-4">Interact with the Gemini AI model directly from your dashboard.</p>

                        <div class="api-key-warning mb-4">
                            <strong>Security Alert!</strong> For production, never expose your API key directly in client-side code. Use a backend server to proxy your AI requests.
                        </div>

                        <!-- General Gemini Prompt -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-text-light mb-3">General Query ‚ú®</h3>
                            <textarea id="geminiPrompt" rows="4" class="w-full p-3 rounded-lg bg-gray-700 border border-dark text-text-light placeholder-muted-text focus:outline-none focus:ring-2 focus:ring-primary-color" placeholder="Enter your prompt for Gemini AI here... (e.g., 'Explain how AI works in a few words', 'Write a short poem about fruit.')"></textarea>
                            <button id="sendGeminiPrompt" class="px-6 py-3 bg-primary-color text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200 mt-4 self-end">
                                Send to Gemini
                            </button>
                            <div class="mt-4 p-4 bg-gray-700 rounded-lg border border-dark">
                                <h4 class="text-lg font-semibold text-text-light mb-2">Gemini AI Response:</h4>
                                <div id="geminiResponse" class="text-text-light whitespace-pre-wrap">
                                    Type a general prompt and click "Send to Gemini" to get a response.
                                </div>
                                <div id="geminiError" class="text-red-400 mt-2 hidden"></div>
                            </div>
                        </div>

                        <!-- Coding Partner Feature -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-text-light mb-3">Coding Partner ‚ú®</h3>
                            <p class="muted-text mb-3">Get explanations for code, generate snippets, or debug issues.</p>
                            <textarea id="codingPrompt" rows="6" class="w-full p-3 rounded-lg bg-gray-700 border border-dark text-text-light placeholder-muted-text focus:outline-none focus:ring-2 focus:ring-secondary-color" placeholder="e.g., 'Explain this Python code: def factorial(n): ...', or 'Write a JavaScript function to sort an array.'"></textarea>
                            <button id="sendCodingPrompt" class="px-6 py-3 bg-secondary-color text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-200 mt-4 self-end">
                                Ask Coding Partner
                            </button>
                            <div class="mt-4 p-4 bg-gray-700 rounded-lg border border-dark">
                                <h4 class="text-lg font-semibold text-text-light mb-2">Coding Partner Response:</h4>
                                <div id="codingResponse" class="text-text-light whitespace-pre-wrap">
                                    Ask your coding question here.
                                </div>
                                <div id="codingError" class="text-red-400 mt-2 hidden"></div>
                            </div>
                        </div>

                        <!-- Career Guide Feature -->
                        <div>
                            <h3 class="text-xl font-semibold text-text-light mb-3">Career Guide ‚ú®</h3>
                            <p class="muted-text mb-3">Receive advice on career paths, resume building, or interview preparation.</p>
                            <textarea id="careerPrompt" rows="4" class="w-full p-3 rounded-lg bg-gray-700 border border-dark text-text-light placeholder-muted-text focus:outline-none focus:ring-2 focus:ring-teal-400" placeholder="e.g., 'What are key skills for a data scientist?', or 'Give me tips for a software engineering interview.'"></textarea>
                            <button id="sendCareerPrompt" class="px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 transition duration-200 mt-4 self-end">
                                Get Career Advice
                            </button>
                            <div class="mt-4 p-4 bg-gray-700 rounded-lg border border-dark">
                                <h4 class="text-lg font-semibold text-text-light mb-2">Career Guide Response:</h4>
                                <div id="careerResponse" class="text-text-light whitespace-pre-wrap">
                                    Ask your career question here.
                                </div>
                                <div id="careerError" class="text-red-400 mt-2 hidden"></div>
                            </div>
                        </div>
                    </section>

                    <section id="maps" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Interactive Maps</h2>
                        <p class="muted-text mb-4">Explore different mapping integrations for your dashboard.</p>

                        <div class="space-y-8">
                            <div class="card-bg p-4 rounded-lg border border-dark">
                                <h3 class="text-2xl font-semibold secondary-text mb-3">Google Maps (Advanced Marker)</h3>
                                <p class="muted-text mb-3">An interactive map powered by Google Maps Platform, featuring advanced markers. Requires an API key.</p>
                                <gmp-map center="40.12150192260742,-100.45039367675781" zoom="4" map-id="DEMO_MAP_ID">
                                    <gmp-advanced-marker position="40.12150192260742,-100.45039367675781" title="My location"></gmp-advanced-marker>
                                </gmp-map>
                                <div class="api-key-warning mt-4">
                                    <strong>IMPORTANT:</strong> The Google Maps API key is embedded in the script tag in `showSection` function. For production, **never expose your API key directly in client-side code.** Consider using a backend proxy.
                                    <br>
                                    If you are getting an `InvalidKeyMapError`, ensure `AIzaSyBPG8dG29cl0TvYRGyLozejGed5Wj5Ab80` is valid and has "Maps JavaScript API" enabled in your Google Cloud Console, along with correct application restrictions.
                                </div>
                            </div>

                            <div class="card-bg p-4 rounded-lg border border-dark">
                                <h3 class="text-2xl font-semibold secondary-text mb-3">Leaflet.js with OpenStreetMap</h3>
                                <p class="muted-text mb-3">A free and open-source interactive map solution using OpenStreetMap data. No API key needed for basic use.</p>
                                <div id="leaflet-map-container"></div>
                            </div>
                        </div>
                    </section>

                    <section id="meeting-minutes" class="hidden mb-8 p-6 card-bg rounded-lg shadow-xl border border-dark">
                        <h2 class="text-3xl font-bold primary-text mb-6">Meeting Minutes: Fruitful Dashboard Development</h2>
                        <p class="text-lg muted-text mb-4">A quick recap of our discussions regarding API integrations and future features.</p>

                        <div class="space-y-8">
                            <div>
                                <h3 class="text-2xl font-semibold text-text-light mb-3">Meeting Details:</h3>
                                <ul class="list-disc list-inside ml-4 text-text-light space-y-1">
                                    <li><strong>Date:</strong> June 23, 2025</li>
                                    <li><strong>Time:</strong> 18:45 SAST (6:45 PM, Silver Lakes Golf Estate, Gauteng, South Africa)</li>
                                    <li><strong>Attendees:</strong> Fruitful Dashboard Development Team (represented by user and Gemini AI)</li>
                                </ul>
                            </div>

                            <div>
                                <h3 class="text-2xl font-semibold text-text-light mb-3">1. Review of Previous API Discussions:</h3>
                                <div class="space-y-4 ml-4">
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Design Styling API Key:</h4>
                                        <p class="muted-text"><strong>Conclusion:</strong> No single "API key" for generic styling. Styling handled primarily by CSS (e.g., Tailwind CSS). Specific design services (e.g., Google Fonts, mapping APIs with custom styles) *would* require their own API keys.</p>
                                        <p class="muted-text mt-1"><strong>Action:</strong> Continue using Tailwind CSS. Explore specific API-driven styling if a particular design service is integrated.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Language Toggler:</h4>
                                        <p class="muted-text"><strong>Conclusion:</strong> Achieved via JavaScript logic and `data-key` attributes for translatable text. No external API key strictly necessary for the toggler if translations are stored locally.</p>
                                        <p class="muted-text mt-1"><strong>Action:</strong> Current implementation is good. For complex internationalization, consider dedicated I18n JavaScript libraries or a translation API if dynamic, on-the-fly translation is required.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Selector to Change All Text in HTML with Script:</h4>
                                        <p class="muted-text"><strong>Conclusion:</strong> `document.querySelectorAll()` with specific tag names or custom attributes is the best method for targeted text manipulation. Use `document.querySelectorAll('*')` with extreme caution.</p>
                                        <p class="muted-text mt-1"><strong>Action:</strong> Continue using specific selectors for controlled text modification.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">General Helpful API Categories (Recap):</h4>
                                        <ul class="list-disc list-inside ml-4 text-muted-text space-y-1">
                                            <li>**Mapping & Location:** Google Maps Platform (requires key).</li>
                                            <li>**Data & Information:** OpenWeatherMap (key), REST Countries (often no key), News API (key), Free Dictionary (no key).</li>
                                            <li>**Authentication & User Management:** Firebase Auth, Auth0.</li>
                                            <li>**Payment Processing:** Stripe (key), PayPal (credentials).</li>
                                            <li>**AI/ML:** OpenAI (key), Hugging Face Inference API (key), **Gemini API (key - our current focus!)**.</li>
                                            <li>**Image/Media:** Pexels API / Unsplash API (keys).</li>
                                            <li>**Utility:** Bitly API (key), SendGrid API / Mailgun API (keys).</li>
                                        </ul>
                                        <p class="api-key-warning mt-3">
                                            <strong>CRITICAL SECURITY NOTE:</strong> Never expose API keys directly in client-side code. Use a backend server or strict restrictions.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-2xl font-semibold text-text-light mb-3">2. Gemini API Integration (Current Progress & Understanding):</h3>
                                <div class="space-y-4 ml-4">
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">What does a Gemini API Key do? (for "Baby Staff"):</h4>
                                        <p class="text-text-light mb-2">Imagine the Gemini AI as a super-smart robot brain that lives far away in a Google data center. This robot brain can do amazing things like talk like a human, understand pictures, summarize long texts, and write code.</p>
                                        <p class="text-text-light mb-2">**Your Gemini API Key is like a special secret VIP pass** that allows your Fruitful Dashboard to "talk" to this super-smart robot brain. It tells Google it's *our* dashboard asking, keeps track of usage, and ensures safe communication.</p>
                                        <p class="text-text-light">**Crucial Point for "Baby Staff":** This API key is a **secret!** Never show it to anyone who shouldn't have access, and never put it directly into code that everyone can see (like the HTML if it's on a public website). It's like your house key ‚Äì keep it safe!</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Key Acquisition:</h4>
                                        <p class="muted-text">API keys are obtained via <a href="https://aistudio.google.com/" target="_blank" class="text-secondary-color hover:underline">Google AI Studio</a>.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Current Dashboard Implementation:</h4>
                                        <p class="muted-text">A new "AI Gemini" section has been added with a general prompt area, plus new specialized "Coding Partner" and "Career Guide" features, all powered by Gemini AI. The API key for Gemini is now explicitly set using the key you provided (`AIzaSyBGSDZATtITv5iIoB3rgKHBpWx9MrufxXE`).</p>
                                        <p class="api-key-warning mt-2">
                                            <strong>ACTION REQUIRED for PRODUCTION:</strong> While the key is now in the code, for any production deployment, move this API call to a secure backend server to protect your key.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-2xl font-semibold text-text-light mb-3">3. Discussion of New API-related Features for Fruitful Dashboard:</h3>
                                <div class="space-y-6 ml-4">
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2"><i class="fas fa-code"></i> Coding Partner Integration:</h4>
                                        <p class="muted-text"><strong>Concept:</strong> Use Gemini AI's code generation and explanation capabilities.</p>
                                        <p class="muted-text"><strong>API(s) to explore:</strong> Gemini API (already integrated).</p>
                                        <p class="muted-text"><strong>Implementation Idea:</strong> Integrated into "AI Gemini" section with dedicated input/output.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2"><i class="fas fa-graduation-cap"></i> Career Guide Integration:</h4>
                                        <p class="muted-text"><strong>Concept:</strong> Leverage AI to provide career advice, resume tips, interview prep, or learning paths.</p>
                                        <p class="muted-text"><strong>API(s) to explore:</strong> Gemini API (primary), potentially specialized career APIs for structured data.</p>
                                        <p class="muted-text"><strong>Implementation Idea:</strong> New "Career Insights" section where users input goals/questions for AI-generated guidance.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2"><i class="fas fa-mobile-alt"></i> "ü¶ä Foxed Has Mobiles‚Ñ¢" - Product Data/Inventory Integration:</h4>
                                        <p class="muted-text"><strong>Concept:</strong> Pull mobile product data (names, specs, prices, stock) from a dedicated system.</p>
                                        <p class="muted-text"><strong>API(s) to explore:</strong> Likely a **custom API** from "Foxed Has Mobiles‚Ñ¢" or a third-party e-commerce platform API (Shopify, WooCommerce).</p>
                                        <p class="muted-text"><strong>Action:</strong> Contact "Foxed Has Mobiles‚Ñ¢" for API documentation and keys.</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2"><i class="fas fa-shield-alt"></i> "üå≥ Baobab Security Network‚Ñ¢" - Security Monitoring:</h4>
                                        <p class="muted-text"><strong>Concept:</strong> Display security alerts, network status, or security logs.</p>
                                        <p class="muted-text"><strong>API(s) to explore:</strong> Likely a **custom API** from "Baobab Security Network‚Ñ¢".</p>
                                        <p class="muted-text"><strong>Action:</strong> Obtain API documentation and credentials from "Baobab Security Network‚Ñ¢".</p>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg border border-dark">
                                        <h4 class="text-xl font-medium secondary-text mb-2"><i class="fas fa-shopping-cart"></i> "üå±Global_Complete_purchase" & "üå±Global_checkout_success" - E-commerce Analytics:</h4>
                                        <p class="muted-text"><strong>Concept:</strong> Track successful purchases and checkout completions.</p>
                                        <p class="muted-text"><strong>API(s) to explore:</strong> Google Analytics Data API, Custom E-commerce Platform API, CRM/ERP APIs.</p>
                                        <p class="muted-text"><strong>Implementation Idea:</strong> New charts/metrics in "Data Analytics" showing conversion rates, successful purchases, checkout funnel performance.</p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-2xl font-semibold text-text-light mb-3">4. Live Demos (for Visual Learners / "Baby Staff"):</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="card-bg p-4 rounded-lg shadow-md border border-dark flex flex-col items-center">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Live Google Map</h4>
                                        <p class="muted-text mb-3">A real-time map, demonstrating location services. (Replace with your actual embed!)</p>
                                        <div class="w-full h-64 bg-gray-800 rounded-lg overflow-hidden flex items-center justify-center">
                                            <iframe src="YOUR_GOOGLE_MAP_EMBED_CODE" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                                            <span class="text-muted-text absolute text-center">**PLACEHOLDER MAP**<br>Get your embed code from Google Maps.</span>
                                        </div>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg shadow-md border border-dark flex flex-col items-center">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Live YouTube Video</h4>
                                        <p class="muted-text mb-3">An embedded video, showing media integration. (Replace with your actual embed!)</p>
                                        <div class="w-full h-64 bg-gray-800 rounded-lg overflow-hidden flex items-center justify-center">
                                            <iframe width="100%" height="100%" src="YOUR_YOUTUBE_EMBED_CODE" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                            <span class="text-muted-text absolute text-center">**PLACEHOLDER VIDEO**<br>Get your embed code from YouTube.</span>
                                        </div>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg shadow-md border border-dark flex flex-col items-center">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Live Spotify Music</h4>
                                        <p class="muted-text mb-3">Interactive Spotify embeds for albums/tracks.</p>
                                        <div class="w-full h-64 bg-gray-800 rounded-lg overflow-hidden flex flex-col items-center justify-center space-y-2 p-2">
                                            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/album/3RyjFxsU9hcmg14vqzUUMy?utm_source=generator" width="90%" height="100" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                                            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/2kdQY3b6dDRGonyIzcWljc?utm_source=generator" width="90%" height="100" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                                            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/6Xe9wT5xeZETPwtaP2ynUz?utm_source=generator" width="90%" height="100" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                                        </div>
                                    </div>
                                    <div class="card-bg p-4 rounded-lg shadow-md border border-dark flex flex-col items-center">
                                        <h4 class="text-xl font-medium secondary-text mb-2">Gemini AI Test (re-iterated)</h4>
                                        <p class="muted-text mb-3">See our core AI integration in action.</p>
                                        <div class="w-full h-64 bg-gray-800 rounded-lg p-4 overflow-auto text-sm text-text-light">
                                            <p>This is where our Gemini AI interacts. You can test it in the "AI Gemini" section!</p>
                                            <p class="mt-2 text-muted-text">Example: Ask the AI "What is the capital of France?"</p>
                                            <p class="mt-2 text-red-400">**Remember to add your actual API Key!**</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-2xl font-semibold text-text-light mb-3">5. Action Items for the Team:</h3>
                                <ul class="list-disc list-inside ml-4 text-text-light space-y-2">
                                    <li>**IMMEDIATE & CRITICAL:** Replace `YOUR_GEMINI_API_KEY` in the JavaScript with your actual key from Google AI Studio.</li>
                                    <li>**SECURITY:** Begin planning for secure backend proxying of all API calls for production deployment.</li>
                                    <li>**API ACQUISITION:** Contact "Foxed Has Mobiles‚Ñ¢" and "Baobab Security Network‚Ñ¢" for their API documentation and access credentials.</li>
                                    <li>**ANALYTICS:** Investigate Google Analytics Data API or e-commerce platform APIs for detailed purchase/checkout event tracking.</li>
                                    <li>**UI/UX:** Brainstorm and design user interfaces for "Coding Partner" and "Career Guide" functionalities.</li>
                                    <li>**EMBED CODES:** Generate actual embed codes for the live demos (Google Maps, YouTube, Spotify) to make this section truly "live" for the team.</li>
                                    <li>**CONTINUOUS LEARNING:** Encourage "baby staff" to review API documentation for any integrated service to understand capabilities and limitations.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- Add New Tag Modal -->
    <div id="addTagModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="card-bg p-8 w-full max-w-2xl relative">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="closeModal('addTagModal')">&times;</button>
            <h3 class="text-2xl font-bold mb-6 at-gradient-heading">Tag New Ancestral Content</h3>
            <form id="ancestorTagForm" class="space-y-4">
                <div>
                    <label for="ancestorName" class="block text-sm font-medium text-gray-300">Ancestor's Name</label>
                    <input type="text" id="ancestorName" class="w-full p-2 rounded input-field" placeholder="e.g., Elder Kaelen, Seer Lyra" required>
                </div>
                <div>
                    <label for="contentTitle" class="block text-sm font-medium text-gray-300">Content Title</label>
                    <input type="text" id="contentTitle" class="w-full p-2 rounded input-field" placeholder="e.g., The Ritual of Celestial Alignment" required>
                </div>
                <div>
                    <label for="contentType" class="block text-sm font-medium text-gray-300">Content Type</label>
                    <select id="contentType" class="w-full p-2 rounded input-field" required>
                        <option value="">Select Type</option>
                        <option value="Document">Document</option>
                        <option value="Oral History">Oral History</option>
                        <option value="Ritual Description">Ritual Description</option>
                        <option value="Artifact">Artifact</option>
                        <option value="Visual Record">Visual Record</option>
                    </select>
                </div>
                <div>
                    <label for="contentDescription" class="block text-sm font-medium text-gray-300">Description</label>
                    <textarea id="contentDescription" class="w-full p-2 rounded input-field h-24" placeholder="Briefly describe the content and its significance..."></textarea>
                </div>
                <div>
                    <label for="digitalLink" class="block text-sm font-medium text-gray-300">Digital Link (Simulated)</label>
                    <input type="url" id="digitalLink" class="w-full p-2 rounded input-field" placeholder="e.g., https://vault.faa.zone/rituals/celestial_alignment_v1.html">
                </div>
                <div>
                    <label for="tags" class="block text-sm font-medium text-gray-300">Tags (comma-separated)</label>
                    <input type="text" id="tags" class="w-full p-2 rounded input-field" placeholder="e.g., ancient, prophecy, cosmic, ceremony">
                </div>
                <button type="submit" class="at-btn-primary w-full py-3 rounded text-lg">
                    Submit AncestorTag
                </button>
            </form>
        </div>
    </div>

    <!-- Provenance Details Modal -->
    <div id="provenanceModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="card-bg p-8 w-full max-w-3xl relative">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="closeModal('provenanceModal')">&times;</button>
            <h3 class="text-2xl font-bold mb-6 at-gradient-heading">Provenance Chain & Digital Integrity</h3>
            <div id="provenanceContent" class="space-y-4 text-gray-300">
                <!-- Provenance details will be dynamically injected here -->
            </div>
            <div class="mt-6">
                <button id="copyProvenanceHashBtn" class="at-btn-secondary px-4 py-2 rounded text-sm mr-2">Copy Provenance Hash</button>
                <button id="toggleAccessBtn" class="at-btn-secondary px-4 py-2 rounded text-sm">Toggle Secure Access (Simulated)</button>
            </div>
        </div>
    </div>

    <footer class="header-bg text-center py-8 mt-12 border-t border-dark">
        <div class="container mx-auto px-6">
            <p class="text-sm">¬© 2025 AncestorTag‚Ñ¢ Heritage Portal. All rights reserved.</p>
            <p class="text-xs opacity-70 mt-2">Powered by FAA.ZONE‚Ñ¢ ScrollGrid ¬∑ PulseTrade Certified ¬∑ TreatyMesh Validated</p>
            <p id="userIdDisplay" class="text-xs text-muted-text mt-2">User ID: Loading...</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous

        // Global state for map loading
        let googleMapScriptLoaded = false;
        let leafletMapInstance = null; // Store Leaflet map instance
        let familyMapInstance = null; // Store Family Map Leaflet instance
        let activeMusicSubSection = 'allMusic'; // Default active music sub-section

        // Initialize Firebase and set up auth listener
        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                        console.log("Firebase Auth: Signed in as", userId);
                        setupFirestoreListeners(); // Start listening to data once authenticated
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                console.log("Firebase Auth: Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Firebase Auth: Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            document.getElementById('userIdDisplay').textContent = `User ID: Auth Error!`;
                            // If anonymous sign-in or custom token fails, proceed without listener
                            // or show an error state
                        }
                    }
                });
            } else {
                console.warn("Firebase config not found. Running in demo mode without persistence.");
                document.getElementById('userIdDisplay').textContent = `User ID: Offline Demo`;
                setupOfflineDemoMode();
            }

            // Attach event listeners for navigation links
            document.getElementById('nav-ancestor-tag-section').addEventListener('click', () => showSection('ancestor-tag-section'));
            document.getElementById('nav-family-hub').addEventListener('click', () => showSection('family-hub'));
            document.getElementById('nav-travel-commerce').addEventListener('click', () => showSection('travel-commerce'));
            document.getElementById('nav-productivity').addEventListener('click', () => showSection('productivity'));
            document.getElementById('nav-utilities').addEventListener('click', () => showSection('utilities'));
            document.getElementById('nav-profile').addEventListener('click', () => showSection('profile')); // New listener
            document.getElementById('nav-graphs').addEventListener('click', () => showSection('graphs'));

            // Nested Family Hub navigation
            document.getElementById('nav-family-tree').addEventListener('click', () => showSection('family-tree'));
            document.getElementById('nav-financial-hub')?.addEventListener('click', () => showSection('financial-hub')); // Added ? for optional chaining in case it's not present for some reason
            document.getElementById('nav-gift-lists')?.addEventListener('click', () => showSection('gift-lists')); // Added ?
            document.getElementById('nav-family-calendar').addEventListener('click', () => showSection('family-calendar'));

            document.getElementById('nav-overview').addEventListener('click', () => showSection('overview'));
            document.getElementById('nav-analytics').addEventListener('click', () => showSection('analytics'));
            document.getElementById('nav-admin-panel').addEventListener('click', () => showSection('admin-panel'));
            document.getElementById('nav-music').addEventListener('click', () => showSection('music'));
            document.getElementById('nav-ai-gemini').addEventListener('click', () => showSection('ai-gemini'));
            document.getElementById('nav-maps').addEventListener('click', () => showSection('maps'));
            document.getElementById('nav-meeting-minutes').addEventListener('click', () => showSection('meeting-minutes'));
            document.getElementById('nav-settings').addEventListener('click', () => showSection('settings'));

            // Attach event listeners for music sub-sidebar links
            document.getElementById('music-sub-allMusic').addEventListener('click', () => showMusicSubSection('allMusic'));
            document.getElementById('music-sub-musicPlaylists').addEventListener('click', () => showMusicSubSection('musicPlaylists'));
            document.getElementById('music-sub-artists').addEventListener('click', () => showMusicSubSection('artists'));

            // Set default active section on page load
            showSection('ancestor-tag-section'); // Show AncestorTag section by default

            // Initialize productivity and utilities features from localStorage
            loadNotes();
            renderTodos();
            initUnitConverterSelectors();

            // Initialize financial fund balances
            loadFunds();
        });

        // Combined Firestore Listeners Setup
        function setupFirestoreListeners() {
            setupAncestorTagListener();
            setupFamilyMembersListener();
            setupFamilyEventsListener(); // New listener for calendar events
            // In a full app, you'd also have listeners for financial data, gift lists etc.
        }

        // Mock data for offline demo mode
        let offlineRecords = []; // For AncestorTag
        let offlineFamilyMembers = []; // For Family Tree
        let offlineFamilyEvents = []; // For Family Calendar
        let offlineNotes = ""; // For Notes
        let offlineTodos = []; // For To-Do List
        let offlineChristmasList = []; // For Christmas List
        let offlineBirthdayList = []; // For Birthday List
        let offlineFunds = {
            familySavingFund: 0,
            personalSavingFund: 0,
            emergencyFund: 0
        };

        function setupOfflineDemoMode() {
            // Load from localStorage if available, otherwise start fresh
            offlineRecords = JSON.parse(localStorage.getItem('ancestorTagOfflineData')) || [];
            offlineFamilyMembers = JSON.parse(localStorage.getItem('familyMembersOfflineData')) || [];
            offlineFamilyEvents = JSON.parse(localStorage.getItem('familyEventsOfflineData')) || [];
            offlineNotes = localStorage.getItem('personalNotesData') || "";
            offlineTodos = JSON.parse(localStorage.getItem('todoListData')) || [];
            offlineChristmasList = JSON.parse(localStorage.getItem('christmasListData')) || [];
            offlineBirthdayList = JSON.parse(localStorage.getItem('birthdayListData')) || [];
            offlineFunds = JSON.parse(localStorage.getItem('financialFundsData')) || { familySavingFund: 0, personalSavingFund: 0, emergencyFund: 0 };


            renderAncestralRecords(offlineRecords);
            renderFamilyMembers(offlineFamilyMembers);
            renderUpcomingEvents(offlineFamilyEvents);
            loadNotes(); // Load notes into textarea
            renderTodos(); // Render todos
            renderGiftList('christmas', offlineChristmasList);
            renderGiftList('birthday', offlineBirthdayList);
            loadFunds(); // Load funds into display
            updateAllCharts(); // Update charts with offline data

            document.getElementById('ancestorTagForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newRecord = collectFormData();
                if (newRecord) {
                    offlineRecords.push({ ...newRecord, id: `offline-${Date.now()}`, timestamp: new Date() });
                    localStorage.setItem('ancestorTagOfflineData', JSON.stringify(offlineRecords));
                    renderAncestralRecords(offlineRecords);
                    closeModal('addTagModal');
                    showMessage("AncestorTag added (Offline Mode)!", "success");
                    updateAllCharts();
                }
            });

            document.getElementById('addFamilyMemberForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newMember = collectFamilyMemberData();
                if (newMember) {
                    offlineFamilyMembers.push({ ...newMember, id: `offline-member-${Date.now()}` });
                    localStorage.setItem('familyMembersOfflineData', JSON.stringify(offlineFamilyMembers));
                    renderFamilyMembers(offlineFamilyMembers);
                    showMessage("Family member added (Offline Mode)!", "success");
                    e.target.reset();
                    updateAllCharts();
                    initFamilyMap(offlineFamilyMembers); // Update map
                }
            });

            document.getElementById('addEventForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newEvent = collectEventData();
                if (newEvent) {
                    offlineFamilyEvents.push({ ...newEvent, id: `offline-event-${Date.now()}` });
                    localStorage.setItem('familyEventsOfflineData', JSON.stringify(offlineFamilyEvents));
                    renderUpcomingEvents(offlineFamilyEvents);
                    showMessage("Event added (Offline Mode)!", "success");
                    e.target.reset();
                    updateAllCharts();
                }
            });

            document.getElementById('saveNotesBtn').addEventListener('click', () => {
                offlineNotes = document.getElementById('personalNotes').value;
                localStorage.setItem('personalNotesData', offlineNotes);
                showMessage("Notes saved (Offline Mode)!", "success");
            });

            document.getElementById('todoForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const todoInput = document.getElementById('todoInput');
                const taskText = todoInput.value.trim();
                if (taskText) {
                    offlineTodos.push({ id: `todo-${Date.now()}`, text: taskText, completed: false });
                    localStorage.setItem('todoListData', JSON.stringify(offlineTodos));
                    renderTodos();
                    todoInput.value = '';
                    showMessage("Task added (Offline Mode)!", "success");
                }
            });

            document.getElementById('christmasListForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const itemInput = document.getElementById('christmasItemInput');
                const itemText = itemInput.value.trim();
                if (itemText) {
                    offlineChristmasList.push({ id: `xmas-${Date.now()}`, text: itemText });
                    localStorage.setItem('christmasListData', JSON.stringify(offlineChristmasList));
                    renderGiftList('christmas', offlineChristmasList);
                    itemInput.value = '';
                    showMessage("Christmas gift idea added (Offline Mode)!", "success");
                }
            });

            document.getElementById('birthdayListForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const itemInput = document.getElementById('birthdayItemInput');
                const itemText = itemInput.value.trim();
                if (itemText) {
                    offlineBirthdayList.push({ id: `bday-${Date.now()}`, text: itemText });
                    localStorage.setItem('birthdayListData', JSON.stringify(offlineBirthdayList));
                    renderGiftList('birthday', offlineBirthdayList);
                    itemInput.value = '';
                    showMessage("Birthday gift idea added (Offline Mode)!", "success");
                }
            });
        }


        // --- Firestore Listener Setup for AncestorTag ---
        function setupAncestorTagListener() {
            if (!db || !userId || userId === 'anonymous') {
                console.warn("Firestore or User ID not ready for AncestorTag listener.");
                return;
            }

            const q = collection(db, `artifacts/${appId}/users/${userId}/ancestorTags`);
            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                renderAncestralRecords(records);
                updateAllCharts();
            }, (error) => {
                console.error("Error listening to AncestorTag Firestore:", error);
                document.getElementById('ancestralRecordsList').innerHTML = `<p class="text-red-400 text-center">Error loading records: ${error.message}</p>`;
            });
        }

        // --- Firestore Listener Setup for Family Members ---
        let familyMembers = []; // Store fetched family members
        function setupFamilyMembersListener() {
            if (!db || !userId || userId === 'anonymous') {
                console.warn("Firestore or User ID not ready for Family Members listener.");
                return;
            }

            const q = collection(db, `artifacts/${appId}/users/${userId}/familyMembers`);
            onSnapshot(q, (snapshot) => {
                familyMembers = []; // Clear previous data
                snapshot.forEach((doc) => {
                    familyMembers.push({ id: doc.id, ...doc.data() });
                });
                renderFamilyMembers(familyMembers);
                updateAllCharts();
                initFamilyMap(familyMembers); // Update map with new family member locations
            }, (error) => {
                console.error("Error listening to Family Members Firestore:", error);
                document.getElementById('familyMembersList').innerHTML = `<p class="text-red-400 text-center">Error loading family members: ${error.message}</p>`;
            });
        }

        // --- Firestore Listener Setup for Family Events ---
        let familyEvents = []; // Store fetched family events
        function setupFamilyEventsListener() {
            if (!db || !userId || userId === 'anonymous') {
                console.warn("Firestore or User ID not ready for Family Events listener.");
                return;
            }

            const q = collection(db, `artifacts/${appId}/users/${userId}/familyEvents`);
            onSnapshot(q, (snapshot) => {
                familyEvents = []; // Clear previous data
                snapshot.forEach((doc) => {
                    familyEvents.push({ id: doc.id, ...doc.data() });
                });
                renderUpcomingEvents(familyEvents);
                updateAllCharts();
            }, (error) => {
                console.error("Error listening to Family Events Firestore:", error);
                document.getElementById('upcomingEventsList').innerHTML = `<p class="text-red-400 text-center">Error loading events: ${error.message}</p>`;
            });
        }


        // --- AncestorTag Form Submission Handler (remains largely same) ---
        document.getElementById('ancestorTagForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || userId === 'anonymous') { return; } // Handled by offline mode

            const newRecord = collectFormData();
            if (newRecord) {
                try {
                    const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/ancestorTags`);
                    await addDoc(collectionRef, { ...newRecord, timestamp: new Date(), userId: userId });
                    closeModal('addTagModal');
                    showMessage("AncestorTag submitted successfully!", "success");
                } catch (error) {
                    console.error("Error adding document to Firestore:", error);
                    showMessage(`Failed to submit: ${error.message}`, "error");
                }
            }
        });

        function collectFormData() {
            const ancestorName = document.getElementById('ancestorName').value.trim();
            const contentTitle = document.getElementById('contentTitle').value.trim();
            const contentType = document.getElementById('contentType').value;
            const contentDescription = document.getElementById('contentDescription').value.trim();
            const digitalLink = document.getElementById('digitalLink').value.trim();
            const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(Boolean);

            if (!ancestorName || !contentTitle || !contentType) {
                showMessage("Ancestor's Name, Content Title, and Type are required!", "warning");
                return null;
            }

            const provenanceHash = `0x${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}`;
            return { ancestorName, contentTitle, contentType, contentDescription, digitalLink, tags, provenanceHash };
        }

        // --- Render Ancestral Records to Dashboard (remains largely same) ---
        let allRecords = [];
        function renderAncestralRecords(records) {
            allRecords = records;
            filterAncestralRecords();
        }

        function filterAncestralRecords() {
            const ancestorFilter = document.getElementById('filterAncestor').value.toLowerCase();
            const contentTypeFilter = document.getElementById('filterContentType').value;

            const filteredRecords = allRecords.filter(record => {
                const matchesAncestor = ancestorFilter === '' || record.ancestorName.toLowerCase().includes(ancestorFilter);
                const matchesContentType = contentTypeFilter === '' || record.contentType === contentTypeFilter;
                return matchesAncestor && matchesContentType;
            });

            const listContainer = document.getElementById('ancestralRecordsList');
            listContainer.innerHTML = '';

            if (filteredRecords.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-400 text-center py-8">${ancestorFilter || contentTypeFilter ? 'No records match your filters.' : 'No records found. Click "‚ûï Tag New Ancestral Content" to add your first!'}</p>`;
                updateDashboardMetrics([]);
                return;
            }

            filteredRecords.sort((a, b) => {
                const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB - dateA;
            });

            filteredRecords.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'card-bg p-6 space-y-3';
                recordElement.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-2">
                        <h4 class="text-xl font-bold text-white">${record.contentTitle}</h4>
                        <span class="at-badge text-sm">${record.contentType}</span>
                    </div>
                    <p class="text-gray-300"><strong>Ancestor:</strong> ${record.ancestorName}</p>
                    <p class="text-gray-400 text-sm leading-relaxed">${record.contentDescription || 'No description provided.'}</p>
                    <div class="flex flex-wrap gap-2 mt-3">
                        ${record.tags.map(tag => `<span class="at-badge bg-purple-900">${tag}</span>`).join('')}
                    </div>
                    <div class="flex justify-end pt-4 border-t border-gray-700 mt-4">
                        <button class="at-btn-secondary px-4 py-2 rounded text-sm" onclick="showProvenance('${record.id}', '${record.ancestorName}', '${record.contentTitle}', '${record.provenanceHash}', '${record.timestamp?.toDate().toLocaleString() || new Date(record.timestamp).toLocaleString()}')">
                            View Provenance
                        </button>
                    </div>
                `;
                listContainer.appendChild(recordElement);
            });
            updateDashboardMetrics(filteredRecords);
        }

        function clearFilters() {
            document.getElementById('filterAncestor').value = '';
            document.getElementById('filterContentType').value = '';
            filterAncestralRecords();
        }

        function updateDashboardMetrics(records) {
            document.getElementById('totalTagsCount').textContent = records.length;
            const uniqueAncestors = new Set(records.map(record => record.ancestorName));
            document.getElementById('uniqueAncestorsCount').textContent = uniqueAncestors.size;
            document.getElementById('docCount').textContent = records.filter(r => r.contentType === 'Document').length;
            document.getElementById('oralCount').textContent = records.filter(r => r.contentType === 'Oral History').length;
            document.getElementById('ritualCount').textContent = records.filter(r => r.contentType === 'Ritual Description').length;
        }

        let currentProvenanceHash = '';
        function showProvenance(recordId, ancestorName, contentTitle, provenanceHash, timestamp) {
            currentProvenanceHash = provenanceHash;
            const provenanceContent = document.getElementById('provenanceContent');
            const toggleAccessBtn = document.getElementById('toggleAccessBtn');

            provenanceContent.innerHTML = `
                <p class="text-lg text-white"><strong>Content:</strong> ${contentTitle}</p>
                <p class="text-lg text-white"><strong>Ancestor:</strong> ${ancestorName}</p>
                <p class="text-gray-400 text-sm"><strong>Tagged On:</strong> ${timestamp}</p>
                <div class="mt-4 space-y-3">
                    <div class="at-provenance-step">
                        <p class="font-semibold text-white">Original Content Creation <i class="fas fa-feather-alt text-base ml-2"></i></p>
                        <p class="text-xs text-gray-400">Time-stamped and recorded by AncestorTag Protocol.</p>
                    </div>
                    <div class="at-provenance-step">
                        <p class="font-semibold text-white">Digital Fingerprint Generated <i class="fas fa-fingerprint text-base ml-2"></i></p>
                        <p class="text-xs text-gray-400">Unique cryptographic hash created:</p>
                        <code class="block text-purple-400 break-all text-sm mt-1">${provenanceHash}</code>
                    </div>
                    <div class="at-provenance-step">
                        <p class="font-semibold text-white">Immutable Link to FAA VaultMesh <i class="fas fa-link text-base ml-2"></i></p>
                        <p class="text-xs text-gray-400">Secured on distributed ledger for verifiable provenance.</p>
                    </div>
                    <div class="at-provenance-step">
                        <p class="font-semibold text-white">Access Protocol Activated <i class="fas fa-shield-alt text-base ml-2"></i></p>
                        <p class="text-xs text-gray-400">Granular permissions configured for ethical sharing and control.</p>
                    </div>
                </div>
                <div id="simulatedAccessMessage" class="mt-4 p-3 bg-purple-900 rounded text-sm text-center">
                    <p class="text-green-400">Current Access: Public (Simulated)</p>
                </div>
            `;

            toggleAccessBtn.onclick = () => toggleSecureAccess(recordId);
            document.getElementById('copyProvenanceHashBtn').onclick = copyProvenanceHash;
            openModal('provenanceModal');
        }

        function toggleSecureAccess(recordId) {
            const accessMessage = document.getElementById('simulatedAccessMessage');
            if (accessMessage.textContent.includes('Public')) {
                accessMessage.innerHTML = `<p class="text-red-400">Current Access: Restricted (Simulated)</p>`;
            } else {
                accessMessage.innerHTML = `<p class="text-green-400">Current Access: Public (Simulated)</p>`;
            }
            showMessage("Access permission toggled (simulated).", "info");
        }

        function copyProvenanceHash() {
            if (currentProvenanceHash) {
                document.execCommand('copy'); // Use this for clipboard access in iframes
                showMessage("Provenance Hash copied to clipboard!", "success");
            }
        }


        // --- Modal Control Functions ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'addTagModal') {
                document.getElementById('ancestorTagForm').reset();
            }
        }

        // --- Message Display Function (instead of alert) ---
        let messageTimeout;
        function showMessage(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg text-white text-center z-50`;
            
            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-600');
            } else { // info
                messageBox.classList.add('bg-blue-600');
            }
            messageBox.textContent = message;

            document.body.appendChild(messageBox);

            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBox.remove();
            }, 3000);
        }

        // --- Family Tree Functions ---
        document.getElementById('addFamilyMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || userId === 'anonymous') { return; } // Handled by offline mode

            const newMember = collectFamilyMemberData();
            if (newMember) {
                try {
                    const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/familyMembers`);
                    await addDoc(collectionRef, { ...newMember, timestamp: new Date(), userId: userId });
                    showMessage("Family member added successfully!", "success");
                    e.target.reset();
                } catch (error) {
                    console.error("Error adding family member to Firestore:", error);
                    showMessage(`Failed to add member: ${error.message}`, "error");
                }
            }
        });

        function collectFamilyMemberData() {
            const memberName = document.getElementById('memberName').value.trim();
            const memberRelationship = document.getElementById('memberRelationship').value.trim();
            const memberDOB = document.getElementById('memberDOB').value;
            const memberCurrentLocation = document.getElementById('memberCurrentLocation').value.trim();

            if (!memberName || !memberRelationship) {
                showMessage("Member Name and Relationship are required!", "warning");
                return null;
            }
            return { memberName, memberRelationship, memberDOB, memberCurrentLocation };
        }

        function renderFamilyMembers(members) {
            const listContainer = document.getElementById('familyMembersList');
            listContainer.innerHTML = '';
            if (members.length === 0) {
                listContainer.innerHTML = `<p class="text-muted-text text-center">Add family members to see them here.</p>`;
                return;
            }

            members.sort((a,b) => a.memberName.localeCompare(b.memberName)); // Sort alphabetically

            members.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'family-member-card text-text-light';
                memberCard.innerHTML = `
                    <p class="text-lg font-bold primary-text mb-2">${member.memberName}</p>
                    <div class="family-member-details">
                        <span><strong>Relationship:</strong> ${member.memberRelationship}</span>
                        ${member.memberDOB ? `<span><strong>DOB:</strong> ${member.memberDOB}</span>` : ''}
                        ${member.memberCurrentLocation ? `<span><strong>Location:</strong> ${member.memberCurrentLocation}</span>` : ''}
                    </div>
                `;
                listContainer.appendChild(memberCard);
            });
        }

        // --- Family Map (Leaflet) ---
        function initFamilyMap(members) {
            const mapContainer = document.getElementById("family-map-container");
            if (!mapContainer) return;

            if (familyMapInstance) {
                familyMapInstance.remove(); // Destroy existing map instance
                familyMapInstance = null;
            }

            familyMapInstance = L.map(mapContainer).setView([0, 0], 2); // Center of the world, low zoom

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(familyMapInstance);

            // Add markers for family members based on their location
            // This is a simplified geo-coding. A real app would use a geo-coding API.
            const geoLocs = {
                "london, uk": [51.505, -0.09], "paris, france": [48.8566, 2.3522],
                "new york, usa": [40.7128, -74.0060], "tokyo, japan": [35.6762, 139.6503],
                "johannesburg, south africa": [-26.2041, 28.0473], "sydney, australia": [-33.8688, 151.2093]
            };

            members.forEach(member => {
                if (member.memberCurrentLocation) {
                    const loc = member.memberCurrentLocation.toLowerCase();
                    let latLng = geoLocs[loc];

                    if (!latLng) {
                        // Fallback to a random point if location not in mock data
                        latLng = [Math.random() * 180 - 90, Math.random() * 360 - 180];
                        console.warn(`No specific lat/lng for ${member.memberCurrentLocation}. Using random.`);
                    }
                    L.marker(latLng).addTo(familyMapInstance)
                        .bindPopup(`<b>${member.memberName}</b><br>${member.memberCurrentLocation}`);
                }
            });

            // Adjust map view to fit all markers if any exist
            if (members.length > 0) {
                // Collect all markers currently on the map
                const currentMarkers = [];
                familyMapInstance.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        currentMarkers.push(layer);
                    }
                });
                const bounds = new L.featureGroup(currentMarkers).getBounds(); 
                if (bounds.isValid()) {
                    familyMapInstance.fitBounds(bounds.pad(0.5)); // Zoom to markers with some padding
                }
            }
        }


        // --- Travel Hub Functions ---
        function simulateBooking(event, serviceType) {
            event.preventDefault();
            showMessage(`Booking ${serviceType} via Fruitful (simulated)...`, "info");
            setTimeout(() => {
                const success = Math.random() > 0.3; // 70% success rate
                if (success) {
                    showMessage(`${serviceType} booked successfully via Fruitful! Your itinerary is confirmed.`, "success");
                } else {
                    showMessage(`Failed to book ${serviceType}. Please try again later or contact Fruitful support.`, "error");
                }
                event.target.reset(); // Clear form fields
            }, 1500);
        }

        // --- Family Calendar Functions ---
        document.getElementById('addEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || userId === 'anonymous') { return; } // Handled by offline mode

            const newEvent = collectEventData();
            if (newEvent) {
                try {
                    const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/familyEvents`);
                    await addDoc(collectionRef, { ...newEvent, timestamp: new Date(), userId: userId });
                    showMessage("Event added successfully!", "success");
                    e.target.reset();
                } catch (error) {
                    console.error("Error adding event to Firestore:", error);
                    showMessage(`Failed to add event: ${error.message}`, "error");
                }
            }
        });

        function collectEventData() {
            const eventName = document.getElementById('eventName').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const eventTime = document.getElementById('eventTime').value;
            const eventDescription = document.getElementById('eventDescription').value.trim();

            if (!eventName || !eventDate) {
                showMessage("Event Name and Date are required!", "warning");
                return null;
            }
            return { eventName, eventDate, eventTime, eventDescription };
        }

        function renderUpcomingEvents(events) {
            const listContainer = document.getElementById('upcomingEventsList');
            listContainer.innerHTML = '';
            const now = new Date();

            const upcoming = events.filter(event => {
                const eventDateTime = new Date(`${event.eventDate}T${event.eventTime || '00:00'}`);
                return eventDateTime >= now;
            }).sort((a, b) => {
                const dateA = new Date(`${a.eventDate}T${a.eventTime || '00:00'}`);
                const dateB = new Date(`${b.eventDate}T${b.eventTime || '00:00'}`);
                return dateA - dateB;
            });

            if (upcoming.length === 0) {
                listContainer.innerHTML = `<p class="text-muted-text text-center">No upcoming events. Add some above!</p>`;
                return;
            }

            upcoming.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'card-bg p-3 rounded-lg text-text-light';
                eventItem.innerHTML = `
                    <p class="font-bold primary-text">${event.eventName}</p>
                    <p class="text-sm text-muted-text">
                        ${event.eventDate}${event.eventTime ? ` at ${event.eventTime}` : ''}
                    </p>
                    ${event.eventDescription ? `<p class="text-xs mt-1">${event.eventDescription}</p>` : ''}
                `;
                listContainer.appendChild(eventItem);
            });
        }


        // --- Graphs Functions (using Chart.js) ---
        let contentTypeChartInstance;
        let familyLocationChartInstance;

        function updateAllCharts() {
            updateContentTypeChart();
            updateFamilyLocationChart();
            // Other chart updates can go here
        }

        function updateContentTypeChart() {
            const ctx = document.getElementById('contentTypeChart')?.getContext('2d');
            if (!ctx) return; // Ensure canvas exists

            const counts = {};
            allRecords.forEach(record => {
                counts[record.contentType] = (counts[record.contentType] || 0) + 1;
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);
            const colors = ['#22c55e', '#3b82f6', '#ef4444', '#f59e0b', '#10b981']; // Tailwind greens, blues, reds, etc.

            if (contentTypeChartInstance) {
                contentTypeChartInstance.destroy();
            }

            contentTypeChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--text-light)'
                            }
                        },
                        title: {
                            display: false,
                            text: 'Content Type Distribution',
                            color: 'var(--text-light)'
                        }
                    }
                }
            });
        }

        function updateFamilyLocationChart() {
            const ctx = document.getElementById('familyLocationChart')?.getContext('2d');
            if (!ctx) return; // Ensure canvas exists
            
            const locationCounts = {};
            familyMembers.forEach(member => {
                if (member.memberCurrentLocation) {
                    const location = member.memberCurrentLocation.split(',')[1]?.trim() || member.memberCurrentLocation.trim(); // Use country
                    locationCounts[location] = (locationCounts[location] || 0) + 1;
                }
            });

            const labels = Object.keys(locationCounts);
            const data = Object.values(locationCounts);
            const colors = ['#3b82f6', '#a78bfa', '#22c55e', '#f59e0b', '#ef4444', '#10b981']; // Tailwind colors

            if (familyLocationChartInstance) {
                familyLocationChartInstance.destroy();
            }

            familyLocationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Family Members',
                        data: data,
                        backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                        borderColor: labels.map((_, i) => colors[i % colors.length]),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'Family Members by Location',
                            color: 'var(--text-light)'
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'var(--text-muted)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'var(--text-muted)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }


        // This function initializes the Leaflet map (for general "Maps" section)
        function initLeafletMap() {
            const mapContainer = document.getElementById("leaflet-map-container");
            if (!mapContainer || leafletMapInstance) return; // Prevent re-initialization

            leafletMapInstance = L.map(mapContainer).setView([51.505, -0.09], 13); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(leafletMapInstance);

            const marker = L.marker([51.5, -0.09]).addTo(leafletMapInstance);
            marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();
        }

        function showSection(sectionId) {
            document.querySelectorAll('main section').forEach(section => {
                section.classList.add('hidden');
            });

            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
            }

            document.querySelectorAll('.sidebar-nav-item').forEach(link => {
                link.classList.remove('active-nav-item');
                link.classList.add('text-text-light', 'hover:bg-hover-bg-light');
            });
            const clickedLink = document.getElementById(`nav-${sectionId}`);
            if (clickedLink) {
                clickedLink.classList.add('active-nav-item');
                clickedLink.classList.remove('text-text-light', 'hover:bg-hover-bg-light');
            }

            const musicSubSidebar = document.getElementById('musicSubSidebar');
            if (sectionId === 'music') {
                musicSubSidebar.classList.remove('hidden');
                musicSubSidebar.classList.add('flex');
                showMusicSubSection(activeMusicSubSection);
            } else {
                musicSubSidebar.classList.add('hidden');
                musicSubSidebar.classList.remove('flex');
            }

            // Special handling for maps section to load Google Maps script and initialize Leaflet
            if (sectionId === 'maps') {
                if (!googleMapScriptLoaded && document.getElementById('google-maps-api-script') === null) {
                    const script = document.createElement('script');
                    script.id = 'google-maps-api-script';
                    script.async = true;
                    script.defer = true;
                    script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBPG8dG29cl0TvYRGyLozejGed5Wj5Ab80&callback=console.debug&libraries=maps,marker&v=beta";
                    document.body.appendChild(script);
                    googleMapScriptLoaded = true;
                }
                initLeafletMap();
            } else if (sectionId === 'family-tree') {
                // Ensure family map is initialized/updated when family tree section is active
                 if (db && userId !== 'anonymous') { // If online, data is already fetched by listener
                     initFamilyMap(familyMembers);
                 } else { // Offline mode
                    initFamilyMap(offlineFamilyMembers);
                 }
            } else if (sectionId === 'graphs') {
                updateAllCharts();
            }
        }

        function showMusicSubSection(subSectionId) {
            activeMusicSubSection = subSectionId;

            document.querySelectorAll('#music > div').forEach(subSection => {
                subSection.classList.add('hidden');
            });

            const activeSubSectionContent = document.getElementById(subSectionId + 'Content');
            if (activeSubSectionContent) {
                activeSubSectionContent.classList.remove('hidden');
            }

            document.querySelectorAll('#musicSubSidebar .sidebar-nav-item').forEach(link => {
                link.classList.remove('active-nav-item');
                link.classList.add('text-text-light', 'hover:bg-hover-bg-light');
            });
            const clickedSubLink = document.getElementById(`music-sub-${subSectionId}`);
            if (clickedSubLink) {
                clickedSubLink.classList.add('active-nav-item');
                clickedSubLink.classList.remove('text-text-light', 'hover:bg-hover-bg-light');
            }
        }

        // --- Productivity Features (Notes & To-Do List) ---

        // Notes
        function loadNotes() {
            const notesTextarea = document.getElementById('personalNotes');
            if (notesTextarea) {
                if (db && userId !== 'anonymous') {
                    // In a real Firestore implementation, you would fetch the note from a document
                    // For this demo, we'll continue using localStorage as a simplified mock
                    notesTextarea.value = localStorage.getItem('personalNotesData') || "";
                } else {
                    notesTextarea.value = localStorage.getItem('personalNotesData') || "";
                }
            }
        }

        document.getElementById('saveNotesBtn').addEventListener('click', () => {
            const notesTextarea = document.getElementById('personalNotes');
            const notesStatus = document.getElementById('notesStatus');
            if (notesTextarea) {
                const noteContent = notesTextarea.value;
                if (db && userId !== 'anonymous') {
                    // In a real Firestore implementation, you'd save the note to a document
                    // e.g., setDoc(doc(db, `artifacts/${appId}/users/${userId}/notes/myNote`), { content: noteContent });
                    localStorage.setItem('personalNotesData', noteContent); // Fallback for demo
                    showMessage("Notes saved to Cloud (Simulated)!", "success");
                } else {
                    localStorage.setItem('personalNotesData', noteContent);
                    showMessage("Notes saved (Offline Mode)!", "success");
                }
                notesStatus.textContent = "Last saved: " + new Date().toLocaleTimeString();
            }
        });

        // To-Do List
        function renderTodos() {
            const todoListContainer = document.getElementById('todoList');
            todoListContainer.innerHTML = '';
            const todos = (db && userId !== 'anonymous') ? offlineTodos : offlineTodos; // Use offlineTodos for demo simplicity

            if (todos.length === 0) {
                todoListContainer.innerHTML = `<p class="text-muted-text text-center">No tasks yet. Add one above!</p>`;
                return;
            }

            todos.forEach(task => {
                const todoItem = document.createElement('div');
                todoItem.className = `todo-item ${task.completed ? 'completed' : ''}`;
                todoItem.innerHTML = `
                    <input type="checkbox" class="mr-3" ${task.completed ? 'checked' : ''} onchange="toggleTodoCompletion('${task.id}')">
                    <span class="flex-grow">${task.text}</span>
                    <button class="text-red-400 hover:text-red-500 ml-3" onclick="deleteTodo('${task.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                todoListContainer.appendChild(todoItem);
            });
        }

        document.getElementById('todoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const todoInput = document.getElementById('todoInput');
            const taskText = todoInput.value.trim();
            if (taskText) {
                if (db && userId !== 'anonymous') {
                    // In real Firestore, you'd addDoc to a 'todos' collection
                    offlineTodos.push({ id: `todo-${Date.now()}`, text: taskText, completed: false }); // Demo fallback
                    localStorage.setItem('todoListData', JSON.stringify(offlineTodos));
                    renderTodos();
                    showMessage("Task added to Cloud (Simulated)!", "success");
                } else {
                    offlineTodos.push({ id: `todo-${Date.now()}`, text: taskText, completed: false });
                    localStorage.setItem('todoListData', JSON.stringify(offlineTodos));
                    renderTodos();
                    showMessage("Task added (Offline Mode)!", "success");
                }
                todoInput.value = '';
            }
        });

        function toggleTodoCompletion(id) {
            const todos = (db && userId !== 'anonymous') ? offlineTodos : offlineTodos;
            const taskIndex = todos.findIndex(task => task.id === id);
            if (taskIndex > -1) {
                todos[taskIndex].completed = !todos[taskIndex].completed;
                localStorage.setItem('todoListData', JSON.stringify(todos)); // Update localStorage
                renderTodos();
            }
        }

        function deleteTodo(id) {
            const todos = (db && userId !== 'anonymous') ? offlineTodos : offlineTodos;
            const updatedTodos = todos.filter(task => task.id !== id);
            if (db && userId !== 'anonymous') {
                 // In real Firestore, you'd deleteDoc from the collection
                 localStorage.setItem('todoListData', JSON.stringify(updatedTodos)); // Demo fallback
            } else {
                localStorage.setItem('todoListData', JSON.stringify(updatedTodos));
            }
            offlineTodos = updatedTodos; // Update the in-memory array
            renderTodos();
            showMessage("Task deleted!", "info");
        }

        // --- Gift Lists ---
        function renderGiftList(type, list) {
            const listContainer = document.getElementById(`${type}List`);
            listContainer.innerHTML = '';
            if (list.length === 0) {
                listContainer.innerHTML = `<p class="text-muted-text text-center">No ${type} gift ideas yet.</p>`;
                return;
            }
            list.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-gray-700 p-2 rounded';
                itemDiv.innerHTML = `
                    <span>${item.text}</span>
                    <button class="text-red-400 hover:text-red-500" onclick="deleteGiftItem('${type}', '${item.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                listContainer.appendChild(itemDiv);
            });
        }

        function deleteGiftItem(type, id) {
            let list = (type === 'christmas') ? offlineChristmasList : offlineBirthdayList;
            const updatedList = list.filter(item => item.id !== id);
            if (type === 'christmas') {
                offlineChristmasList = updatedList;
                localStorage.setItem('christmasListData', JSON.stringify(offlineChristmasList));
            } else {
                offlineBirthdayList = updatedList;
                localStorage.setItem('birthdayListData', JSON.stringify(offlineBirthdayList));
            }
            renderGiftList(type, updatedList);
            showMessage("Gift idea deleted!", "info");
        }


        // --- Utilities Features ---

        // Currency Converter
        document.getElementById('currencyConverterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('currencyAmount').value);
            const fromCurrency = document.getElementById('fromCurrency').value;
            const toCurrency = document.getElementById('toCurrency').value;
            const resultDiv = document.getElementById('currencyResult');

            if (isNaN(amount) || amount <= 0) {
                showMessage("Please enter a valid amount.", "warning");
                return;
            }

            // Simulated exchange rates relative to USD (very basic mock)
            const rates = {
                "USD": { "EUR": 0.92, "GBP": 0.79, "JPY": 159.00, "ZAR": 18.00, "USD": 1 },
                "EUR": { "USD": 1.08, "GBP": 0.86, "JPY": 172.80, "ZAR": 19.50, "EUR": 1 },
                "GBP": { "USD": 1.27, "EUR": 1.16, "JPY": 201.20, "ZAR": 22.80, "GBP": 1 },
                "JPY": { "USD": 0.0063, "EUR": 0.0058, "GBP": 0.005, "ZAR": 0.11, "JPY": 1 },
                "ZAR": { "USD": 0.055, "EUR": 0.051, "GBP": 0.044, "JPY": 9.00, "ZAR": 1 }
            };

            if (rates[fromCurrency] && rates[fromCurrency][toCurrency]) {
                const convertedAmount = amount * rates[fromCurrency][toCurrency];
                resultDiv.textContent = `Result: ${convertedAmount.toFixed(2)} ${toCurrency}`;
                showMessage("Conversion successful (Simulated)!", "success");
            } else {
                resultDiv.textContent = `Result: Error`;
                showMessage("Conversion not available for these currencies (Simulated).", "error");
            }
        });

        // Unit Converter
        const unitConversions = {
            length: {
                "meters": { to: { "feet": 3.28084, "inches": 39.3701 }, from: { "feet": 0.3048, "inches": 0.0254 } },
                "feet": { to: { "meters": 0.3048, "inches": 12 }, from: { "meters": 3.28084, "inches": 0.0833333 } },
                "inches": { to: { "meters": 0.0254, "feet": 0.0833333 }, from: { "meters": 39.3701, "feet": 12 } }
            },
            weight: {
                "kilograms": { to: { "pounds": 2.20462, "ounces": 35.274 }, from: { "pounds": 0.453592, "ounces": 0.0283495 } },
                "pounds": { to: { "kilograms": 0.453592, "ounces": 16 }, from: { "kilograms": 2.20462, "ounces": 0.0625 } },
                "ounces": { to: { "kilograms": 0.0283495, "pounds": 0.0625 }, from: { "kilograms": 35.274, "pounds": 16 } }
            },
            temperature: {
                "celsius": { to: { "fahrenheit": (c) => (c * 9/5) + 32, "kelvin": (c) => c + 273.15 }, from: { "fahrenheit": (f) => (f - 32) * 5/9, "kelvin": (k) => k - 273.15 } },
                "fahrenheit": { to: { "celsius": (f) => (f - 32) * 5/9, "kelvin": (f) => (f - 32) * 5/9 + 273.15 }, from: { "celsius": (c) => (c * 9/5) + 32, "kelvin": (k) => (k - 273.15) * 9/5 + 32 } },
                "kelvin": { to: { "celsius": (k) => k - 273.15, "fahrenheit": (k) => (k - 273.15) * 9/5 + 32 }, from: { "celsius": (c) => c + 273.15, "fahrenheit": (f) => (f - 32) * 5/9 + 273.15 } }
            }
        };

        function initUnitConverterSelectors() {
            const unitTypeSelect = document.getElementById('unitType');
            const fromUnitSelect = document.getElementById('fromUnit');
            const toUnitSelect = document.getElementById('toUnit');

            function updateUnitOptions() {
                const selectedType = unitTypeSelect.value;
                const units = Object.keys(unitConversions[selectedType]);
                
                fromUnitSelect.innerHTML = '';
                toUnitSelect.innerHTML = '';

                units.forEach(unit => {
                    const option1 = document.createElement('option');
                    option1.value = unit;
                    option1.textContent = unit.charAt(0).toUpperCase() + unit.slice(1);
                    fromUnitSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = unit;
                    option2.textContent = unit.charAt(0).toUpperCase() + unit.slice(1);
                    toUnitSelect.appendChild(option2);
                });

                // Set initial default selections if needed
                if (units.length > 0) {
                    fromUnitSelect.value = units[0];
                    if (units.length > 1) {
                        toUnitSelect.value = units[1];
                    } else {
                        toUnitSelect.value = units[0]; // Or handle as an error if only one unit exists
                    }
                }
            }

            unitTypeSelect.addEventListener('change', updateUnitOptions);
            updateUnitOptions(); // Initial population
        }

        document.getElementById('unitConverterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const value = parseFloat(document.getElementById('unitValue').value);
            const unitType = document.getElementById('unitType').value;
            const fromUnit = document.getElementById('fromUnit').value;
            const toUnit = document.getElementById('toUnit').value;
            const resultDiv = document.getElementById('unitResult');

            if (isNaN(value)) {
                showMessage("Please enter a valid numerical value.", "warning");
                return;
            }
            if (fromUnit === toUnit) {
                resultDiv.textContent = `Result: ${value} ${fromUnit}`;
                showMessage("Units are the same.", "info");
                return;
            }

            const conversionRates = unitConversions[unitType];
            let convertedValue;

            if (unitType === "temperature") {
                // For temperature, conversions are functions
                let valueInBase;
                if (fromUnit === "celsius") valueInBase = value;
                else if (fromUnit === "fahrenheit") valueInBase = (value - 32) * 5/9; // Convert to Celsius
                else if (fromUnit === "kelvin") valueInBase = value - 273.15; // Convert to Celsius
                else {
                    showMessage("Unsupported temperature unit.", "error");
                    return;
                }

                if (toUnit === "celsius") convertedValue = valueInBase;
                else if (toUnit === "fahrenheit") convertedValue = (valueInBase * 9/5) + 32;
                else if (toUnit === "kelvin") convertedValue = valueInBase + 273.15;
                else {
                    showMessage("Unsupported target temperature unit.", "error");
                    return;
                }

            } else {
                // For length and weight, use direct multiplication
                // Convert from current unit to a base unit (e.g., meters for length, kilograms for weight)
                let valueInBase;
                if (fromUnit === "meters") valueInBase = value;
                else if (fromUnit === "feet") valueInBase = value * 0.3048;
                else if (fromUnit === "inches") valueInBase = value * 0.0254;
                else if (fromUnit === "kilograms") valueInBase = value;
                else if (fromUnit === "pounds") valueInBase = value * 0.453592;
                else if (fromUnit === "ounces") valueInBase = value * 0.0283495;
                else {
                    showMessage("Unsupported 'from' unit.", "error");
                    return;
                }

                // Convert from base unit to target unit
                if (toUnit === "meters") convertedValue = valueInBase;
                else if (toUnit === "feet") convertedValue = valueInBase / 0.3048;
                else if (toUnit === "inches") convertedValue = valueInBase / 0.0254;
                else if (toUnit === "kilograms") convertedValue = valueInBase;
                else if (toUnit === "pounds") convertedValue = valueInBase / 0.453592;
                else if (toUnit === "ounces") convertedValue = valueInBase / 0.0283495;
                else {
                    showMessage("Unsupported 'to' unit.", "error");
                    return;
                }
            }
            
            resultDiv.textContent = `Result: ${convertedValue.toFixed(2)} ${toUnit}`;
            showMessage("Conversion successful (Simulated)!", "success");
        });


        // Weather Forecast
        document.getElementById('weatherForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const city = document.getElementById('weatherCity').value.trim();
            const resultDiv = document.getElementById('weatherResult');

            if (!city) {
                showMessage("Please enter a city.", "warning");
                return;
            }

            const temperatures = ["25¬∞C / 77¬∞F", "18¬∞C / 64¬∞F", "30¬∞C / 86¬∞F", "10¬∞C / 50¬∞F", "22¬∞C / 72¬∞F", "15¬∞C / 59¬∞F"];
            const conditions = ["Sunny ‚òÄÔ∏è", "Partly Cloudy üå§Ô∏è", "Rainy üåßÔ∏è", "Stormy ‚õàÔ∏è", "Clear Night üåô", "Foggy üå´Ô∏è", "Snowy ‚ùÑÔ∏è"];

            const randomTemp = temperatures[Math.floor(Math.random() * temperatures.length)];
            const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];

            resultDiv.innerHTML = `Weather in ${city}: <br> <span class="font-bold text-xl">${randomTemp}</span>, ${randomCondition}`;
            showMessage("Weather fetched (Simulated)!", "success");
        });

        // --- Financial Hub Functions ---
        function loadFunds() {
            if (db && userId !== 'anonymous') {
                // In real app, fetch from Firestore. For demo, use offlineFunds
            }
            document.getElementById('familySavingFundBalance').textContent = offlineFunds.familySavingFund.toFixed(2);
            document.getElementById('personalSavingFundBalance').textContent = offlineFunds.personalSavingFund.toFixed(2);
            document.getElementById('emergencyFundBalance').textContent = offlineFunds.emergencyFund.toFixed(2);
        }

        function updateFund(fundType, operation) {
            let amountInputId;
            let fundKey;
            if (fundType === 'familySavingFund') {
                amountInputId = 'familySavingAmount';
                fundKey = 'familySavingFund';
            } else if (fundType === 'personalSavingFund') {
                amountInputId = 'personalSavingAmount';
                fundKey = 'personalSavingFund';
            } else if (fundType === 'emergencyFund') {
                amountInputId = 'emergencyFundAmount';
                fundKey = 'emergencyFund';
            }

            const amount = parseFloat(document.getElementById(amountInputId).value);

            if (isNaN(amount) || amount <= 0) {
                showMessage("Please enter a valid amount.", "warning");
                return;
            }

            if (operation === 'add') {
                offlineFunds[fundKey] += amount;
                showMessage(`$${amount.toFixed(2)} added to ${fundType.replace(/([A-Z])/g, ' $1').toLowerCase()}!`, "success");
            } else if (operation === 'subtract') {
                if (offlineFunds[fundKey] >= amount) {
                    offlineFunds[fundKey] -= amount;
                    showMessage(`$${amount.toFixed(2)} withdrawn from ${fundType.replace(/([A-Z])/g, ' $1').toLowerCase()}!`, "success");
                } else {
                    showMessage("Insufficient funds.", "error");
                    return;
                }
            }
            localStorage.setItem('financialFundsData', JSON.stringify(offlineFunds));
            loadFunds(); // Update display
            document.getElementById(amountInputId).value = ''; // Clear input
        }

        function simulatePayPalTransfer(fundType) {
            const fundName = fundType.replace(/([A-Z])/g, ' $1').toLowerCase();
            showMessage(`Initiating PayPal transfer for ${fundName} (SIMULATED)...`, "info");
            setTimeout(() => {
                showMessage(`PayPal transfer for ${fundName} completed (SIMULATED)! This would typically redirect to PayPal for authorization.`, "success");
            }, 2000);
        }


        // --- Profile Section ---
        function previewProfileImage(event) {
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById('profileImagePreview');
                output.src = reader.result;
                localStorage.setItem('profileImage', reader.result); // Save to local storage
            };
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        // Load profile image on startup
        document.addEventListener('DOMContentLoaded', () => {
            const savedImage = localStorage.getItem('profileImage');
            if (savedImage) {
                document.getElementById('profileImagePreview').src = savedImage;
            }
            // Other initializations here
        });

        // --- Gemini API Integration ---
        const GEMINI_API_KEY = "AIzaSyBGSDZATtITv5iIoB3rgKHBpWx9MrufxXE";

        async function callGeminiAPI(prompt, responseDiv, errorDiv) {
            responseDiv.textContent = 'Generating response...';
            errorDiv.classList.add('hidden');

            if (!prompt) {
                responseDiv.textContent = 'Please enter a prompt.';
                return;
            }

            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                responseDiv.textContent = '';
                errorDiv.textContent = 'Error: Gemini API Key is missing or invalid. Please ensure it\'s set correctly.';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorData.error.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response from AI.';
                responseDiv.textContent = aiResponse;

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                responseDiv.textContent = '';
                errorDiv.textContent = `Failed to get AI response: ${error.message}. Check your Gemini API key and network.`;
                errorDiv.classList.remove('hidden');
            }
        }

        document.getElementById('sendGeminiPrompt').addEventListener('click', async () => {
            const promptText = document.getElementById('geminiPrompt').value.trim();
            const responseDiv = document.getElementById('geminiResponse');
            const errorDiv = document.getElementById('geminiError');
            callGeminiAPI(promptText, responseDiv, errorDiv);
        });

        document.getElementById('sendCodingPrompt').addEventListener('click', async () => {
            const codingPromptText = document.getElementById('codingPrompt').value.trim();
            const responseDiv = document.getElementById('codingResponse');
            const errorDiv = document.getElementById('codingError');
            const fullPrompt = `Act as a coding assistant. ${codingPromptText}`;
            callGeminiAPI(fullPrompt, responseDiv, errorDiv);
        });

        document.getElementById('sendCareerPrompt').addEventListener('click', async () => {
            const careerPromptText = document.getElementById('careerPrompt').value.trim();
            const responseDiv = document.getElementById('careerResponse');
            const errorDiv = document.getElementById('careerError');
            const fullPrompt = `Act as a career guide. ${careerPromptText}`;
            callGeminiAPI(fullPrompt, responseDiv, errorDiv);
        });

        document.getElementById('sendAdminAIPrompt').addEventListener('click', async () => {
            const adminPromptText = document.getElementById('adminAIPrompt').value.trim();
            const responseDiv = document.getElementById('adminAIResponse');
            const errorDiv = document.getElementById('adminAIError');
            const fullPrompt = `Act as an admin assistant for a dashboard. ${adminPromptText}`;
            callGeminiAPI(fullPrompt, responseDiv, errorDiv);
        });
    </script>
</body>
</html>
