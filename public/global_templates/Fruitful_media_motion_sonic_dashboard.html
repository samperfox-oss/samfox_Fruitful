<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fruitful | CodeNestâ„¢ Dashboard - Motion, Media & Sonic</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        /**
         * Firestore Security Rules to enable this application's functionality.
         *
         * IMPORTANT: You need to apply these rules manually in your Firebase project's
         * Firestore -> Rules tab. Replace `YOUR_APP_ID_HERE` with the actual `__app_id`
         * that is provided by the Canvas environment.
         *
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         * // Allow authenticated users to read and write their own private data
         * match /artifacts/{appId}/users/{userId}/{documents=**} {
         * allow read, write: if request.auth != null && request.auth.uid == userId;
         * }
         *
         * // Allow authenticated users to read and write public data used by this demo app
         * // In a production environment, you might make public data read-only for all,
         * // and only allow authenticated admins to write.
         * match /artifacts/{appId}/public/data/{documents=**} {
         * allow read, write: if request.auth != null;
         * }
         *
         * // Allow authenticated users to read and write dashboard metrics
         * match /artifacts/{appId}/dashboardMetrics/{document=**} {
         * allow read, write: if request.auth != null;
         * }
         * }
         * }
         */

        // Global variables for Firebase (will be populated at runtime by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = 'loading'; // Default user ID state

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase initialized. User authenticated:", userId);
                    document.getElementById('currentUserIdDisplay').textContent = `User ID: ${userId}`;
                    // Once authenticated, load settings and other user-specific data
                    loadSettings();
                    // Load all Firestore data specific to views
                    renderAllFirestoreData();
                } else {
                    // Sign in anonymously if no user is found
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Anonymous Sign-in or Custom Token failed:", error);
                        window.showCustomModal('Auth Error', 'Failed to authenticate with Firebase. Some features may not work.', true);
                    }
                }
            });

        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            window.showCustomModal('Firebase Error', 'Failed to initialize Firebase. Please check your configuration.', true);
        }

        // Expose Firebase instances globally for use in main script (for simplicity in this single HTML file)
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.getUserId = () => userId; // Getter for userId

        // --- Firestore Data Interaction Functions (Globally accessible via window.firestoreXxxx) ---

        /**
         * Fetches a single document from Firestore.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document.
         * @returns {Promise<Object|null>} The document data or null if not found.
         */
        window.firestoreGetDoc = async (collectionPath, docId) => {
            if (!db) { console.error("Firestore not initialized."); return null; }
            try {
                const docRef = doc(db, collectionPath, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.log(`No such document: ${collectionPath}/${docId}`);
                    return null;
                }
            } catch (e) {
                console.error("Error getting document:", e);
                window.showCustomModal('Error', `Failed to load data: ${e.message}`, true);
                return null;
            }
        };

        /**
         * Sets (creates or overwrites) a document in Firestore.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document to set.
         * @param {Object} data - The data to set.
         * @returns {Promise<void>}
         */
        window.firestoreSetDoc = async (collectionPath, docId, data) => {
            if (!db) { console.error("Firestore not initialized."); return; }
            try {
                await setDoc(doc(db, collectionPath, docId), data, { merge: true }); // Use merge to avoid overwriting entire document
                console.log(`Document ${docId} in ${collectionPath} successfully written!`);
            } catch (e) {
                console.error("Error writing document:", e);
                window.showCustomModal('Error', `Failed to save data: ${e.message}`, true);
            }
        };

        /**
         * Adds a new document to a collection with an auto-generated ID.
         * @param {string} collectionPath - The path to the collection.
         * @param {Object} data - The data to add.
         * @returns {Promise<string>} The ID of the newly created document.
         */
        window.firestoreAddDoc = async (collectionPath, data) => {
            if (!db) { console.error("Firestore not initialized."); return null; }
            try {
                const docRef = await addDoc(collection(db, collectionPath), data);
                console.log(`Document written with ID: ${docRef.id} in ${collectionPath}`);
                return docRef.id;
            } catch (e) {
                console.error("Error adding document:", e);
                window.showCustomModal('Error', `Failed to add data: ${e.message}`, true);
                return null;
            }
        };

        /**
         * Updates fields in an existing document.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document to update.
         * @param {Object} data - The fields to update.
         * @returns {Promise<void>}
         */
        window.firestoreUpdateDoc = async (collectionPath, docId, data) => {
            if (!db) { console.error("Firestore not initialized."); return; }
            try {
                await updateDoc(doc(db, collectionPath, docId), data);
                console.log(`Document ${docId} in ${collectionPath} successfully updated!`);
            } catch (e) {
                console.error("Error updating document:", e);
                window.showCustomModal('Error', `Failed to update data: ${e.message}`, true);
            }
        };

        /**
         * Sets up a real-time listener for a collection.
         * @param {string} collectionPath - The path to the collection.
         * @param {function(Array)} callback - Callback function to handle data updates.
         * @returns {function()} An unsubscribe function to stop the listener.
         */
        window.firestoreOnCollectionSnapshot = (collectionPath, callback) => {
            if (!db) { console.error("Firestore not initialized."); return () => {}; }
            const q = collection(db, collectionPath);
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                // Sort data by a common field if needed, e.g., 'name' or 'timestamp'
                // For this app, we'll often sort by name or most recent activity in rendering functions.
                callback(data);
            }, (error) => {
                console.error("Error listening to collection:", error);
                window.showCustomModal('Real-time Error', `Failed to get real-time updates: ${error.message}`, true);
            });
            return unsubscribe;
        };

        /**
         * Sets up a real-time listener for a single document.
         * @param {string} collectionPath - The path to the collection.
         * @param {string} docId - The ID of the document.
         * @param {function(Object|null)} callback - Callback function to handle document updates.
         * @returns {function()} An unsubscribe function to stop the listener.
         */
        window.firestoreOnDocumentSnapshot = (collectionPath, docId, callback) => {
            if (!db) { console.error("Firestore not initialized."); return () => {}; }
            const docRef = doc(db, collectionPath, docId);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    callback(docSnap.data());
                } else {
                    callback(null);
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                window.showCustomModal('Real-time Error', `Failed to get real-time updates for document: ${error.message}`, true);
            });
            return unsubscribe;
        };

        /**
         * Fetches all documents from a collection once.
         * @param {string} collectionPath - The path to the collection.
         * @returns {Promise<Array>} An array of document data.
         */
        window.firestoreGetCollection = async (collectionPath) => {
            if (!db) { console.error("Firestore not initialized."); return []; }
            try {
                const q = collection(db, collectionPath);
                const querySnapshot = await getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (e) {
                console.error("Error getting collection documents:", e);
                window.showCustomModal('Error', `Failed to load data from collection: ${e.message}`, true);
                return [];
            }
        };

    </script>
    <style>
        /* Define Fruitful Global Color Palette and Base Styles */
        :root {
            /* Dark Mode Defaults */
            --primary-color: #0071e3; /* Apple Blue */
            --secondary-color: #ff3b30; /* Vibrant Red for Sonic */
            --text-color-light: #f5f5f7; /* Light text on dark backgrounds */
            --text-color-dark: #1d1d1f; /* Dark text on light backgrounds - used for some components that flip colors */
            --bg-color-dark: #1a1a1c; /* Deep black/dark grey */
            --card-bg-dark: #2a2a2e; /* Darker grey for dark cards */
            --border-color-dark: #3a3a3e; /* Subtle dark border */
            --accent-gold: #B8860B; /* Corporate gold accent */
            --status-active: #30d158; /* Green for active */
            --status-pending: #f59e0b; /* Amber for pending */
            --status-draft: #6e6e73; /* Gray for draft */
            --status-error: #ef4444; /* Red for error */

            /* Light Mode Variables (will override dark mode) */
            --light-primary-color: #0071e3;
            --light-secondary-color: #ff3b30;
            --light-text-color-light: #1d1d1f; /* Dark text for light mode body */
            --light-text-color-dark: #1d1d1f; /* Dark text for light mode body content */
            --light-bg-color-dark: #ffffff; /* White background for light mode */
            --light-card-bg-dark: #fcfcfc; /* Off-white for light cards */
            --light-border-color-dark: #e8e8ed; /* Subtle light border */
        }

        /* Base Body Styling - Defaults to dark mode based on root variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-dark);
            color: var(--text-color-light); /* Main text color based on mode */
            min-height: 100vh;
            display: flex;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
            margin: 0;
            padding: 0;
        }

        /* Light Mode specific overrides */
        body.light-mode {
            background-color: var(--light-bg-color-dark);
            color: var(--light-text-color-light);

            /* Overrides for specific components in light mode */
            .sidebar, .panel, .metric-card, .project-card, .chart-container, .custom-modal-content, .company-select-card {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
                box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Lighter shadow */
            }
            .sidebar-header .logo-text {
                color: var(--light-text-color-light); /* Fruitful part darker */
            }
            .nav-list a {
                color: var(--light-text-color-dark); /* Darker nav text */
            }
            .nav-list a:hover {
                background-color: rgba(0, 113, 227, 0.05); /* Lighter hover background */
                color: var(--light-primary-color);
            }
            .nav-list a.active {
                background-color: var(--light-primary-color);
                color: white;
            }
            .nav-icon {
                color: var(--secondary-color); /* Red remains contrast */
            }
            .panel h3, .panel h4 {
                color: var(--secondary-color); /* Red remains contrast */
            }
            .panel p, .project-card p, .api-key-value, .form-control label, .form-control input, .form-control select, .form-control textarea {
                color: var(--light-text-color-dark); /* Darker text for readability */
            }
            .form-control input[type="text"],
            .form-control input[type="email"],
            .form-control input[type="password"],
            .form-control select,
            .form-control textarea {
                background-color: #ebebeb; /* Lighter input fields */
                border-color: #d1d1d1;
                color: var(--light-text-color-light); /* Input text darker */
            }
            .project-card {
                background-color: #f0f0f0; /* Lighter project cards in light mode */
                border-color: #d1d1d1;
            }
            .project-actions button {
                color: white; /* Button text white */
                background-color: var(--secondary-color);
            }
            .project-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
                background-color: transparent;
            }
            .project-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .api-key-table th {
                background-color: #e8e8ed;
            }
            .api-key-table tr:hover {
                background-color: #f0f0f0;
            }
            .security-note {
                background-color: rgba(239, 68, 68, 0.08);
                color: #dc2626;
            }
            .template-preview-frame {
                background-color: #f8f8f8; /* Lighter iframe background */
            }
            .editor-container {
                background-color: var(--light-bg-color-dark);
            }
            .editor-header {
                background-color: var(--light-card-bg-dark);
                border-bottom: 1px solid var(--light-border-color-dark);
            }
            .code-editor, .preview-area {
                background-color: var(--light-card-bg-dark);
                border-color: var(--light-border-color-dark);
            }
            .code-editor textarea,
            #editorSectionTopicInput,
            #editorRephraseTextInput,
            #editorGeneratedContentOutput,
            .editor-content-area input {
                background-color: #ebebeb;
                border-color: #d1d1d1;
                color: var(--light-text-color-dark);
            }
            .editor-actions button {
                color: var(--light-text-color-dark); /* Dark button text */
            }
            .editor-actions button.secondary {
                color: var(--light-primary-color);
                border-color: var(--light-primary-color);
            }
            .editor-actions button.secondary:hover {
                background-color: rgba(0, 113, 227, 0.08);
            }
            .copy-square pre {
                color: var(--light-text-color-dark);
            }
            .toggle-section-btn span {
                color: var(--light-text-color-dark) !important;
            }
        }


        /* Sidebar Styling */
        .sidebar {
            width: 280px; /* Wider sidebar */
            background-color: var(--card-bg-dark);
            padding: 1.5rem 1rem;
            border-right: 1px solid var(--border-color-dark);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto; /* Scrollable sidebar */
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative; /* For theme toggle button positioning */
        }
        .sidebar-header .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color-light); /* Icon color changes with theme */
            transition: color 0.3s ease;
        }
        .sidebar-header .theme-toggle:hover {
            color: var(--primary-color);
        }
        .sidebar-header .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #FFFFFF; /* Fruitful part in white */
            line-height: 1; /* Adjust line height for better alignment */
        }
        .sidebar-header .logo-text span {
            color: var(--secondary-color); /* CodeNest part in red */
            font-size: 0.8em; /* Make 'CodeNest' slightly smaller relative to 'Fruitful' */
            letter-spacing: -0.02em; /* Tighter spacing for "CodeNest" */
        }
        .nav-list a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: var(--text-color-light); /* Nav text color changes with theme */
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .nav-list a:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
        }
        .nav-list a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }
        .nav-list a.active .nav-icon {
            color: white;
        }
        .nav-icon {
            font-size: 1.2rem;
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 2.5rem;
            background-color: var(--bg-color-dark); /* Background changes with theme */
            overflow-y: auto; /* Scrollable main content */
        }

        /* General Panel Styling */
        .panel {
            background-color: var(--card-bg-dark); /* Panel background changes with theme */
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .panel h3, .panel h4 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        .panel h3 { font-size: 1.8rem; }
        .panel h4 { font-size: 1.4rem; }
        .panel p {
            color: var(--text-color-light); /* Paragraph text changes with theme */
            line-height: 1.6;
        }

        /* Metric Cards */
        .metric-card {
            background-color: var(--card-bg-dark); /* Metric card background changes with theme */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .metric-card h4 {
            font-size: 1rem;
            color: var(--text-color-light); /* Metric title changes with theme */
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .metric-card p {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.1;
        }

        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .project-card {
            background-color: #1a1a1a; /* Project card background (slightly lighter dark) */
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #3a3a3e; /* Border based on this card's color */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Light mode specific override for project card background */
        body.light-mode .project-card {
            background-color: #f0f0f0; /* Lighter project cards in light mode */
            border-color: #d1d1d1;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .project-card h4 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .project-card p {
            font-size: 0.9rem;
            color: var(--text-color-light); /* Project card text color changes with theme */
            margin-bottom: 0.4rem;
        }
        /* Light mode specific override for project card text */
        body.light-mode .project-card p {
            color: var(--text-color-dark);
        }
        .project-status {
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            font-size: 0.8rem;
        }
        .status-live { background-color: var(--status-active); color: white; }
        .status-pending { background-color: var(--status-pending); color: white; }
        .status-draft { background-color: var(--status-draft); color: white; }
        .status-error { background-color: var(--status-error); color: white; }
        .project-actions button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .project-actions button:hover {
            background-color: #cc2d24;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255,59,48,0.3);
        }
        .project-actions button.secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .project-actions button.secondary:hover {
            background-color: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Form styling */
        .form-control {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .form-control label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color-light); /* Label text changes with theme */
        }
        body.light-mode .form-control label {
            color: var(--text-color-dark); /* Darker labels in light mode */
        }
        .form-control input[type="text"],
        .form-control input[type="email"],
        .form-control input[type="password"],
        .form-control select,
        .form-control textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e; /* Input background changes with theme */
            color: var(--text-color-light); /* Input text color changes with theme */
            font-size: 1rem;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        body.light-mode .form-control input, body.light-mode .form-control select, body.light-mode .form-control textarea {
            background-color: #ebebeb; /* Lighter input fields */
            border-color: #d1d1d1;
            color: var(--text-color-dark);
        }
        .form-control input:focus, .form-control select:focus, .form-control textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }
        .form-action-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .form-action-button:hover {
            background-color: #cc2d24;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255,59,48,0.3);
        }
        .form-action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Analytics Chart specific styling */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            background-color: var(--bg-color-dark); /* Dark background for charts */
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        /* Light mode specific override for chart background */
        body.light-mode .chart-container {
            background-color: #f0f0f0;
            border-color: #d1d1d1;
        }

        /* API Keys table styling */
        .api-key-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            text-align: left;
        }
        .api-key-table th, .api-key-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-color-dark); /* Border changes with theme */
        }
        body.light-mode .api-key-table th, body.light-mode .api-key-table td {
            border-color: var(--light-border-color-dark);
        }
        .api-key-table th {
            background-color: #1a1a1a; /* Header background (slightly lighter dark) */
            color: var(--secondary-color);
            font-weight: 600;
        }
        body.light-mode .api-key-table th {
            background-color: #e8e8ed;
        }
        .api-key-table tr:hover {
            background-color: #3a3a3e; /* Row hover background */
        }
        body.light-mode .api-key-table tr:hover {
            background-color: #f0f0f0;
        }
        .api-key-value {
            font-family: 'monospace';
            font-size: 0.85rem;
            color: var(--text-color-light); /* Key value text changes with theme */
            word-break: break-all;
        }
        body.light-mode .api-key-value {
            color: var(--text-color-dark);
        }
        .security-note {
            background-color: #ef444420; /* Light red background */
            border-left: 4px solid var(--status-error);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            color: #ef4444; /* Red text */
            font-size: 0.9rem;
            text-align: left;
        }


        /* Utility for hidden views */
        .view-hidden {
            display: none;
        }

        /* Custom Modal for Alerts */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0; /* Start hidden for fade effect */
            visibility: hidden; /* Prevent interaction when hidden */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: var(--card-bg-dark); /* Modal background changes with theme */
            color: var(--text-color-light); /* Modal text changes with theme */
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border-color-dark); /* Border changes with theme */
            transform: translateY(-20px); /* Start slightly up for animation */
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        body.light-mode .custom-modal-content {
            background-color: var(--light-card-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--light-border-color-dark);
        }
        .custom-modal-overlay.active .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }


        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Template Preview Modal */
        #templatePreviewModal .template-preview-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #templatePreviewModal .template-preview-header h3 {
            color: white;
            margin: 0;
        }
        #templatePreviewModal .close-preview-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #templatePreviewModal .close-preview-btn:hover {
            transform: scale(1.1);
        }
        #templatePreviewModal .template-preview-body {
            padding: 1.5rem;
            background-color: var(--card-bg-dark);
        }
        #templatePreviewModal .template-preview-frame {
            width: 100%;
            height: 400px; /* Fixed height for preview */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #1a1a1c; /* Dark background for iframe */
        }
        #templatePreviewModal .template-preview-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #cc2d24;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--status-draft);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #525257;
            transform: translateY(-1px);
        }

        /* Ecosystem Map Styling */
        .copy-square {
            position: relative;
            background-color: #3a3a3e;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            border: 1px solid var(--border-color-dark);
        }
        body.light-mode .copy-square {
            background-color: #e8e8ed;
            border-color: #d1d1d1;
        }
        .copy-square .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
        }
        .copy-square:hover .copy-button {
            opacity: 1; /* Show on hover */
        }
        .copy-square .copy-button:hover {
            background-color: #005bb5;
        }
        .copy-square pre.conversation-code-block {
            background: none;
            border: none;
            color: var(--text-color-light); /* Ensure text is visible in dark mode */
            padding: 0;
            margin: 0;
            font-size: 0.85rem;
            white-space: pre-wrap; /* Preserve formatting but wrap long lines */
            word-break: break-all; /* Break long words if necessary */
            padding-right: 40px; /* Make space for the copy button */
        }
        body.light-mode .copy-square pre.conversation-code-block {
            color: var(--text-color-dark);
        }

        .toggle-section-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color); /* Matches current active nav link or primary color */
            transition: color 0.2s ease;
        }
        body.light-mode .toggle-section-btn {
            color: var(--light-primary-color);
        }
        .toggle-section-btn:hover {
            color: var(--primary-color);
        }
        .toggle-section-btn i {
            margin-left: 0.5rem;
            transition: transform 0.2s ease;
        }
        .toggle-section-btn i.fa-chevron-up {
            transform: rotate(180deg);
        }
        .repo-content-section {
            padding-left: 1rem;
            border-left: 2px solid var(--border-color-dark); /* Indent and show hierarchy */
            margin-top: 1rem;
            padding-top: 0.5rem;
        }
        body.light-mode .repo-content-section {
            border-color: var(--light-border-color-dark);
        }
        .repo-content-section .toggle-section-btn {
            font-size: 1rem; /* Smaller for nested levels */
            font-weight: 500;
            color: var(--text-color-light); /* Nested sections use lighter text color */
        }
        body.light-mode .repo-content-section .toggle-section-btn {
            color: var(--text-color-dark);
        }

        /* Ecosystem Map specific section-intro and section-title */
        #ecosystem-map-view .section-title {
            color: var(--secondary-color);
            font-size: 2.2rem;
            font-weight: 800;
        }
        #ecosystem-map-view .section-intro {
            color: var(--text-color-light);
            text-align: center;
            font-size: 1.1rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        body.light-mode #ecosystem-map-view .section-intro {
            color: var(--text-color-dark);
        }

        /* Global Checkout Styling */
        #ecosystem-map-view .step-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            margin-right: 0.75rem;
        }
        #ecosystem-map-view .checkout-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: #3a3a3e;
            color: var(--text-color-light);
            font-size: 1rem;
        }
        #ecosystem-map-view .checkout-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1.5rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        #ecosystem-map-view .checkout-button:hover {
            background-color: #cc2d24;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255,59,48,0.3);
        }

        /* Editor Workspace Styling */
        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 5rem); /* Adjust based on main-content padding */
            background-color: var(--card-bg-dark);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color-dark);
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #1a1a1a; /* Slightly lighter dark for header */
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color-dark);
        }
        .editor-content-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Prevent content overflow */
        }
        .code-editor, .preview-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .code-editor {
            border-right: 1px solid var(--border-color-dark);
        }
        .code-editor textarea {
            background-color: #3a3a3e;
            border: 1px solid var(--border-color-dark);
            color: var(--text-color-light);
            padding: 0.75rem;
            border-radius: 8px;
            font-family: 'monospace';
            font-size: 0.9rem;
            flex-grow: 1; /* Allow textarea to take available height */
            min-height: 150px; /* Minimum height for code areas */
            resize: vertical; /* Allow vertical resizing */
        }
        .preview-area iframe {
            width: 100%;
            flex-grow: 1; /* Allow iframe to take available height */
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            background-color: #f8f8f8; /* Light background for iframe content */
            min-height: 300px;
        }
        .editor-actions {
            padding: 1rem 1.5rem;
            background-color: #1a1a1a;
            border-top: 1px solid var(--border-color-dark);
            gap: 1rem;
        }
        .editor-actions button {
            margin-top: 0; /* Override default margin-top from .form-action-button */
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
        }

        /* Settings Tab Navigation */
        .settings-tab-btn {
            padding: 0.75rem 1.25rem;
            background-color: transparent;
            border: none;
            color: var(--text-color-light);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        body.light-mode .settings-tab-btn {
            color: var(--text-color-dark);
        }
        .settings-tab-btn:hover {
            color: var(--primary-color);
            border-color: rgba(0, 113, 227, 0.5);
        }
        .settings-tab-btn.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Company Selection Card for Settings */
        .company-select-card {
            background-color: #2a2a2e; /* Darker grey background */
            border: 1px solid #3a3a3e; /* Dark border */
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        body.light-mode .company-select-card {
            background-color: #f0f0f0; /* Lighter background in light mode */
            border-color: #d1d1d1;
        }
        .company-select-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .company-details-section {
            background-color: #2a2a2e;
            border: 1px solid #3a3a3e;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-top: 2.5rem;
        }
        body.light-mode .company-details-section {
            background-color: #fcfcfc;
            border-color: #e8e8ed;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .editor-content-area {
                flex-direction: row;
            }
            .code-editor, .preview-area {
                border-right: 1px solid var(--border-color-dark); /* Separator in desktop view */
            }
            .preview-area {
                border-right: none; /* No right border on last item */
            }
        }
        @media (max-width: 767px) {
            .editor-content-area {
                flex-direction: column;
            }
            .code-editor, .preview-area {
                border-bottom: 1px solid var(--border-color-dark);
            }
            .preview-area {
                border-bottom: none;
            }
            .editor-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }


        /* Responsive Mobile Layout */
        @media (max-width: 767px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
                border-right: none;
                border-bottom: 1px solid var(--border-color-dark);
                flex-direction: row; /* Horizontal layout for mobile nav */
                justify-content: space-around;
                flex-wrap: wrap; /* Allow nav items to wrap */
                position: sticky; /* Keep sidebar visible on scroll */
                top: 0;
                z-index: 40; /* Ensure it's above main content when scrolling */
            }
            .sidebar-header {
                width: 100%;
                margin-bottom: 1rem;
                display: flex; /* Make it a flex container to center logo */
                justify-content: center; /* Center logo horizontally */
                align-items: center;
                height: auto; /* Allow height to adjust */
            }
            .sidebar-header .theme-toggle {
                position: relative; /* Adjust position for mobile, remove absolute positioning */
                top: auto;
                right: auto;
                margin-left: 1rem; /* Add some spacing */
            }
            .sidebar-header .logo-text {
                font-size: 1.5rem; /* Adjust font size for mobile */
                letter-spacing: -0.01em;
            }
            .sidebar-header .logo-text span {
                font-size: 0.8em; /* Keep relative size */
            }
            .nav-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
            .nav-list a {
                margin: 0.2rem 0.3rem; /* Tighter spacing for mobile nav items */
                padding: 0.5rem 0.6rem;
                font-size: 0.75rem; /* Smaller font size */
                gap: 0.5rem; /* Smaller gap for icon/text */
                flex-grow: 1; /* Allow items to stretch to fill space */
                justify-content: center; /* Center text within small buttons */
            }
            .nav-list a .nav-icon {
                font-size: 0.9rem; /* Smaller icon on mobile */
                margin-right: 0.2rem;
            }

            .main-content {
                padding: 1rem; /* Reduced padding for main content */
            }
            .panel {
                padding: 1.5rem; /* Reduced panel padding */
                margin-bottom: 1.5rem;
            }
            .panel h3 { font-size: 1.5rem; margin-bottom: 1rem;}
            .panel h4 { font-size: 1.2rem; margin-bottom: 0.8rem;}
            .metric-card p { font-size: 2rem; }
            .project-grid {
                grid-template-columns: 1fr; /* Stack projects on mobile */
                gap: 1rem;
            }
            .project-actions button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                margin-right: 0.3rem;
                margin-top: 0.5rem;
            }
            .form-control {
                margin-bottom: 1rem;
            }
            .form-control input, .form-control select, .form-control textarea {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .form-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .chart-container {
                height: 250px; /* Shorter charts on mobile */
            }
            .api-key-table th, .api-key-table td {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            .api-key-value {
                font-size: 0.7rem;
            }
            .security-note {
                padding: 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 class="logo-text">Fruitfulâ„¢ | <span>SonicNestâ„¢</span></h2>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-sun"></i> <!-- Default to sun icon for dark mode -->
            </button>
        </div>
        <nav class="nav-list">
            <a href="#dashboard" class="active" data-view="dashboard">
                <i class="fas fa-home nav-icon"></i> Dashboard
            </a>
            <a href="#projects" data-view="projects">
                <i class="fas fa-project-diagram nav-icon"></i> Projects
            </a>
            <a href="#new-project" data-view="new-project">
                <i class="fas fa-plus-circle nav-icon"></i> New Project
            </a>
            <a href="#scroll-builder" data-view="scroll-builder">
                <i class="fas fa-tools nav-icon"></i> Content Builder
            </a>
            <a href="#ecosystem-map" data-view="ecosystem-map">
                <i class="fas fa-sitemap nav-icon"></i> Ecosystem Map
            </a>
            <a href="#global-checkout" data-view="global-checkout">
                <i class="fas fa-shopping-cart nav-icon"></i> Global Payment
            </a>
            <a href="#templates" data-view="templates">
                <i class="fas fa-palette nav-icon"></i> Templates
            </a>
            <a href="#licenses" data-view="licenses">
                <i class="fas fa-file-contract nav-icon"></i> My Licenses
            </a>
            <a href="#analytics" data-view="analytics">
                <i class="fas fa-chart-line nav-icon"></i> Analytics
            </a>
            <a href="#api-keys" data-view="api-keys">
                <i class="fas fa-key nav-icon"></i> API Keys
            </a>
            <a href="#settings" data-view="settings">
                <i class="fas fa-cog nav-icon"></i> Settings
            </a>
            <a href="#login" data-view="login">
                <i class="fas fa-sign-in-alt nav-icon"></i> Sign In
            </a>
            <a href="#signup" data-view="signup">
                <i class="fas fa-user-plus nav-icon"></i> Sign Up
            </a>
        </nav>
        <div class="mt-auto text-center text-xs text-gray-500 pt-4 border-t border-gray-700">
            <span id="currentUserIdDisplay">User ID: Loading...</span>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Dashboard Home View -->
        <section id="dashboard-view" class="view">
            <div class="panel">
                <h3>Welcome Back, Media & Sonic Creator!</h3>
                <p class="mb-4">Your SonicNestâ„¢ portal provides comprehensive tools for building, licensing, and deploying cutting-edge motion, media, and sonic projects across the Fruitful Global Treaty Grid.</p>
                <button class="form-action-button" onclick="showView('new-project')">
                    <i class="fas fa-plus-circle mr-2"></i> Start New Media Project
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="metric-card">
                    <h4>Total Media Projects</h4>
                    <p id="totalProjectsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Active Streams</h4>
                    <p id="liveScrollsCount">0</p>
                </div>
                <div class="metric-card">
                    <h4>Monthly Sonic Royalties</h4>
                    <p id="monthlyRoyalties">$0.00</p>
                </div>
            </div>

            <div class="panel">
                <h3>System Health Overview</h3>
                <div class="chart-container">
                    <canvas id="systemHealthChart"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <h3>SonicGridâ„¢ Snapshot</h3>
                <p>SonicGridâ„¢ provides a robust media management system for content, audio engineers, industry, and app integration.</p>
                <h4>Key Features:</h4>
                <ul>
                    <li>Lossless audio and video processing</li>
                    <li>Real-time synchronization with Omni Gridâ„¢</li>
                    <li>Multi-platform compatibility</li>
                    <li>Secure cloud-based storage</li>
                </ul>
                <h4>FAA Metadata:</h4>
                <ul>
                    <li>Product ID: SONIC-GRID-FAA-001</li>
                    <li>Version: SG-4.0.0</li>
                    <li>Supported Omni Gridâ„¢ Version: OG-4.2.0</li>
                </ul>
                <a href="#" class="form-action-button">Go to Sonic Gridâ„¢ Public Page &rarr;</a>
            </div>
        </section>

        <!-- Projects View -->
        <section id="projects-view" class="view view-hidden">
            <div class="panel">
                <h3>Your Media & Sonic Projects</h3>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <input type="text" id="projectSearch" placeholder="Search projects..." class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                    <select id="projectFilterStatus" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white">
                        <option value="all">All Statuses</option>
                        <option value="live">Live</option>
                        <option value="pending">Pending</option>
                        <option value="draft">Draft</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div id="projectsList" class="project-grid">
                    <!-- Projects will be loaded here -->
                    <p class="text-center text-gray-400">Loading projects...</p>
                </div>
                <div class="text-center mt-6">
                    <button id="loadMoreProjects" class="form-action-button"><i class="fas fa-sync-alt mr-2"></i> Load More Projects</button>
                </div>
            </div>
        </section>

        <!-- New Project View -->
        <section id="new-project-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-plus-circle mr-2"></i> Start a New Motion, Media & Sonic Project</h3>
                <form id="newProjectForm">
                    <div class="form-control">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" name="projectName" placeholder="e.g. Immersive Audio Experience" required>
                    </div>

                    <div class="form-control">
                        <label for="template">Choose Template</label>
                        <select id="template" name="template" required>
                            <option value="">Loading templates...</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="description">Project Description</label>
                        <div class="flex items-center space-x-2">
                            <textarea id="description" name="description" rows="5" class="flex-grow" placeholder="Describe your project goals, use case, or content focus..."></textarea>
                            <button type="button" id="generateDescriptionBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> âœ¨ AI Generate Description
                            </button>
                        </div>
                        <p id="descriptionStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="projectConcept">High-Level Project Concept</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="projectConcept" placeholder="e.g., AI-powered music composition platform">
                            <button type="button" id="generateProjectIdeaBtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ AI Project Idea
                            </button>
                        </div>
                        <p id="projectIdeaStatus" class="text-xs text-gray-400 mt-1"></p>
                    </div>

                    <div class="form-control">
                        <label for="region">Deployment Region</label>
                        <select id="region" name="region">
                            <option value="Global Stream">Global Stream</option>
                            <option value="Local Distribution">Local Distribution</option>
                            <option value="Event Capture">Event Capture (Pop-up)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="claim">Enable ClaimRootâ„¢ Auto-License?</label>
                        <select id="claim" name="claim">
                            <option value="yes">Yes â€“ License this content</option>
                            <option value="no">No â€“ Just save it</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Create Project</button>
                    <p class="text-gray-500 text-sm mt-4">Projects will be saved in your SonicNest workspace and can be synced to Fruitful Global upon deployment.</p>
                </form>
            </div>
        </section>

        <!-- Content Builder View -->
        <section id="scroll-builder-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-tools mr-2"></i> Content Builder â€” Deploy Your SonicNestâ„¢ Content</h3>
                <form id="scrollBuilderForm">
                    <div class="form-control">
                        <label for="sbScrollName">Content Title</label>
                        <input type="text" id="sbScrollName" name="scrollName" placeholder="e.g. Dynamic Audio Visualizer">
                    </div>

                    <div class="form-control">
                        <label for="sbScrollType">Content Type</label>
                        <select id="sbScrollType" name="scrollType">
                            <option value="">Loading types...</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label for="htmlCode">HTML/Media Player Code</label>
                        <textarea id="htmlCode" name="htmlCode" rows="8" class="flex-grow" placeholder="Paste or write HTML for media player, canvas, etc..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineHtmlBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> âœ¨ Refine HTML
                            </button>
                            <button type="button" id="explainHtmlBtn" class="form-action-button secondary text-xs px-3 py-2">
                                <i class="fas fa-question-circle"></i> âœ¨ Explain HTML
                            </button>
                            <button type="button" id="reviewHtmlBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                <i class="fas fa-search"></i> âœ¨ Review HTML
                            </button>
                            <label for="uploadHtml" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload HTML
                                <input type="file" id="uploadHtml" accept=".html,.htm" class="hidden">
                            </label>
                            <input type="text" id="importHtmlUrl" placeholder="Import HTML from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importHtmlUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="htmlRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="htmlExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="htmlReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="cssCode">CSS Styling</label>
                        <textarea id="cssCode" name="cssCode" rows="6" class="flex-grow" placeholder="Add styling for your media player or visuals here..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineCssBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> âœ¨ Refine CSS
                            </button>
                            <button type="button" id="explainCssBtn" class="form-action-button secondary text-xs px-3 py-2">
                                <i class="fas fa-question-circle"></i> âœ¨ Explain CSS
                            </button>
                            <button type="button" id="reviewCssBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                <i class="fas fa-search"></i> âœ¨ Review CSS
                            </button>
                            <label for="uploadCss" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload CSS
                                <input type="file" id="uploadCss" accept=".css" class="hidden">
                            </label>
                            <input type="text" id="importCssUrl" placeholder="Import CSS from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importCssUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="cssRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="cssExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="cssReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="jsCode">JavaScript (Optional)</label>
                        <textarea id="jsCode" name="jsCode" rows="5" class="flex-grow" placeholder="Optional scripts for audio playback, visualizers, interactive elements..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="refineJsBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> âœ¨ Refine JavaScript
                            </button>
                            <button type="button" id="explainJsBtn" class="form-action-button secondary text-xs px-3 py-2">
                                <i class="fas fa-question-circle"></i> âœ¨ Explain JavaScript
                            </button>
                            <button type="button" id="reviewJsBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                <i class="fas fa-search"></i> âœ¨ Review JavaScript
                            </button>
                            <label for="uploadJs" class="form-action-button text-xs px-3 py-2 cursor-pointer bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-upload mr-1"></i> Upload JS
                                <input type="file" id="uploadJs" accept=".js" class="hidden">
                            </label>
                            <input type="text" id="importJsUrl" placeholder="Import JS from URL (e.g., GitHub raw)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs">
                            <button type="button" id="importJsUrlBtn" class="form-action-button text-xs px-3 py-2 bg-blue-600 hover:bg-blue-700">
                                <i class="fas fa-download mr-1"></i> Import
                            </button>
                        </div>
                        <p id="jsRefineStatus" class="text-xs text-gray-400 mt-1"></p>
                        <div id="jsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="jsReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-control">
                        <label for="scrollTopic">Content Topic (for AI Content Ideas)</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="scrollTopic" placeholder="e.g., Ambient Soundscapes, Interactive Film Trailers">
                            <button type="button" id="generateContentIdeasBtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ Generate Ideas
                            </button>
                        </div>
                        <p id="contentIdeasStatus" class="text-xs text-gray-400 mt-1"></p>
                        <textarea id="contentIdeasOutput" rows="8" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Generated content ideas will appear here..." readonly></textarea>
                    </div>

                    <div class="form-control">
                        <label for="sbClaim">Content Licensing with ClaimRootâ„¢?</label>
                        <select id="sbClaim" name="claim">
                            <option value="yes">Yes â€” Activate content claim</option>
                            <option value="no">No â€” Build only</option>
                        </select>
                    </div>

                    <button type="submit" class="form-action-button">Compile Content & Save</button>
                    <p class="text-gray-500 text-sm mt-4">Your content will be saved to your local SonicNest workspace with optional auto-deploy to Fruitful Global.</p>
                </form>
            </div>
        </section>

        <!-- NEW: Ecosystem Map View -->
        <section id="ecosystem-map-view" class="view view-hidden">
            <div class="panel">
                <h2 class="section-title text-center mb-12">Global Repository & Routing Structure</h2>
                <p class="section-intro mb-8">This section illustrates the precise, templated file path and repository structure for the entire FAA.Zone ecosystem. Click on a sector to expand its details and reveal the exact URLs. This structure guarantees consistency and automated deployment across all 7038+ digital assets.</p>
                
                <div id="sectorContainer" class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                    <h3 class="text-xl font-bold mb-4 text-red-400">Explore File Paths by Sector:</h3>
                    <div class="space-y-3">
                        <!-- Dynamic sector-brand-subnode structure will be rendered here by JS -->
                        <p class="text-gray-400">Loading ecosystem data...</p>
                    </div>
                </div>

                <div class="panel mt-8">
                    <h2 class="section-title text-center mb-12">Global Footer Repository: The Legal Standard</h2>
                    <p class="section-intro mb-8">The global footer, including all mandatory legal and ecosystem links, is managed from a single, dedicated repository. This ensures strict consistency, legal compliance, and branding integrity across every single page, brand, and subnode within the FAA.Zone.</p>
                    
                    <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow-2xl text-left">
                        <h3 class="text-xl font-bold mb-4 text-red-400">Conceptual `footer-global-repo` Structure:</h3>
                        <div class="copy-square">
                            <button class="copy-button" onclick="copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">
/footer-global-repo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ GlobalFooter.js  # Reusable footer component
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ footer.css       # Styling for the footer
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ privacy.html         # Content for /privacy route
â”‚   â”œâ”€â”€ terms.html           # Content for /terms route
â”‚   â”œâ”€â”€ contact.html         # Content for /contact route
â”‚   â”œâ”€â”€ copyright.html       # Content for /copyright route
â”‚   â”œâ”€â”€ developers.html      # Content for /developers route
â”‚   â”œâ”€â”€ vaultmesh.html       # Content for /vaultmesh route
â”‚   â”œâ”€â”€ fruitful.html        # Content for /fruitful route
â”‚   â”œâ”€â”€ faa.zone.html        # Content for /faa.zone route
â”‚   â”œâ”€â”€ about.html           # Content for /about route
â”‚   â””â”€â”€ accessibility.html   # Content for /accessibility route
â””â”€â”€ package.json             # Build scripts for global deployment
                            </pre>
                        </div>
                        <p class="text-gray-400 text-sm">This repository is automatically integrated into every sector's build process, ensuring all sites adhere to the global footer mandate.</p>
                    </div>
                </div>
                
                <div class="panel mt-8">
                    <h2 class="section-title text-center mb-12">Global Payment & Checkout: Seamless Transactions</h2>
                    <p class="section-intro mb-8">Fruitful Global provides a unified, secure, and automated payment and checkout solution. Integrated with **VaultPayâ„¢** for secure transactions and **ClaimRootâ„¢** for automated licensing, this system ensures a frictionless experience for both customers and partners globally. No payment-related troubleshooting needed; the logic is transparent and self-validating.</p>

                    <div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-lg shadow-2xl">
                        <h3 class="text-xl font-bold mb-6 text-red-400">Experience the Global Checkout Flow:</h3>
                        
                        <div id="checkout-step-1">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">1</span> Item Selection</h4>
                            <p class="text-gray-300 mb-4">Your selected item: **Sonic Gridâ„¢ Enterprise License**</p>
                            <p class="text-gray-300 mb-4">Price: **$9,999.00 USD** (One-time license fee)</p>
                            <button class="checkout-button" onclick="showCheckoutStep(2)">Proceed to Checkout</button>
                        </div>

                        <div id="checkout-step-2" class="hidden">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">2</span> Payment Information</h4>
                            <p class="text-gray-300 mb-4">Enter your secure payment details for **VaultPayâ„¢** processing.</p>
                            <input type="text" id="cardNumber" placeholder="Card Number (e.g., 4111 XXXX XXXX 1111)" class="checkout-input mb-3">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="text" id="expiryDate" placeholder="MM/YY" class="checkout-input">
                                <input type="text" id="cvc" placeholder="CVC" class="checkout-input">
                            </div>
                            <button class="checkout-button w-full" onclick="processPayment()">Process Payment via VaultPayâ„¢</button>
                            <p id="paymentStatus" class="text-red-400 mt-2 text-sm hidden">Payment processing...</p>
                        </div>

                        <div id="checkout-step-3" class="hidden">
                            <h4 class="text-lg font-semibold mb-4 text-white flex items-center justify-center"><span class="step-indicator">3</span> Order Confirmation & Licensing</h4>
                            <p class="text-gray-300 mb-4">Your order is confirmed! Licensing is being secured via **ClaimRootâ„¢**.</p>
                            <p id="orderStatus" class="text-green-400 mb-4">Status: **Processing ClaimRootâ„¢ License...**</p>
                            <button class="checkout-button w-full" onclick="resetCheckout()">Complete & Return to Dashboard</button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- NEW: Editor Workspace View (Integrated Content Editor) -->
        <section id="editor-workspace-view" class="view view-hidden">
            <div class="editor-container">
                <div class="editor-header">
                    <span id="currentProjectEditName">Content Editor</span>
                    <button class="text-white text-xl hover:text-gray-300" onclick="showView('projects')">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
                <div class="editor-content-area">
                    <div class="code-editor">
                        <h4 class="text-xl font-semibold mb-4 text-white">Edit HTML/CSS</h4>
                        <textarea id="editorHtmlCssCode" placeholder="Edit your Motion, Media, or Sonic content code here..."></textarea>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorRefineCodeBtn" class="form-action-button text-xs px-3 py-2">
                                <i class="fas fa-magic"></i> âœ¨ Refine Code
                            </button>
                            <button type="button" id="editorExplainCodeBtn" class="form-action-button secondary text-xs px-3 py-2">
                                <i class="fas fa-question-circle"></i> âœ¨ Explain Code
                            </button>
                            <button type="button" id="editorReviewCodeBtn" class="form-action-button secondary text-xs px-3 py-2 bg-yellow-600 hover:bg-yellow-700">
                                <i class="fas fa-search"></i> âœ¨ Review Code
                            </button>
                        </div>
                        <p id="editorHtmlCssStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="editorHtmlCssExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                        <div id="editorHtmlCssReviewOutput" class="w-full p-2 border border-gray-600 rounded-md bg-yellow-800 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>

                        <h5 class="text-lg font-semibold mt-6 mb-2 text-white">AI Content Generation</h5>
                        <div class="form-control">
                            <label for="editorSectionTopicInput" class="text-white text-sm mb-1">Content Segment Topic</label>
                            <input type="text" id="editorSectionTopicInput" placeholder="e.g., Audio Mixer Controls, Video Timeline Interface" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorGenerateHeadlineBtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ Generate Headline
                            </button>
                            <button type="button" id="editorGenerateCTABtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ Generate CTA
                            </button>
                            <button type="button" id="editorGenerateSectionContentBtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ Generate Section Content
                            </button>
                        </div>
                        <div class="form-control mt-4">
                            <label for="editorRephraseTextInput" class="text-white text-sm mb-1">Rephrase/Improve Text</label>
                            <textarea id="editorRephraseTextInput" rows="3" placeholder="Enter text to rephrase or improve..." class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm"></textarea>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <button type="button" id="editorRephraseTextBtn" class="form-action-button text-xs px-3 py-2">
                                âœ¨ Rephrase/Improve
                            </button>
                        </div>
                        <p id="editorContentGenStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="editorGeneratedContentOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </div>
                    <div class="preview-area">
                        <h4 class="text-xl font-semibold mb-4 text-white">Live Preview</h4>
                        <iframe id="editorLivePreviewFrame" title="Live Preview"></iframe>
                    </div>
                </div>
                <div class="editor-actions flex justify-center w-full"> <!-- Added flex and justify-center -->
                    <button class="form-action-button secondary" onclick="updateEditorPreview()">Update Preview</button>
                    <button class="form-action-button" onclick="saveProjectFromEditor()">Save Project</button>
                    <button class="form-action-button" onclick="deployProjectFromEditor()">Deploy Project</button>
                </div>
            </div>
        </section>


        <!-- Templates View -->
        <section id="templates-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-palette mr-2"></i> Select a Template</h3>
                <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Templates will be loaded here -->
                    <p class="text-center text-gray-400">Loading templates...</p>
                </div>
            </div>
        </section>

        <!-- Licenses View -->
        <section id="licenses-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-file-contract mr-2"></i> My Licensed Content</h3>
                <p class="mb-4 text-gray-400">View and manage all your deployed and licensed motion, media, and sonic content within the Fruitful Global network.</p>
                <div id="licensesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Licenses will be loaded here -->
                    <p class="text-center text-gray-400">Loading licenses...</p>
                </div>
            </div>

            <div class="panel">
                <h3><i class="fas fa-handshake mr-2"></i> Royalty License Agreements</h3>
                <p class="mb-4 text-gray-400">Review and sign your royalty agreements with Fruitful Global via SecureSignâ„¢.</p>
                <div id="royaltyAgreementsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Royalty agreements will be loaded here -->
                    <p class="text-center text-gray-400">Loading agreements...</p>
                </div>
            </div>
        </section>

        <!-- Analytics View -->
        <section id="analytics-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-chart-line mr-2"></i> Performance Analytics</h3>
                <p class="mb-4 text-gray-400">Insights into your deployed content and overall platform engagement.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container">
                        <canvas id="deploymentTrendsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="royaltyDistributionChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h4>User Engagement Metrics</h4>
                    <div class="chart-container">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- API Keys View -->
        <section id="api-keys-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-key mr-2"></i> Consolidated API Key Index (Fruitful Global)</h3>
                <p class="mb-4 text-gray-400">This document provides a comprehensive list of all API keys and credentials identified across your provided canvases and chat interactions. It explicitly lists every canvas where each key was embedded or mentioned.</p>

                <div class="security-note">
                    <strong>Important Security Note:</strong> Directly embedding API keys and sensitive credentials in client-side HTML or JavaScript is generally not recommended for production environments. This exposes your keys, making them vulnerable to misuse. For deployed applications, it is strongly advised to use a secure backend server to proxy your API requests and manage these keys via environment variables or a dedicated secrets management system.
                </div>

                <table class="api-key-table">
                    <thead>
                        <tr>
                            <th>API/Service</th>
                            <th>Key/Credential Details</th>
                            <th>Embedded Locations</th>
                        </tr>
                    </thead>
                    <tbody id="apiKeysTableBody">
                        <!-- API keys will be loaded here -->
                        <tr><td colspan="3" class="text-center text-gray-400">Loading API keys...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings View -->
        <section id="settings-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-cog mr-2"></i> My Settings</h3>

                <!-- Settings Navigation -->
                <div class="flex border-b border-gray-700 mb-6">
                    <button class="settings-tab-btn active" data-settings-tab="profile">Profile</button>
                    <button class="settings-tab-btn" data-settings-tab="preferences">Content Preferences</button>
                    <button class="settings-tab-btn" data-settings-tab="security">Security</button>
                    <button class="settings-tab-btn" data-settings-tab="domains">Domain & Cloud Services</button>
                </div>

                <!-- Profile Sub-view -->
                <div id="settings-profile" class="settings-sub-view">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Profile</h4>
                        <div class="form-control">
                            <label for="displayName">Display Name</label>
                            <input type="text" id="displayName" value="">
                        </div>

                        <div class="form-control">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="">
                        </div>

                        <button class="form-action-button" onclick="saveUserProfile()">Update Profile</button>
                    </section>
                </div>

                <!-- Content Preferences Sub-view -->
                <div id="settings-preferences" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Content Preferences</h4>
                        <div class="form-control">
                            <label for="defaultRegion">Default Deployment Region</label>
                            <select id="defaultRegion">
                                <option value="Global Stream">Global Stream</option>
                                <option value="Local Distribution">Local Distribution</option>
                                <option value="Event Capture">Event Capture (Pop-up)</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label for="autoClaimSetting">Auto-Enable ClaimRootâ„¢ on Save?</label>
                            <select id="autoClaimSetting">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>

                        <button class="form-action-button" onclick="saveContentPreferences()">Save Preferences</button>
                    </section>
                </div>

                <!-- Security Sub-view -->
                <div id="settings-security" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Security</h4>
                        <div class="form-control">
                            <label for="password">Change Password</label>
                            <input type="password" id="password" placeholder="New Password">
                        </div>

                        <div class="form-control">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm Password">
                        </div>

                        <button class="form-action-button" onclick="showCustomModal('Password Updated!', 'Your password has been changed securely. (Simulation)')">Update Password</button>
                    </section>
                </div>

                <!-- Domain & Cloud Services Sub-view (NEW) -->
                <div id="settings-domains" class="settings-sub-view hidden">
                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>DNS Zone Management (Cloudflare Integrated)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your domain's DNS records (A, CNAME, MX, TXT) with direct Cloudflare integration.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>Value</th>
                                    <th>TTL</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dnsRecordsTableBody">
                                <!-- DNS records will be loaded here -->
                                <tr><td colspan="5" class="text-center text-gray-400">Loading DNS records...</td></tr>
                            </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                             <input type="text" id="dnsRecordTypeInput" placeholder="DNS Type (e.g., A, CNAME, MX)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-xs max-w-[200px]">
                            <button class="form-action-button text-sm px-3 py-2 bg-purple-600 hover:bg-purple-700" id="explainDnsBtn">
                                <i class="fas fa-question-circle"></i> âœ¨ Explain DNS Type
                            </button>
                            <button class="form-action-button text-sm px-3 py-2" onclick="addDnsRecord()">
                                <i class="fas fa-plus mr-1"></i> Add Record
                            </button>
                        </div>
                        <p id="dnsExplainStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                        <div id="dnsExplanationOutput" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2 hidden" style="white-space: pre-wrap;"></div>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mb-6">
                        <h4>Domain Management (Vercel Integrated for Silent Deployments)</h4>
                        <p class="text-gray-400 text-sm mb-4">Manage your primary domains and add-on domains. Deployed silently via Vercel integration.</p>
                        <ul id="domainList" class="list-disc list-inside text-gray-200 mb-4">
                            <!-- Domains will be loaded here -->
                            <p class="text-center text-gray-400">Loading domains...</p>
                        </ul>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newDomainName" placeholder="Add New Domain (e.g., newbrand.com)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" onclick="addDomain()">
                                <i class="fas fa-plus mr-1"></i> Add Domain
                            </button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2">
                            <input type="text" id="newAddonDomainName" placeholder="Add Add-on Domain (e.g., addon.newbrand.com)" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <select id="addonDomainTarget" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                                <option value="">Select Primary Domain</option>
                            </select>
                            <button class="form-action-button text-sm px-3 py-2" onclick="addAddonDomain()">
                                <i class="fas fa-plus mr-1"></i> Add Add-on
                            </button>
                        </div>
                        <button class="form-action-button mt-4 bg-blue-600 hover:bg-blue-700" onclick="showCustomModal('Silent Deploy Initiated', 'Initiating silent deployment across Cloudflare and Vercel... (Simulation)')">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Deploy in Silence
                        </button>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700">
                        <h4>Email Accounts (Powered by Zoho Mail)</h4>
                        <p class="text-gray-400 text-sm mb-4">Create and manage email accounts for your domains.</p>
                        <table class="api-key-table mb-4">
                            <thead>
                                <tr>
                                    <th>Email Address</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="emailAccountsTableBody">
                                <!-- Email accounts will be loaded here -->
                                <tr><td colspan="3" class="text-center text-gray-400">Loading email accounts...</td></tr>
                            </tbody>
                        </table>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="newEmailPrefix" placeholder="New email (e.g., info)" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <span class="text-gray-200">@</span>
                            <input type="text" id="newEmailDomain" placeholder="yourdomain.com" value="sonicgrid.faa.zone" class="w-1/3 p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                            <button class="form-action-button text-sm px-3 py-2" id="createEmailBtn">
                                <i class="fas fa-plus mr-1"></i> Create Email
                            </button>
                        </div>
                        <p id="emailDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </section>

                    <section class="panel bg-gray-900 border border-gray-700 mt-8">
                        <h4 class="text-red-400 mb-4">Company Infrastructure Setup & Details</h4>
                        <p class="text-gray-300 mb-4">Access the comprehensive setup details for any company. Select a company below to reveal its granular configurations. **No troubleshooting or helpline needed**.</p>
                        
                        <div id="settingsCompanySelectionGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                            <!-- Company selection cards for settings will be rendered here -->
                            <p class="text-center text-gray-400 col-span-full">Loading company data...</p>
                        </div>

                        <div id="settingsCompanyDetailsOutput" class="company-details-section hidden">
                            <!-- Dynamic company details will be rendered here when a company is selected -->
                        </div>
                    </section>

                </div>

                <p class="text-gray-500 text-sm mt-4">All changes are synced to your Fruitful Global vault and stored with encrypted ClaimRoot credentials.</p>
            </div>
        </section>

        <!-- Login View -->
        <section id="login-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-sign-in-alt mr-2"></i> Sign In to SonicNestâ„¢</h3>
                <form id="loginForm">
                    <div class="form-control">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" value="sonic.user@example.com" required>
                    </div>
                    <div class="form-control">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="password123" required>
                    </div>
                    <button type="submit" class="form-action-button">Login</button>
                    <p class="text-gray-500 text-sm mt-4">Don't have an account? <a href="#signup" class="text-blue-500 hover:underline" onclick="showView('signup')">Sign Up</a></p>
                </form>
            </div>
        </section>

        <!-- Sign Up View -->
        <section id="signup-view" class="view view-hidden">
            <div class="panel">
                <h3><i class="fas fa-user-plus mr-2"></i> Join SonicNestâ„¢</h3>
                <form id="signupForm">
                    <div class="form-control">
                        <label for="signupName">Display Name</label>
                        <input type="text" id="signupName" placeholder="Your Display Name" required>
                    </div>
                    <div class="form-control">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-control">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div class="form-control">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <button type="submit" class="form-action-button">Sign Up</button>
                    <p class="text-gray-500 text-sm mt-4">Already have an account? <a href="#login" class="text-blue-500 hover:underline" onclick="showView('login')">Sign In</a></p>
                </form>
            </div>
        </section>
    </main>

    <!-- Template Preview Modal -->
    <div id="templatePreviewModal" class="custom-modal-overlay">
        <div class="custom-modal-content max-w-4xl w-full h-auto" style="padding: 0; text-align: left;">
            <div class="template-preview-header">
                <h3 id="templatePreviewTitle"></h3>
                <button class="close-preview-btn" onclick="hideTemplatePreviewModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <iframe id="templatePreviewFrame" class="template-preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
                <p id="templatePreviewDescription" class="text-gray-400 text-sm mt-2"></p>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="useTemplateNewProjectBtn"><i class="fas fa-plus-circle mr-2"></i> Use in New Project</button>
                    <button class="btn-secondary" id="useTemplateScrollBuilderBtn"><i class="fas fa-tools mr-2"></i> Use in Content Builder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simplify Agreement Modal -->
    <div id="simplifyAgreementModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="simplifyAgreementTitle">Simplified Agreement</h3>
                <button class="close-preview-btn" onclick="hideSimplifyAgreementModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="simplifiedAgreementText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideSimplifyAgreementModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Idea Modal -->
    <div id="projectIdeaModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="projectIdeaModalTitle">AI Project Idea</h3>
                <button class="close-preview-btn" onclick="hideProjectIdeaModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">Review the AI-generated idea below:</p>
                <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                    <p class="text-gray-200 mb-2"><strong>Project Name:</strong> <span id="ideaProjectName"></span></p>
                    <p class="text-gray-200 mb-2"><strong>Description:</strong> <span id="ideaProjectDescription"></span></p>
                    <p class="text-gray-200"><strong>Suggested Template:</strong> <span id="ideaSuggestedTemplate"></span></p>
                </div>
                <div class="template-preview-actions">
                    <button class="btn-primary" id="applyProjectIdeaBtn"><i class="fas fa-check-circle mr-2"></i> Apply Idea to Form</button>
                    <button class="btn-secondary" onclick="hideProjectIdeaModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Summary Modal (NEW) -->
    <div id="projectSummaryModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="projectSummaryTitle">Project Summary</h3>
                <button class="close-preview-btn" onclick="hideProjectSummaryModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body">
                <p id="projectSummaryText" class="text-gray-700 text-left whitespace-pre-wrap leading-relaxed"></p>
                <div class="template-preview-actions">
                    <button class="btn-secondary" onclick="hideProjectSummaryModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Draft Modal (NEW) -->
    <div id="emailDraftModal" class="custom-modal-overlay view-hidden">
        <div class="custom-modal-content max-w-xl w-full h-auto">
            <div class="template-preview-header">
                <h3 id="emailDraftTitle">Draft Email</h3>
                <button class="close-preview-btn" onclick="hideEmailDraftModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="template-preview-body text-left">
                <p class="text-gray-400 text-sm mb-2">To: <span id="emailDraftTo"></span></p>
                <div class="form-control">
                    <label for="emailPurposeInput" class="text-white text-sm mb-1">Purpose of Email</label>
                    <input type="text" id="emailPurposeInput" placeholder="e.g., Welcome new user, Support query, Marketing announcement" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white text-sm">
                </div>
                <button type="button" id="generateEmailDraftBtn" class="form-action-button text-xs px-3 py-2">
                    âœ¨ Generate Draft
                </button>
                <p id="emailDraftStatus" class="text-xs text-gray-400 mt-1 hidden"></p>
                <textarea id="generatedEmailDraftOutput" rows="10" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white mt-2" placeholder="Your AI-generated email draft will appear here..." readonly></textarea>
                <div class="template-preview-actions">
                    <button class="btn-primary" onclick="document.execCommand('copy'); showCustomModal('Email Copied', 'Email draft copied to clipboard!', true);">Copy to Clipboard</button>
                    <button class="btn-secondary" onclick="hideEmailDraftModal()">Close</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Custom Modal for Alerts (standard app alerts) -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-xl text-center max-w-sm">
            <p id="customModalMessage"></p>
        </div>
    </div>

    <script>
        // --- Centralized Data Store for CodeNest Dashboard (now primarily for UI state and static mock data if not in Firestore) ---
        // __app_id is defined in the script import section in the head
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const appData = {
            dashboard: {
                systemHealth: { // Mock data for chart, can be replaced by Firestore later
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Content Deployment Rate (%)',
                        data: [90, 92, 95, 96, 94, 97, 96, 98, 97, 99, 98, 99],
                        borderColor: 'rgba(48, 209, 88, 0.8)', // Green
                        backgroundColor: 'rgba(48, 209, 88, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Media Stream Latency (ms)',
                        data: [120, 110, 100, 95, 105, 90, 85, 80, 75, 70, 65, 60],
                        borderColor: 'rgba(255, 59, 48, 0.8)', // Red
                        backgroundColor: 'rgba(255, 59, 48, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            },
            projects: [], // Will be populated from Firestore
            projectLoadIndex: 0,
            projectsPerLoad: 12, // Number of projects to load at once
            licenses: [], // Populated from Firestore
            templates: [ // Static templates, can be moved to Firestore if desired
                { name: 'Interactive Audio Visualizer', description: 'Template for dynamic audio visual experiences with real-time sound reactivity.', link: '#', icon: 'fas fa-wave-square',
                    htmlCode: `
<div style="background-color: #1d1d1f; color: #f5f5f7; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #ff3b30; margin-bottom: 1rem;">Sonic Gridâ„¢ | <span style="color: #0071e3;">Waveform</span></h1>
    <h2 style="font-size: 1.2rem; color: #a0a0a5; margin-bottom: 1.5rem;">Dynamic Audio Experiences</h2>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #b0b0b0;">Visualize your sound with captivating real-time graphics. Perfect for music artists and immersive installations.</p>
    <audio controls style="width: 100%; margin-top: 1.5rem;"><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg"></audio>
</div>
                    `
                },
                { name: 'Video Showcase Portal', description: 'Showcase high-definition video content with integrated metadata and streaming optimization.', link: '#', icon: 'fas fa-video',
                    htmlCode: `
<div style="background-color: #1d1d1f; color: #f5f5f7; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #ff3b30; margin-bottom: 1rem;">VisualFlowâ„¢ | <span style="color: #0071e3;">Showreel</span></h1>
    <h2 style="font-size: 1.2rem; color: #a0a0a5; margin-bottom: 1.5rem;">Your Premium Video Showcase</h2>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #b0b0b0;">Present your video projects with stunning clarity and seamless playback on any device.</p>
    <video controls style="width: 100%; margin-top: 1.5rem;"><source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4"></video>
</div>
                    `
                },
                { name: 'Motion Graphics Explainer', description: 'Create engaging animated explainers with synchronized audio narration.', link: '#', icon: 'fas fa-film',
                    htmlCode: `
<div style="background-color: #1d1d1f; color: #f5f5f7; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #ff3b30; margin-bottom: 1rem;">Mationaâ„¢ | <span style="color: #0071e3;">Explain</span></h1>
    <h2 style="font-size: 1.2rem; color: #a0a0a5; margin-bottom: 1.5rem;">Animate Your Ideas</h2>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #b0b0b0;">Transform complex concepts into clear, engaging animated stories with integrated voiceovers.</p>
    <iframe width="100%" height="315" src="https://www.youtube.com/embed/dQw4w9WgXcQ?controls=0" frameborder="0" allowfullscreen style="margin-top: 1.5rem;"></iframe>
</div>
                    `
                },
                { name: 'Soundscape Generator', description: 'Develop immersive ambient soundscapes and procedural audio environments.', link: '#', icon: 'fas fa-headphones',
                    htmlCode: `
<div style="background-color: #1d1d1f; color: #f5f5f7; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center;">
    <h1 style="font-size: 1.8rem; font-weight: 800; color: #ff3b30; margin-bottom: 1rem;">AudioPulseâ„¢ | <span style="color: #0071e3;">Genesis</span></h1>
    <h2 style="font-size: 1.2rem; color: #a0a0a5; margin-bottom: 1.5rem;">Create Your World of Sound</h2>
    <p style="font-size: 0.95rem; line-height: 1.5; color: #b0b0b0;">Design endless dynamic sound environments for games, VR, or meditation apps.</p>
    <button style="background-color: #0071e3; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;">Start Composing</button>
</div>
                    `
                },
            ],
            analytics: { // Mock data for charts, will remain static for this example
                deploymentTrends: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Media Content Deployed',
                        data: [150, 180, 220, 250, 230, 290],
                        borderColor: 'rgba(0, 113, 227, 0.8)',
                        backgroundColor: 'rgba(0, 113, 227, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                royaltyDistribution: {
                    labels: ['Audio Content', 'Video Content', 'Motion Graphics', 'Interactive Media', 'Other'],
                    datasets: [{
                        data: [35, 30, 20, 10, 5],
                        backgroundColor: ['#ff3b30', '#0071e3', '#30d158', '#f59e0b', '#6e6e73'],
                        hoverOffset: 4
                    }]
                },
                userActivity: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Users (Daily Average)',
                        data: [800, 950, 900, 1050, 1100, 600, 450],
                        borderColor: 'rgba(48, 209, 88, 0.8)',
                        backgroundColor: 'rgba(48, 209, 88, 0.1)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Stream Hours (Thousands)',
                        data: [25, 30, 28, 35, 38, 15, 10],
                        borderColor: 'rgba(255, 59, 48, 0.8)',
                        backgroundColor: 'rgba(255, 59, 48, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                }
            },
            apiKeys: [], // Populated from Firestore
            royaltyAgreements: [], // Populated from Firestore
            colors: { // Dynamic colors based on theme
                primary: null, secondary: null, textDark: null, borderColorDark: null, accentGold: null
            },
            dnsRecords: [], // Populated from Firestore
            emailAccounts: [], // Populated from Firestore
            domains: [], // Populated from Firestore
        };

        const sectorList = { // Static list of sectors for display
            "agriculture": { name: "ðŸŒ± Agriculture & Biotech" },
            "fsf": { name: "ðŸ¥¦ Food, Soil & Farming" },
            "banking": { name: "ðŸ¦ Banking & Finance" },
            "creative": { name: "ðŸ–‹ï¸ Creative Tech" },
            "logistics": { name: "ðŸ“¦ Logistics & Packaging" },
            "education-ip": { name: "ðŸ“š Education & IP" },
            "fashion": { name: "âœ‚ Fashion & Identity" },
            "gaming": { name: "ðŸŽ® Gaming & Simulation" },
            "health": { name: "ðŸ§  Health & Hygiene" },
            "housing": { name: "ðŸ—ï¸ Housing & Infrastructure" },
            "justice": { name: "âš– Justice & Ethics" },
            "knowledge": { name: "ðŸ“– Knowledge & Archives" },
            "micromesh": { name: "â˜° Micro-Mesh Logistics" },
            "media": { name: "ðŸŽ¬ Motion, Media & Sonic" }, // This is the target sector
            "nutrition": { name: "âœ¿ Nutrition & Food Chain" },
            "ai-logic": { name: "ðŸ§  AI, Logic & Grid" },
            "packaging": { name: "ðŸ“¦ Packaging & Materials" },
            "quantum": { name: "âœ´ï¸ Quantum Protocols" },
            "ritual": { name: "â˜¯ Ritual & Culture" },
            "saas": { name: "ðŸ”‘ SaaS & Licensing" },
            "trade": { name: "ðŸ§º Trade Systems" },
            "utilities": { name: "ðŸ”‹ Utilities & Energy" },
            "voice": { name: "ðŸŽ™ï¸ Voice & Audio" },
            "webless": { name: "ðŸ“¡ Webless Tech & Nodes" },
            "nft": { name: "ðŸ” NFT & Ownership" },
            "education-youth": { name: "ðŸŽ“ Education & Youth" },
            "zerowaste": { name: "â™»ï¸ Zero Waste" },
            "professional": { name: "ðŸ§¾ Professional Services" },
            "payroll-mining": { name: "ðŸª™ Payroll Mining & Accounting" },
            "mining": { name: "â›ï¸ Mining & Resources" },
            "wildlife": { name: "ðŸ¦ Wildlife & Habitat" },
            "admin-panel": { name: "âš™ï¸ Admin Panel" }
        };

        // This will be loaded from Firestore
        let allSectorsData = {};
        let companyData = {};


        // --- Utility Functions ---

        // Global functions must be attached to window to be called by inline onclicks
        window.showCustomModal = function(title, message, autoDismiss = true) {
            const modal = document.getElementById('customModal');
            const modalMessage = modal.querySelector('p');
            if (modal && modalMessage) {
                modalMessage.innerHTML = `<strong>${title}</strong><br>${message}`;
                modal.classList.remove('hidden');
                if (autoDismiss) {
                    setTimeout(() => {
                        window.hideCustomModal();
                    }, 3000);
                }
            }
        };

        window.hideCustomModal = function() {
            document.getElementById('customModal')?.classList.add('hidden');
        };

        // --- Checkout Flow Functions ---
        window.showCheckoutStep = function(step) {
            // Hide all checkout steps
            document.querySelectorAll('[id^="checkout-step-"]').forEach(el => {
                el.classList.add('hidden');
            });
            // Show the requested step
            document.getElementById(`checkout-step-${step}`)?.classList.remove('hidden');
            // Reset payment status message
            document.getElementById('paymentStatus')?.classList.add('hidden');
            document.getElementById('orderStatus')?.classList.add('hidden');
        };

        window.processPayment = function() {
            const paymentStatus = document.getElementById('paymentStatus');
            const orderStatus = document.getElementById('orderStatus');
            paymentStatus.textContent = "Processing payment...";
            paymentStatus.classList.remove('hidden');
            
            // Simulate payment processing
            setTimeout(() => {
                paymentStatus.textContent = "Payment successful! Initiating ClaimRootâ„¢ license...";
                paymentStatus.classList.add('text-green-400');
                paymentStatus.classList.remove('text-red-400'); // Ensure it's green
                window.showCheckoutStep(3); // Move to confirmation step
                orderStatus.textContent = "Status: ClaimRootâ„¢ License Activated!";
                orderStatus.classList.remove('hidden');
            }, 2000);
        };

        window.resetCheckout = function() {
            window.showCheckoutStep(1); // Reset to first step
            document.getElementById('cardNumber').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('cvc').value = '';
            document.getElementById('paymentStatus').classList.add('hidden');
            document.getElementById('orderStatus').classList.add('hidden');
            document.getElementById('paymentStatus').classList.remove('text-green-400');
            document.getElementById('paymentStatus').classList.add('text-red-400'); // Reset to red for future errors
            showView('dashboard'); // Optionally go back to dashboard
        };


        // --- View Management (Client-side Router) ---
        let currentChartInstances = {}; // To store Chart.js instances for destruction

        function showView(viewId) {
            // Update URL hash
            window.location.hash = viewId;

            // Hide all views
            document.querySelectorAll('.main-content .view').forEach(view => {
                view.classList.add('view-hidden');
            });
            // Show the requested view
            document.getElementById(`${viewId}-view`)?.classList.remove('view-hidden');

            // Update active state in sidebar nav
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                if (link.getAttribute('data-view') === viewId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Handle view-specific rendering
            renderViewContent(viewId);
        }

        function renderViewContent(viewId) {
            // Destroy existing charts to prevent canvas errors on view change
            for (const chartId in currentChartInstances) {
                if (currentChartInstances[chartId]) {
                    currentChartInstances[chartId].destroy();
                    currentChartInstances[chartId] = null;
                }
            }

            // Only render content if Firebase is ready (userId is set)
            if (window.getUserId() === 'loading' && viewId !== 'login' && viewId !== 'signup') {
                 console.log("Firebase not ready, deferring rendering for view:", viewId);
                 // Optionally show a loading message or spinner
                 return;
            }

            if (viewId === 'dashboard') {
                updateDashboardMetrics(); // This will fetch from Firestore
                renderSystemHealthChart();
            } else if (viewId === 'projects') {
                appData.projectLoadIndex = 0; // Reset load index when entering projects view
                renderProjects(); // This will fetch from Firestore
            } else if (viewId === 'ecosystem-map') {
                renderEcosystemMap(); // This will fetch from Firestore
            } else if (viewId === 'global-checkout') {
                window.showCheckoutStep(1); // Start checkout at step 1
            }
            else if (viewId === 'templates') {
                renderTemplates(); // Ensure templates are rendered (from appData or Firestore)
            } else if (viewId === 'licenses') {
                renderLicenses(); // This will fetch from Firestore
                renderRoyaltyAgreements(); // Render new section from Firestore
            } else if (viewId === 'analytics') {
                renderAnalyticsCharts();
            } else if (viewId === 'api-keys') {
                renderApiKeysTable(); // This will fetch from Firestore
            } else if (viewId === 'settings') {
                loadSettings(); // This will fetch from Firestore
                showSettingsTab('profile'); // Default to profile tab when entering settings
            } else if (viewId === 'login' || viewId === 'signup') {
                // Clear forms on view change
                document.getElementById('loginForm')?.reset();
                document.getElementById('signupForm')?.reset();
            }
        }

        // Centralized function to render all Firestore-backed data when authenticated
        async function renderAllFirestoreData() {
            // Fetch public data first
            const publicDataPath = `artifacts/${APP_ID}/public/data`;
            const companiesRef = await window.firestoreGetCollection(`${publicDataPath}/companies`);
            companyData = companiesRef.reduce((acc, company) => {
                acc[company.id] = company;
                return acc;
            }, {});
            console.log("Loaded public company data:", companyData);

            const allSectorsRef = await window.firestoreGetCollection(`${publicDataPath}/sectors`);
            allSectorsData = allSectorsRef.reduce((acc, sector) => {
                acc[sector.id] = sector;
                return acc;
            }, {});
            console.log("Loaded public sector data:", allSectorsData);

            // Set up real-time listeners for dashboard metrics
            const dashboardDocPath = `artifacts/${APP_ID}/dashboardMetrics`;
            window.firestoreOnDocumentSnapshot(dashboardDocPath, 'metrics', (data) => {
                if (data) {
                    document.getElementById('totalProjectsCount').textContent = (data.totalProjects || 0).toLocaleString();
                    document.getElementById('liveScrollsCount').textContent = (data.liveScrolls || 0).toLocaleString();
                    document.getElementById('monthlyRoyalties').textContent = `$${(data.monthlyRoyalties || 0).toFixed(2)}`;
                } else {
                     // If document doesn't exist, initialize it
                     window.firestoreSetDoc(dashboardDocPath, 'metrics', {
                        totalProjects: 1250,
                        liveScrolls: 980,
                        monthlyRoyalties: 8750.20
                    });
                }
            });

            // Set up real-time listener for user projects
            const userProjectsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/projects`;
            window.firestoreOnCollectionSnapshot(userProjectsPath, (projects) => {
                appData.projects = projects.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity)); // Sort by most recent
                renderProjects(); // Re-render projects view when data changes
            });

            // Set up real-time listener for user licenses
            const userLicensesPath = `artifacts/${APP_ID}/users/${window.getUserId()}/licenses`;
            window.firestoreOnCollectionSnapshot(userLicensesPath, (licenses) => {
                appData.licenses = licenses;
                if (document.getElementById('licenses-view')?.classList.contains('view-hidden') === false) {
                    renderLicenses(); // Re-render licenses view if currently active
                }
            });

            // Set up real-time listener for user royalty agreements
            const userRoyaltyAgreementsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/royaltyAgreements`;
            window.firestoreOnCollectionSnapshot(userRoyaltyAgreementsPath, (agreements) => {
                appData.royaltyAgreements = agreements;
                if (document.getElementById('licenses-view')?.classList.contains('view-hidden') === false) {
                    renderRoyaltyAgreements(); // Re-render royalty agreements if currently active
                }
            });

            // Set up real-time listener for API keys (consider them private to user for now)
            const userApiKeysPath = `artifacts/${APP_ID}/users/${window.getUserId()}/apiKeys`;
            window.firestoreOnCollectionSnapshot(userApiKeysPath, (apiKeys) => {
                appData.apiKeys = apiKeys;
                if (document.getElementById('api-keys-view')?.classList.contains('view-hidden') === false) {
                    renderApiKeysTable(); // Re-render API keys table if currently active
                }
            });

            // Set up real-time listener for DNS records
            const publicDnsRecordsPath = `artifacts/${APP_ID}/public/data/dnsRecords`;
            window.firestoreOnCollectionSnapshot(publicDnsRecordsPath, (records) => {
                appData.dnsRecords = records;
                if (document.getElementById('settings-domains')?.classList.contains('hidden') === false) {
                    renderDnsRecords();
                }
            });

            // Set up real-time listener for domains
            const publicDomainsPath = `artifacts/${APP_ID}/public/data/domains`;
            window.firestoreOnCollectionSnapshot(publicDomainsPath, (domains) => {
                appData.domains = domains;
                if (document.getElementById('settings-domains')?.classList.contains('hidden') === false) {
                    renderDomains();
                }
            });

            // Set up real-time listener for email accounts
            const publicEmailAccountsPath = `artifacts/${APP_ID}/public/data/emailAccounts`;
            window.firestoreOnCollectionSnapshot(publicEmailAccountsPath, (accounts) => {
                appData.emailAccounts = accounts;
                if (document.getElementById('settings-domains')?.classList.contains('hidden') === false) {
                    renderEmailAccounts();
                }
            });
            // Re-render the current view after Firebase data is loaded
            renderViewContent(window.location.hash.substring(1) || 'dashboard');
        }

        // --- Dashboard Specific Logic ---
        function updateDashboardMetrics() {
            // Data is now updated by the onSnapshot listener in renderAllFirestoreData
            // Initial values are set by Firestore if document doesn't exist
        }

        function renderSystemHealthChart() {
            const ctx = document.getElementById('systemHealthChart')?.getContext('2d');
            if (ctx) {
                currentChartInstances.systemHealthChart = new Chart(ctx, {
                    type: 'line',
                    data: appData.dashboard.systemHealth,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white',
                                    font: { family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' },
                                grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // --- Projects View Logic ---
        function renderProjects(append = false) {
            const projectsListContainer = document.getElementById('projectsList');
            if (!projectsListContainer) return;

            if (!append) {
                projectsListContainer.innerHTML = ''; // Clear existing projects unless appending
                appData.projectLoadIndex = 0;
            }

            const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
            const filterStatus = document.getElementById('projectFilterStatus')?.value || 'all';

            // Apply search and filter to all projects first
            const filteredProjects = appData.projects.filter(project => {
                const matchesSearch = project.name.toLowerCase().includes(searchTerm) || project.id.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || project.status === filterStatus;
                return matchesSearch && matchesStatus;
            });

            // Determine which projects to render based on load index
            const projectsToRender = filteredProjects.slice(appData.projectLoadIndex, appData.projectLoadIndex + appData.projectsPerLoad);

            if (projectsToRender.length === 0 && appData.projectLoadIndex === 0) {
                 projectsListContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">No projects found. Start a new project!</p>';
            }

            projectsToRender.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                projectCard.innerHTML = `
                    <h4 class="mb-2">${project.name}</h4>
                    <p><strong>ID:</strong> ${project.id}</p>
                    <p><strong>Region:</strong> ${project.region}</p>
                    <p><strong>Royalty:</strong> ${project.royalty}</p>
                    <p><strong>Last Activity:</strong> ${new Date(project.lastActivity).toLocaleDateString()}</p>
                    <span class="project-status status-${project.status}">${project.status.toUpperCase()}</span>
                    <div class="project-actions">
                        <button onclick="window.openProjectInEditor('${project.id}')">
                            <i class="fas fa-edit mr-1"></i> Editor
                        </button>
                        <button class="secondary" onclick="window.showCustomModal('Action', 'Viewing live content for ${project.name} (ID: ${project.id})...')">
                            <i class="fas fa-globe mr-1"></i> Live
                        </button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2" onclick="window.summarizeProject('${project.id}', this)">
                            <i class="fas fa-file-alt"></i> âœ¨ Summarize Project
                        </button>
                        <p id="projectSummaryStatus-${project.id}" class="text-xs text-gray-400 mt-1 hidden"></p>
                    </div>
                `;
                projectsListContainer.appendChild(projectCard);
            });

            appData.projectLoadIndex += projectsToRender.length;

            const loadMoreButton = document.getElementById('loadMoreProjects');
            if (loadMoreButton) {
                if (appData.projectLoadIndex >= filteredProjects.length) {
                    loadMoreButton.classList.add('view-hidden'); // Hide if no more projects
                } else {
                    loadMoreButton.classList.remove('view-hidden');
                }
            }
        }

        // Function to open a project in the integrated editor (NEW)
        let currentEditingProjectId = null;
        window.openProjectInEditor = function(projectId) {
            const project = appData.projects.find(p => p.id === projectId);
            if (project) {
                currentEditingProjectId = projectId; // Store the ID of the project being edited
                document.getElementById('editorHtmlCssCode').value = project.htmlCode || '';
                document.getElementById('currentProjectEditName').textContent = `${project.name} Editor`;
                window.updateEditorPreview(); // Update the preview with the loaded code
                showView('editor-workspace'); // Switch to the editor view
            } else {
                window.showCustomModal('Project Not Found', `Could not find project with ID: ${projectId}`);
            }
        };

        // Function to save project changes from editor to Firestore
        window.saveProjectFromEditor = async function() {
            if (!currentEditingProjectId) {
                window.showCustomModal('Error', 'No project selected for saving.', true);
                return;
            }
            const htmlCode = document.getElementById('editorHtmlCssCode').value;
            const projectDocPath = `artifacts/${APP_ID}/users/${window.getUserId()}/projects`;
            
            try {
                await window.firestoreUpdateDoc(projectDocPath, currentEditingProjectId, { htmlCode: htmlCode, lastActivity: new Date().toISOString() });
                window.showCustomModal('Project Saved!', 'Project content saved successfully!', true);
            } catch (error) {
                window.showCustomModal('Save Error', `Failed to save project: ${error.message}`, true);
            }
        };

        // Function to deploy project (simulated)
        window.deployProjectFromEditor = async function() {
            if (!currentEditingProjectId) {
                window.showCustomModal('Error', 'No project selected for deployment.', true);
                return;
            }
            const projectDocPath = `artifacts/${APP_ID}/users/${window.getUserId()}/projects`;
            try {
                // Update project status to 'live' and update live scrolls count
                await window.firestoreUpdateDoc(projectDocPath, currentEditingProjectId, { status: 'live', lastActivity: new Date().toISOString() });
                
                // Update dashboard metrics (increment liveScrolls)
                const dashboardDocPath = `artifacts/${APP_ID}/dashboardMetrics`;
                const metrics = await window.firestoreGetDoc(dashboardDocPath, 'metrics');
                if (metrics) {
                    await window.firestoreUpdateDoc(dashboardDocPath, 'metrics', { liveScrolls: (metrics.liveScrolls || 0) + 1 });
                } else {
                    await window.firestoreSetDoc(dashboardDocPath, 'metrics', { liveScrolls: 1, totalProjects: appData.projects.length, monthlyRoyalties: 0 });
                }

                window.showCustomModal('Project Deployed!', 'Project successfully deployed to Fruitful Global! (Simulation)', true);
            } catch (error) {
                window.showCustomModal('Deployment Error', `Failed to deploy project: ${error.message}`, true);
            }
        };


        // Function to summarize a project (NEW FEATURE)
        window.summarizeProject = async function(projectId, buttonElement) {
            const project = appData.projects.find(p => p.id === projectId);
            if (!project) {
                window.showCustomModal('Error', 'Project not found for summarization.');
                return;
            }

            const statusElementId = `projectSummaryStatus-${projectId}`;
            const statusElement = document.getElementById(statusElementId);

            const prompt = `Summarize the following project details concisely (max 80 words):
            Project Name: ${project.name}
            ID: ${project.id}
            Status: ${project.status}
            Region: ${project.region}
            Royalty: ${project.royalty}
            Last Activity: ${new Date(project.lastActivity).toLocaleDateString()}

            Highlight the project's current state and main purpose.`;
            
            // Using a temporary invisible element for the target, as the output goes to a modal
            const tempOutputDiv = document.createElement('div');
            tempOutputDiv.id = `tempProjectSummaryOutput-${projectId}`;
            tempOutputDiv.style.display = 'none'; // Keep it hidden
            document.body.appendChild(tempOutputDiv);

            const summaryText = await window.callGeminiAPI(prompt, tempOutputDiv.id, statusElementId, buttonElement, 'Summarize Project');

            if (summaryText) {
                window.showProjectSummaryModal(`${project.name} Summary`, summaryText);
            } else {
                window.showCustomModal('Summarization Failed', 'Could not generate project summary. Please try again.');
            }
            document.body.removeChild(tempOutputDiv); // Clean up the temporary element
        };

        // Event listeners for project search/filter
        document.getElementById('projectSearch')?.addEventListener('input', () => renderProjects(false));
        document.getElementById('projectFilterStatus')?.addEventListener('change', () => renderProjects(false));
        document.getElementById('loadMoreProjects')?.addEventListener('click', () => renderProjects(true));


        // --- Gemini API Call Function ---
        window.callGeminiAPI = async function(prompt, targetElementId, statusElementId, buttonElement, type, parseJson = false) {
            const targetElement = document.getElementById(targetElementId);
            const statusElement = document.getElementById(statusElementId);
            
            if (!targetElement || !statusElement || !buttonElement) {
                console.error("Missing target, status element, or button element for Gemini API call.");
                return null; // Return null on error
            }

            statusElement.textContent = "Generating...";
            statusElement.classList.remove('hidden');
            if (targetElementId !== 'tempSimplifyOutput' && !targetElementId.startsWith('tempProjectSummaryOutput')) { // Don't hide the temp div used for simplification or project summary
                targetElement.classList.add('hidden'); // Hide output until ready
            }
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<span class="inline-block border-4 border-t-blue-500 border-gray-300 rounded-full w-5 h-5 animate-spin"></span>`; // Show spinner

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    
                    if (parseJson) {
                        try {
                            const jsonResult = JSON.parse(text);
                            statusElement.textContent = "Generation complete!";
                            return jsonResult; // Return the parsed JSON object
                        } catch (jsonError) {
                            console.error("Failed to parse JSON from Gemini API:", jsonError);
                            statusElement.textContent = "Error: Could not parse AI response as JSON.";
                            return null;
                        }
                    } else {
                        // Check if the target is a textarea (has .value) or a general element (use .innerHTML)
                        if (targetElement.tagName === 'TEXTAREA' || targetElement.tagName === 'INPUT') {
                            targetElement.value = text;
                        } else {
                            targetElement.innerHTML = text; // For div or p tags
                        }
                        targetElement.classList.remove('hidden'); // Show output
                        statusElement.textContent = "Generation complete!";
                        return text; // Return the raw text
                    }
                } else {
                    statusElement.textContent = "Error: No content generated by AI.";
                    console.error("Gemini API returned an unexpected structure or no content:", result);
                    return null;
                }
            } catch (error) {
                statusElement.textContent = "Error: API call failed.";
                console.error("Error calling Gemini API:", error);
                return null;
            } finally {
                buttonElement.disabled = false;
                // Restore button text based on 'type' (from parameter)
                let originalButtonText = '';
                if (type === 'AI Generate') {
                    originalButtonText = 'AI Generate';
                } else if (type === 'Summarize Project') {
                    originalButtonText = 'Summarize Project';
                } else if (type === 'Simplify Agreement') {
                    originalButtonText = 'Simplify Agreement';
                } else if (type === 'Refine Code') {
                    originalButtonText = `Refine Code`;
                } else if (type === 'Explain Code') {
                    originalButtonText = `Explain Code`;
                } else if (type === 'Review Code') {
                    originalButtonText = `Review Code`;
                } else if (type === 'Generate Headline') {
                    originalButtonText = `Generate Headline`;
                } else if (type === 'Generate CTA') {
                    originalButtonText = `Generate CTA`;
                } else if (type === 'Generate Section Content') {
                    originalButtonText = `Generate Section Content`;
                } else if (type === 'Rephrase/Improve') {
                    originalButtonText = `Rephrase/Improve`;
                } else if (type === 'Explain DNS Type') {
                    originalButtonText = 'Explain DNS Type';
                } else if (type === 'Draft Email') {
                    originalButtonText = 'Generate Draft';
                }
                else {
                    originalButtonText = 'Action'; // Fallback
                }
                
                buttonElement.innerHTML = `<i class="${buttonElement.querySelector('i')?.className || 'fas fa-magic'} mr-1"></i> âœ¨ ${originalButtonText}`; // Preserve icon
                setTimeout(() => statusElement.classList.add('hidden'), 3000); // Hide status after a few seconds
            }
        };


        // --- New Project Form Logic (with Gemini API Integration) ---
        document.getElementById('newProjectForm')?.addEventListener('submit', async function(event) {
            event.preventDefault();
            const projectName = document.getElementById('projectName').value;
            const templateName = document.getElementById('template').value; // Use templateName here
            const description = document.getElementById('description').value;
            const region = document.getElementById('region').value;
            const claim = document.getElementById('claim').value;

            // Get selected template's HTML content
            const selectedTemplate = appData.templates.find(t => t.name === templateName);
            let baseHtmlContent = '';
            if (selectedTemplate && selectedTemplate.htmlCode) {
                baseHtmlContent = selectedTemplate.htmlCode;
            } else {
                baseHtmlContent = `<div style="background-color: #1d1d1f; color: #f5f5f7; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center;"><h1>New Project: ${projectName}</h1><p>This is a new motion, media, or sonic project created from template: ${templateName}.</p></div>`;
            }

            const newProjectData = {
                name: projectName,
                template: templateName, // Store template name
                description: description,
                region: region,
                claimEnabled: claim === 'yes',
                status: 'draft',
                royalty: claim === 'yes' ? '7.5%' : 'N/A',
                lastActivity: new Date().toISOString(),
                htmlCode: baseHtmlContent,
                cssCode: '', // Initialize with empty CSS
                jsCode: '' // Initialize with empty JS
            };

            const userProjectsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/projects`;
            try {
                const newProjectId = await window.firestoreAddDoc(userProjectsPath, newProjectData);
                if (newProjectId) {
                    window.showCustomModal('Project Created!', `Your project "${projectName}" has been created (ID: ${newProjectId}). Status: Draft.`, true);
                    // Update dashboard metrics (total projects)
                    const dashboardDocPath = `artifacts/${APP_ID}/dashboardMetrics`;
                    const metrics = await window.firestoreGetDoc(dashboardDocPath, 'metrics');
                    if (metrics) {
                        await window.firestoreUpdateDoc(dashboardDocPath, 'metrics', { totalProjects: (metrics.totalProjects || 0) + 1 });
                    } else {
                         await window.firestoreSetDoc(dashboardDocPath, 'metrics', { totalProjects: 1, liveScrolls: 0, monthlyRoyalties: 0 });
                    }

                    this.reset(); // Clear form
                    showView('projects'); // Go to projects view
                } else {
                    window.showCustomModal('Error', 'Failed to create project in Firestore.', true);
                }
            } catch (error) {
                window.showCustomModal('Error', `Failed to create project: ${error.message}`, true);
            }
        });

        // Event listener for Generate Description Button
        document.getElementById('generateDescriptionBtn')?.addEventListener('click', async (event) => {
            const projectName = document.getElementById('projectName').value.trim();
            const templateSelect = document.getElementById('template');
            const templateType = templateSelect.options[templateSelect.selectedIndex]?.textContent || 'Generic Media'; // Get displayed text
            const region = document.getElementById('region').value;
            const button = event.currentTarget; // Get the button element

            if (!projectName) {
                window.showCustomModal('Input Required', 'Please enter a Project Name to generate a description.');
                return;
            }

            const prompt = `Generate a concise and engaging project description (max 100 words, 3-4 sentences) for a motion, media, or sonic content project named '${projectName}' of type '${templateType}' intended for a '${region}' deployment. Focus on creative and technical aspects, benefits, and key features.`;
            await window.callGeminiAPI(prompt, 'description', 'descriptionStatus', button, 'AI Generate');
        });

        // Event listener for Generate Project Idea Button
        document.getElementById('generateProjectIdeaBtn')?.addEventListener('click', async (event) => {
            const projectConcept = document.getElementById('projectConcept').value.trim();
            const button = event.currentTarget; // Get the button element
            const statusElement = document.getElementById('projectIdeaStatus');

            if (!projectConcept) {
                window.showCustomModal('Input Required', 'Please enter a high-level project concept to generate an idea.');
                return;
            }
            
            statusElement.textContent = "Generating project idea...";
            statusElement.classList.remove('hidden');

            const availableTemplates = appData.templates.map(t => t.name).join(', ');
            const prompt = `Generate a creative project name (max 5 words), a 3-4 sentence project description highlighting creative and technical benefits, and suggest one suitable template from the following list: ${availableTemplates}. The project is about: "${projectConcept}". Respond as a JSON object with keys: "projectName", "projectDescription", "suggestedTemplate".`;
            
            const aiIdea = await window.callGeminiAPI(prompt, 'hiddenIdeaOutput', 'projectIdeaStatus', button, 'AI Generate', true); // Use a hidden output element, parse JSON

            if (aiIdea) {
                window.showProjectIdeaModal(aiIdea.projectName, aiIdea.projectDescription, aiIdea.suggestedTemplate);
            } else {
                statusElement.textContent = "Failed to generate project idea. Please try again.";
            }
        });


        // --- Content Builder Form Logic (with Gemini API Integration) ---
        document.getElementById('scrollBuilderForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            window.showCustomModal('Content Compiled & Saved!', 'Your content has been compiled and saved to your workspace. It\'s now ready for deployment via Fruitful Global.');
            this.reset(); // Clear form
        });

        // Event listeners for Code Refinement Buttons
        document.getElementById('refineHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('htmlExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('htmlReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to refine.'); return; }
            const prompt = `Refine the following HTML code for better accessibility, semantic structure, and performance, specifically for motion, media, or sonic content display. Provide the refined code only, no explanations. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlCode', 'htmlRefineStatus', button, 'Refine Code');
        });

        document.getElementById('refineCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('cssExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('cssReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to refine.'); return; }
            const prompt = `Optimize the following CSS code for efficiency, readability, and modern practices, focusing on visual and motion effects relevant to media content. Provide the refined code only, no explanations. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssCode', 'cssRefineStatus', button, 'Refine Code');
        });

        document.getElementById('refineJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget; // Get the button element
            document.getElementById('jsExplanationOutput').classList.add('hidden'); // Hide explanation if refining
            document.getElementById('jsReviewOutput').classList.add('hidden'); // Hide review if refining
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to refine.'); return; }
            const prompt = `Refactor and optimize the following JavaScript code for readability, performance, and best practices, specifically for interactive motion, media playback, or audio processing logic. Provide the refined code only, no explanations. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsCode', 'jsRefineStatus', button, 'Refine Code');
        });

        // Event listeners for Code Explanation Buttons
        document.getElementById('explainHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget;
            document.getElementById('htmlReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to explain.'); return; }
            const prompt = `Explain the key components and their purpose in the following HTML code, particularly focusing on elements related to media display (audio/video tags, canvas, etc.). Provide a high-level explanation. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlExplanationOutput', 'htmlRefineStatus', button, 'Explain Code');
        });

        document.getElementById('explainCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget;
            document.getElementById('cssReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to explain.'); return; }
            const prompt = `Explain the purpose of the main CSS rules and how they affect the layout and appearance of the page, especially any styling related to media players or visual effects. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssExplanationOutput', 'cssRefineStatus', button, 'Explain Code');
        });

        document.getElementById('explainJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget;
            document.getElementById('jsReviewOutput').classList.add('hidden'); // Hide review if explaining
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to explain.'); return; }
            const prompt = `Explain the main functions and logic of the following JavaScript code, focusing on its interaction with media, audio processing, or motion control. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsExplanationOutput', 'jsRefineStatus', button, 'Explain Code');
        });

        // Event listeners for Code Review Buttons
        document.getElementById('reviewHtmlBtn')?.addEventListener('click', async (event) => {
            const htmlCode = document.getElementById('htmlCode').value;
            const button = event.currentTarget;
            document.getElementById('htmlExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!htmlCode.trim()) { window.showCustomModal('Input Required', 'Please paste HTML code to review.'); return; }
            const prompt = `Provide a detailed code review for the following HTML, with a focus on best practices for embedding and presenting motion, media, and sonic content. Point out potential issues, suggest improvements for accessibility, semantic structure, and performance (e.g., lazy loading, proper codecs). Use a clear, constructive tone. \n\n${htmlCode}`;
            await window.callGeminiAPI(prompt, 'htmlReviewOutput', 'htmlRefineStatus', button, 'Review Code');
        });

        document.getElementById('reviewCssBtn')?.addEventListener('click', async (event) => {
            const cssCode = document.getElementById('cssCode').value;
            const button = event.currentTarget;
            document.getElementById('cssExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!cssCode.trim()) { window.showCustomModal('Input Required', 'Please paste CSS code to review.'); return; }
            const prompt = `Provide a detailed code review for the following CSS, with a focus on styling for motion, media, and sonic content. Suggest improvements for responsiveness, cross-browser compatibility, and visual effects (e.g., animations, transitions for media elements). Identify any redundant or conflicting styles. Use a clear, constructive tone. \n\n${cssCode}`;
            await window.callGeminiAPI(prompt, 'cssReviewOutput', 'cssRefineStatus', button, 'Review Code');
        });

        document.getElementById('reviewJsBtn')?.addEventListener('click', async (event) => {
            const jsCode = document.getElementById('jsCode').value;
            const button = event.currentTarget;
            document.getElementById('jsExplanationOutput').classList.add('hidden'); // Hide explanation if reviewing
            if (!jsCode.trim()) { window.showCustomModal('Input Required', 'Please paste JavaScript code to review.'); return; }
            const prompt = `Provide a detailed code review for the following JavaScript, with a focus on logic for motion, media playback, or sonic interactions. Suggest improvements for performance, error handling, event listeners for media, and adherence to modern best practices. Identify potential bugs or security vulnerabilities related to media manipulation. Use a clear, constructive tone. \n\n${jsCode}`;
            await window.callGeminiAPI(prompt, 'jsReviewOutput', 'jsRefineStatus', button, 'Review Code');
        });


        // Event listener for Generate Content Ideas Button
        document.getElementById('generateContentIdeasBtn')?.addEventListener('click', async (event) => {
            const scrollTopic = document.getElementById('scrollTopic').value.trim();
            const button = event.currentTarget; // Get the button element
            if (!scrollTopic) {
                window.showCustomModal('Input Required', 'Please enter a topic to generate content ideas.');
                return;
            }
            const prompt = `Generate 5 creative and engaging content section ideas for a web page about "${scrollTopic}", specifically for motion, media, or sonic content. For each idea, provide a catchy title and a brief 1-2 sentence description. Format the output as a Markdown list.`;
            await window.callGeminiAPI(prompt, 'contentIdeasOutput', 'contentIdeasStatus', button, 'AI Generate');
        });


        // --- File Upload & URL Import Functions ---

        // Generic File Upload Handler
        function setupFileUpload(inputId, textareaId, statusId) {
            document.getElementById(inputId)?.addEventListener('change', function(event) {
                const file = event.target.files[0];
                const statusElement = document.getElementById(statusId);
                const textarea = document.getElementById(textareaId);

                if (!file) {
                    statusElement.textContent = 'No file selected.';
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    textarea.value = e.target.result;
                    statusElement.textContent = `File "${file.name}" loaded successfully.`;
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                };
                reader.onerror = () => {
                    statusElement.textContent = `Error reading file "${file.name}".`;
                    statusElement.classList.remove('hidden');
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                };
                reader.readAsText(file);
            });
        }

        // Generic URL Import Handler
        function setupUrlImport(buttonId, urlInputId, textareaId, statusId) {
            document.getElementById(buttonId)?.addEventListener('click', async function() {
                const url = document.getElementById(urlInputId).value.trim();
                const statusElement = document.getElementById(statusId);
                const textarea = document.getElementById(textareaId);

                if (!url) {
                    window.showCustomModal('Input Required', 'Please enter a URL to import code from.');
                    return;
                }

                statusElement.textContent = 'Importing from URL...';
                statusElement.classList.remove('hidden');
                // Temporarily disable elements
                document.getElementById(buttonId).disabled = true;
                document.getElementById(urlInputId).disabled = true;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const text = await response.text();
                    textarea.value = text;
                    statusElement.textContent = 'Code imported successfully from URL.';
                } catch (error) {
                    statusElement.textContent = `Error importing code: ${error.message}`;
                    console.error('URL Import Error:', error);
                    window.showCustomModal('Import Error', `Failed to import code from URL: ${error.message}`, true);
                } finally {
                    document.getElementById(buttonId).disabled = false;
                    document.getElementById(urlInputId).disabled = false;
                    setTimeout(() => statusElement.classList.add('hidden'), 3000);
                }
            });
        }


        // --- Templates View Logic ---
        function renderTemplates() {
            const templatesGrid = document.getElementById('templatesGrid');
            if (!templatesGrid) return;
            templatesGrid.innerHTML = ''; // Clear existing templates

            if (appData.templates.length === 0) {
                 templatesGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full">No templates available. Please add some.</p>';
            }

            appData.templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'panel bg-gray-900 border border-gray-700'; // Apply consistent panel styling
                
                // Construct inner HTML
                templateCard.innerHTML = `
                    <h4 class="mb-2"><i class="${template.icon} mr-2"></i> ${template.name}</h4>
                    <p class="text-gray-400 text-sm">${template.description}</p>
                `;
                // Create button separately and attach event listener
                const useTemplateButton = document.createElement('button');
                useTemplateButton.className = 'form-action-button mt-4';
                useTemplateButton.textContent = 'Use This Template';
                useTemplateButton.addEventListener('click', () => {
                    window.showTemplatePreviewModal(template); // Show template preview
                });
                templateCard.appendChild(useTemplateButton); // Append button to card

                templatesGrid.appendChild(templateCard);
            });
            // Ensure templates dropdowns are also populated when this view renders
            populateTemplateSelects();
        }

        // Helper function to populate template selects (called during initial load and template view render)
        function populateTemplateSelects() {
            const newProjectTemplateSelect = document.querySelector('#new-project-view #template');
            if(newProjectTemplateSelect) {
                newProjectTemplateSelect.innerHTML = appData.templates.map(t => `<option value="${t.name}">${t.name}</option>`).join(''); // Using name as value for simplicity
                newProjectTemplateSelect.insertAdjacentHTML('afterbegin', '<option value="">Select a template...</option>');
                newProjectTemplateSelect.value = ""; // Default empty
            }

            const scrollBuilderTemplateSelect = document.querySelector('#scroll-builder-view #sbScrollType');
            if(scrollBuilderTemplateSelect) {
                scrollBuilderTemplateSelect.innerHTML = `
                    <option value="">Select a content type...</option>
                    <option value="audio-visualizer">Audio Visualizer</option>
                    <option value="video-player">Video Player (Basic)</option>
                    <option value="motion-graphics">Motion Graphics Canvas</option>
                    <option value="interactive-soundscape">Interactive Soundscape</option>
                   `;
            }
        }

        // --- Template Preview Modal Logic ---
        window.showTemplatePreviewModal = function(template) {
            const modal = document.getElementById('templatePreviewModal');
            const previewTitle = document.getElementById('templatePreviewTitle');
            const previewFrame = document.getElementById('templatePreviewFrame');
            const previewDescription = document.getElementById('templatePreviewDescription');
            const useTemplateNewProjectBtn = document.getElementById('useTemplateNewProjectBtn');
            const useTemplateScrollBuilderBtn = document.getElementById('useTemplateScrollBuilderBtn');

            if (!modal || !previewTitle || !previewFrame || !previewDescription || !useTemplateNewProjectBtn || !useTemplateScrollBuilderBtn) return;

            previewTitle.textContent = template.name;
            previewDescription.textContent = template.description;
            
            // Set iframe srcdoc with the template's preview HTML
            previewFrame.srcdoc = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Preview</title>
                    <style>
                        /* Common preview styles, ensure colors match the current dashboard theme (light/dark) */
                        body { 
                            font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; text-align: center; 
                            background-color: ${document.body.classList.contains('light-mode') ? '#f8f8f8' : '#1a1a1c'}; 
                            color: ${document.body.classList.contains('light-mode') ? '#1d1d1f' : '#f5f5f7'};
                        }
                        h1 { 
                            font-size: 1.8rem; font-weight: 800; margin-bottom: 1rem;
                            color: #ff3b30; /* Primary Sonic color */
                        }
                        h1 span {
                            color: #0071e3; /* Accent blue */
                        }
                        h2 { 
                            font-size: 1.2rem; color: ${document.body.classList.contains('light-mode') ? '#4a4a4a' : '#a0a0a5'}; margin-bottom: 1.5rem; 
                        }
                        p { 
                            font-size: 0.95rem; line-height: 1.5; 
                            color: ${document.body.classList.contains('light-mode') ? '#6e6e73' : '#b0b0b0'}; 
                        }
                        button { 
                            background-color: #0071e3; 
                            color: white; padding: 0.75rem 1.5rem; border-radius: 8px; margin-top: 1.5rem; border: none; cursor: pointer;
                        }
                        audio, video {
                            width: 80%;
                            max-width: 400px;
                            margin: 1.5rem auto;
                            display: block;
                        }
                        iframe {
                            width: 100%;
                            height: 250px;
                            margin-top: 1.5rem;
                            border-radius: 8px;
                            border: 1px solid #3a3a3e;
                        }
                    </style>
                </head>
                <body>
                    ${template.htmlCode}
                </body>
                </html>
            `;
            
            // Set up action buttons to select template in forms
            useTemplateNewProjectBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                showView('new-project');
                const selectElement = document.querySelector('#new-project-view #template');
                if (selectElement) { selectElement.value = template.name; } // Set value to template name
            };

            useTemplateScrollBuilderBtn.onclick = () => {
                window.hideTemplatePreviewModal();
                window.showCustomModal('Feature Not Fully Implemented', 'This feature is currently in development. Please select the template in the Content Builder manually.', true); // Informative message
                showView('scroll-builder');
            };


            modal.classList.add('active'); // Show modal with animation
        };

        window.hideTemplatePreviewModal = function() {
            document.getElementById('templatePreviewModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Simplify Agreement Modal Logic ---
        window.showSimplifyAgreementModal = function(title, simplifiedText) {
            const modal = document.getElementById('simplifyAgreementModal');
            const modalTitle = document.getElementById('simplifyAgreementTitle');
            const modalText = document.getElementById('simplifiedAgreementText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = simplifiedText; // Use innerHTML to allow for formatting
                modal.classList.add('active'); // Show modal with animation
            }
        };

        window.hideSimplifyAgreementModal = function() {
            document.getElementById('simplifyAgreementModal')?.classList.remove('active'); // Hide modal with animation
        };

        // --- Project Idea Modal Logic ---
        window.showProjectIdeaModal = function(projectName, projectDescription, suggestedTemplate) {
            const modal = document.getElementById('projectIdeaModal');
            const ideaProjectName = document.getElementById('ideaProjectName');
            const ideaProjectDescription = document.getElementById('ideaProjectDescription');
            const ideaSuggestedTemplate = document.getElementById('ideaSuggestedTemplate');
            const applyButton = document.getElementById('applyProjectIdeaBtn');

            if (modal && ideaProjectName && ideaProjectDescription && ideaSuggestedTemplate && applyButton) {
                ideaProjectName.textContent = projectName;
                ideaProjectDescription.textContent = projectDescription;
                ideaSuggestedTemplate.textContent = suggestedTemplate;

                applyButton.onclick = () => {
                    document.getElementById('projectName').value = projectName;
                    document.getElementById('description').value = projectDescription;
                    const templateSelect = document.getElementById('template');
                    if (templateSelect) {
                        const optionExists = Array.from(templateSelect.options).some(option => option.value === suggestedTemplate);
                        if (optionExists) {
                            templateSelect.value = suggestedTemplate;
                        } else {
                            // If suggested template doesn't exist, select the first available or default
                            templateSelect.value = templateSelect.options[1] ? templateSelect.options[1].value : ""; 
                            window.showCustomModal('Template Not Found', `"${suggestedTemplate}" template not found. Selected a default.`, true);
                        }
                    }
                    window.hideProjectIdeaModal();
                };

                modal.classList.add('active');
            }
        };

        window.hideProjectIdeaModal = function() {
            document.getElementById('projectIdeaModal')?.classList.remove('active');
        };

        // --- Project Summary Modal (NEW) ---
        window.showProjectSummaryModal = function(title, summaryText) {
            const modal = document.getElementById('projectSummaryModal');
            const modalTitle = document.getElementById('projectSummaryTitle');
            const modalText = document.getElementById('projectSummaryText');

            if (modal && modalTitle && modalText) {
                modalTitle.textContent = title;
                modalText.innerHTML = summaryText; // Use innerHTML to allow for formatting
                modal.classList.add('active');
            }
        };

        window.hideProjectSummaryModal = function() {
            document.getElementById('projectSummaryModal')?.classList.remove('active');
        };

        // --- Email Draft Modal (NEW) ---
        let currentEmailForDraft = ''; // Store the email being drafted for

        window.openEmailDraftModal = function(emailAddress) {
            currentEmailForDraft = emailAddress;
            const modal = document.getElementById('emailDraftModal');
            const modalTitle = document.getElementById('emailDraftTitle');
            const emailDraftTo = document.getElementById('emailDraftTo');
            const emailPurposeInput = document.getElementById('emailPurposeInput');
            const generatedEmailDraftOutput = document.getElementById('generatedEmailDraftOutput');
            const emailDraftStatus = document.getElementById('emailDraftStatus');

            if (modal && modalTitle && emailDraftTo && emailPurposeInput && generatedEmailDraftOutput && emailDraftStatus) {
                modalTitle.textContent = `Draft Email for ${emailAddress}`;
                emailDraftTo.textContent = emailAddress;
                emailPurposeInput.value = ''; // Clear previous input
                generatedEmailDraftOutput.value = ''; // Clear previous draft
                emailDraftStatus.classList.add('hidden'); // Hide status
                modal.classList.add('active');
            }
        };

        window.hideEmailDraftModal = function() {
            document.getElementById('emailDraftModal')?.classList.remove('active');
            currentEmailForDraft = ''; // Clear stored email
        };


        // --- Licenses View Logic ---
        function renderLicenses() {
            const licensesList = document.getElementById('licensesList');
            if (!licensesList) return;
            licensesList.innerHTML = ''; // Clear existing licenses

            if (appData.licenses.length === 0) {
                licensesList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No licenses found.</p>';
            }

            appData.licenses.forEach(license => {
                const statusClass = license.verified ? 'status-live' : 'status-pending';
                const buttonText = license.verified ? 'Open in Workspace' : 'Sync License Now';
                const buttonAction = license.verified ? 'window.showCustomModal("Action", `Opening workspace for ${license.name}... (Simulation)`)' : 'window.showCustomModal("Sync Initiated", `Initiating sync for ${license.name}. Please check back later. (Simulation)`)';

                const licenseCard = document.createElement('div');
                licenseCard.className = 'panel bg-gray-900 border border-gray-700';
                licenseCard.innerHTML = `
                    <h4 class="mb-2">${license.name}</h4>
                    <p><strong>License ID:</strong> <span class="text-gray-400">${license.id}</span></p>
                    <p><strong>Region:</strong> <span class="text-gray-400">${license.region}</span></p>
                    <p><strong>Royalty:</strong> <span class="text-gray-400">${license.royalty}</span></p>
                    <p><strong>Activation Date:</strong> <span class="text-gray-400">${new Date(license.activationDate).toLocaleDateString()}</span></p>
                    <p><strong>ClaimRoot Status:</strong> <span class="text-gray-400">${license.claimStatus}</span></p>
                    <p class="project-status ${statusClass} mt-3">
                        <i class="fas ${license.verified ? 'fa-check-circle' : 'fa-hourglass-half'} mr-1"></i>
                        ${license.verified ? 'Content Verified & Active' : 'Awaiting Content Registration'}
                    </p>
                    <button class="form-action-button mt-4" onclick='${buttonAction}'>
                        ${buttonText}
                    </button>
                `;
                licensesList.appendChild(licenseCard);
            });
        }

        function renderRoyaltyAgreements() {
            const agreementsList = document.getElementById('royaltyAgreementsList');
            if (!agreementsList) return;
            agreementsList.innerHTML = '';

            if (appData.royaltyAgreements.length === 0) {
                 agreementsList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No royalty agreements found.</p>';
            }

            appData.royaltyAgreements.forEach(agreement => {
                const statusClass = agreement.status === 'Signed' ? 'status-live' : 'status-pending';
                const buttonText = agreement.status === 'Signed' ? 'View Agreement' : 'Sign via SecureSignâ„¢';
                
                const signButton = document.createElement('button');
                signButton.className = 'form-action-button mt-4';
                signButton.innerHTML = `<i class="fas ${agreement.status === 'Signed' ? 'fa-eye' : 'fa-signature'} mr-2"></i> ${buttonText}`;
                signButton.addEventListener('click', () => { // Add event listener here
                    window.showCustomModal("SecureSignâ„¢", `Redirecting to SecureSignâ„¢ for signature of "${agreement.name}". Please confirm in the pop-up. (Simulation)`, true); // Now `agreement` is scoped
                    // In a real app, this would redirect to SecureSign with agreement ID
                    // window.open('securesign_portal.html?agreementId=' + agreement.id, '_blank');
                });

                const simplifyButton = document.createElement('button');
                simplifyButton.className = 'form-action-button secondary ml-2 mt-4';
                simplifyButton.id = `simplifyAgreementBtn-${agreement.id}`; // Unique ID for each button
                simplifyButton.innerHTML = `âœ¨ Simplify Agreement`;
                const simplifyStatusId = `simplifyAgreementStatus-${agreement.id}`;
                const simplifyStatusElement = document.createElement('p');
                simplifyStatusElement.id = simplifyStatusId;
                simplifyStatusElement.className = 'text-xs text-gray-400 mt-1 hidden';


                simplifyButton.addEventListener('click', async (event) => {
                    const button = event.currentTarget;
                    if (!agreement.description.trim()) {
                        window.showCustomModal('No Text', 'There is no description to simplify for this agreement.', true);
                        return;
                    }
                    const prompt = `Simplify the following legal agreement text into plain, easy-to-understand language. Keep it concise but capture all key points. Do not include any introductory or concluding remarks outside the simplified text itself. \n\n${agreement.description}`;
                    // Use a temporary div to get the output from Gemini API, then pass to modal
                    const tempOutputDiv = document.createElement('div');
                    tempOutputDiv.id = 'tempSimplifyOutput'; // Give it an ID so callGeminiAPI can target it
                    document.body.appendChild(tempOutputDiv); // Temporarily add to DOM for targeting

                    await window.callGeminiAPI(prompt, tempOutputDiv.id, simplifyStatusId, button, 'Simplify Agreement');
                    
                    if (tempOutputDiv.textContent) {
                        window.showSimplifyAgreementModal(`${agreement.name} (Simplified)`, tempOutputDiv.textContent);
                    }
                    document.body.removeChild(tempOutputDiv); // Clean up temp div
                });

                const agreementCard = document.createElement('div');
                agreementCard.className = 'panel bg-gray-900 border border-gray-700';
                agreementCard.innerHTML = `
                    <h4 class="mb-2">${agreement.name}</h4>
                    <p class="text-gray-400 text-sm mb-2">${agreement.description}</p>
                    <p><strong>Status:</strong> <span class="project-status ${statusClass}">${agreement.status.toUpperCase()}</span></p>
                `;
                agreementCard.appendChild(signButton); // Append the sign button
                agreementCard.appendChild(simplifyButton); // Append the simplify button
                agreementCard.appendChild(simplifyStatusElement); // Append the status element

                agreementsList.appendChild(agreementCard);
            });
        }


        // --- Analytics View Logic ---
        function renderAnalyticsCharts() {
            // Deployment Trends
            const dtCtx = document.getElementById('deploymentTrendsChart')?.getContext('2d');
            if (dtCtx) {
                currentChartInstances.deploymentTrendsChart = new Chart(dtCtx, {
                    type: 'bar',
                    data: appData.analytics.deploymentTrends,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }

            // Royalty Distribution
            const rdCtx = document.getElementById('royaltyDistributionChart')?.getContext('2d');
            if (rdCtx) {
                currentChartInstances.royaltyDistributionChart = new Chart(rdCtx, {
                    type: 'doughnut',
                    data: appData.analytics.royaltyDistribution,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                    }
                });
            }

            // User Activity
            const uaCtx = document.getElementById('userActivityChart')?.getContext('2d');
            if (uaCtx) {
                currentChartInstances.userActivityChart = new Chart(uaCtx, {
                    type: 'line',
                    data: appData.analytics.userActivity,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white', font: { family: 'Inter' } } } },
                        scales: {
                            x: { ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } },
                            y: { beginAtZero: true, ticks: { color: document.body.classList.contains('light-mode') ? appData.colors.textDark : 'white' }, grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }
        }

        // --- API Keys View Logic ---
        function renderApiKeysTable() {
            const apiKeysTableBody = document.getElementById('apiKeysTableBody');
            if (!apiKeysTableBody) return;
            apiKeysTableBody.innerHTML = '';

            if (appData.apiKeys.length === 0) {
                 apiKeysTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">No API keys found.</td></tr>';
            }

            appData.apiKeys.forEach(keyData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold text-gray-200">${keyData.service} <br> ${keyData.context ? `<span class="text-xs text-gray-400">(${keyData.context})</span>` : ''}</td>
                    <td class="api-key-value">${keyData.key}</td>
                    <td class="text-gray-400 text-sm">${keyData.locations.join(', ')}</td>
                `;
                apiKeysTableBody.appendChild(row);
            });
        }

        // --- Settings View Logic ---
        async function loadSettings() {
            if (window.getUserId() === 'loading') {
                console.log("User ID not available yet for loading settings.");
                return;
            }
            const userSettingsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/settings`;
            const settings = await window.firestoreGetDoc(userSettingsPath, 'userProfile');
            if (settings) {
                document.getElementById('displayName').value = settings.displayName || '';
                document.getElementById('email').value = settings.email || '';
                document.getElementById('defaultRegion').value = settings.defaultRegion || 'Global Stream';
                document.getElementById('autoClaimSetting').value = settings.autoClaim || 'yes';
            } else {
                // If settings document doesn't exist, set initial values
                await window.firestoreSetDoc(userSettingsPath, 'userProfile', {
                    displayName: "SonicMaestro001",
                    email: "sonic.user@example.com",
                    defaultRegion: "Global Stream",
                    autoClaim: "yes"
                });
                loadSettings(); // Reload after setting defaults
            }

            // Render DNS records and email accounts from Firestore
            renderDnsRecords();
            renderEmailAccounts();
            renderDomains();
            renderSettingsCompanySelection(); // Render company selection for settings
        }

        // Save User Profile
        async function saveUserProfile() {
            if (window.getUserId() === 'loading') {
                 window.showCustomModal('Error', 'User not authenticated yet. Please wait.', true);
                 return;
            }
            const userSettingsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/settings`;
            const displayName = document.getElementById('displayName').value;
            const email = document.getElementById('email').value;
            try {
                await window.firestoreSetDoc(userSettingsPath, 'userProfile', { displayName, email });
                window.showCustomModal('Profile Updated!', 'Your display name and email have been saved.', true);
            } catch (error) {
                window.showCustomModal('Save Error', `Failed to save profile: ${error.message}`, true);
            }
        }
        window.saveUserProfile = saveUserProfile; // Expose globally

        // Save Content Preferences
        async function saveContentPreferences() {
            if (window.getUserId() === 'loading') {
                 window.showCustomModal('Error', 'User not authenticated yet. Please wait.', true);
                 return;
            }
            const userSettingsPath = `artifacts/${APP_ID}/users/${window.getUserId()}/settings`;
            const defaultRegion = document.getElementById('defaultRegion').value;
            const autoClaim = document.getElementById('autoClaimSetting').value;
            try {
                await window.firestoreSetDoc(userSettingsPath, 'userProfile', { defaultRegion, autoClaim }, { merge: true }); // Merge to not overwrite other profile data
                window.showCustomModal('Preferences Saved!', 'Your content preferences have been updated.', true);
            }
            catch (error) {
                window.showCustomModal('Save Error', `Failed to save preferences: ${error.message}`, true);
            }
        }
        window.saveContentPreferences = saveContentPreferences; // Expose globally


        // Settings Tab Navigation Logic
        function showSettingsTab(tabId) {
            // Hide all sub-views
            document.querySelectorAll('.settings-sub-view').forEach(view => {
                view.classList.add('hidden');
            });
            // Show the selected sub-view
            document.getElementById(`settings-${tabId}`).classList.remove('hidden');

            // Update active button state
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                if (btn.getAttribute('data-settings-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render domain/email/dns data if switching to that tab
            if (tabId === 'domains') {
                renderDnsRecords();
                renderEmailAccounts();
                renderDomains();
                renderSettingsCompanySelection(); // Ensure selection is rendered on tab switch
            }
        }
        window.showSettingsTab = showSettingsTab; // Make global for direct calls from HTML

        // Render DNS Records (from Firestore)
        function renderDnsRecords() {
            const dnsTableBody = document.getElementById('dnsRecordsTableBody');
            if (!dnsTableBody) return;
            dnsTableBody.innerHTML = '';
            
            if (appData.dnsRecords.length === 0) {
                 dnsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400">No DNS records found.</td></tr>';
            }

            appData.dnsRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-semibold">${record.type}</td>
                    <td>${record.name}</td>
                    <td>${record.value}</td>
                    <td>${record.ttl}</td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit DNS', 'Edit functionality for ${record.name} coming soon! (Simulation)')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="deleteDnsRecord('${record.id}')">Delete</button>
                    </td>
                `;
                dnsTableBody.appendChild(row);
            });
        }

        // Add DNS Record (Simulated via Firestore addDoc)
        async function addDnsRecord() {
            const type = prompt("Enter DNS Record Type (e.g., A, CNAME, MX):");
            if (!type) return;
            const name = prompt("Enter DNS Record Name (e.g., @, www, mail):");
            if (!name) return;
            const value = prompt("Enter DNS Record Value:");
            if (!value) return;
            const ttl = prompt("Enter TTL (e.g., Auto, 3600):", "Auto");

            if (type && name && value) {
                const publicDnsRecordsPath = `artifacts/${APP_ID}/public/data/dnsRecords`;
                try {
                    await window.firestoreAddDoc(publicDnsRecordsPath, { type, name, value, ttl });
                    window.showCustomModal('DNS Record Added', `Record "${name}" (${type}) added successfully.`, true);
                } catch (error) {
                    window.showCustomModal('Error', `Failed to add DNS record: ${error.message}`, true);
                }
            } else {
                window.showCustomModal('Input Required', 'All fields (Type, Name, Value) are required.', true);
            }
        }
        window.addDnsRecord = addDnsRecord; // Expose globally

        // Delete DNS Record (Simulated via Firestore deleteDoc)
        async function deleteDnsRecord(docId) {
            if (confirm("Are you sure you want to delete this DNS record?")) {
                const publicDnsRecordsPath = `artifacts/${APP_ID}/public/data/dnsRecords`;
                try {
                    // Correct usage of deleteDoc with doc reference
                    await deleteDoc(doc(window.firestoreDb, publicDnsRecordsPath, docId));
                    window.showCustomModal('DNS Record Deleted', 'Record deleted successfully.', true);
                } catch (error) {
                    console.error("Error deleting DNS record:", error);
                    window.showCustomModal('Error', `Failed to delete DNS record: ${error.message}`, true);
                }
            }
        }
        window.deleteDnsRecord = deleteDnsRecord; // Expose globally


        // Render Domains (from Firestore)
        function renderDomains() {
            const domainList = document.getElementById('domainList');
            const addonDomainTargetSelect = document.getElementById('addonDomainTarget');
            if (!domainList || !addonDomainTargetSelect) return;
            
            domainList.innerHTML = ''; // Clear existing
            addonDomainTargetSelect.innerHTML = '<option value="">Select Primary Domain</option>';

            if (appData.domains.length === 0) {
                 domainList.innerHTML = '<p class="text-center text-gray-400 col-span-full">No domains found.</p>';
            }

            appData.domains.forEach(domain => {
                const listItem = document.createElement('li');
                const statusIcon = domain.type.includes('Pending') ? 'fas fa-hourglass-half text-yellow-500' : 'fas fa-check-circle text-green-500';
                listItem.innerHTML = `<i class="${statusIcon} mr-2"></i> ${domain.name} (${domain.type})`;
                domainList.appendChild(listItem);

                // Populate add-on domain select only with primary/active domains
                if (domain.type.includes('Primary') || domain.type.includes('Subdomain')) {
                    const option = document.createElement('option');
                    option.value = domain.name;
                    option.textContent = domain.name;
                    addonDomainTargetSelect.appendChild(option);
                }
            });
        }

        // Add Domain (Simulated via Firestore addDoc)
        async function addDomain() {
            const newDomainName = document.getElementById('newDomainName').value.trim();
            if (!newDomainName) {
                window.showCustomModal('Input Required', 'Please enter a domain name.', true);
                return;
            }
            const publicDomainsPath = `artifacts/${APP_ID}/public/data/domains`;
            try {
                await window.firestoreAddDoc(publicDomainsPath, { name: newDomainName, type: 'Primary' });
                window.showCustomModal('Domain Added', `Domain "${newDomainName}" added successfully.`, true);
                document.getElementById('newDomainName').value = ''; // Clear input
            } catch (error) {
                window.showCustomModal('Error', `Failed to add domain: ${error.message}`, true);
            }
        }
        window.addDomain = addDomain; // Expose globally

        // Add Add-on Domain (Simulated via Firestore addDoc)
        async function addAddonDomain() {
            const newAddonDomainName = document.getElementById('newAddonDomainName').value.trim();
            const addonDomainTarget = document.getElementById('addonDomainTarget').value;
            if (!newAddonDomainName || !addonDomainTarget) {
                window.showCustomModal('Input Required', 'Please enter both add-on domain and select a primary domain.', true);
                return;
            }
            const publicDomainsPath = `artifacts/${APP_ID}/public/data/domains`;
            try {
                await window.firestoreAddDoc(publicDomainsPath, { name: `${newAddonDomainName}.${addonDomainTarget}`, type: 'Subdomain' });
                window.showCustomModal('Add-on Domain Added', `Add-on domain "${newAddonDomainName}.${addonDomainTarget}" added successfully.`, true);
                document.getElementById('newAddonDomainName').value = ''; // Clear input
            } catch (error) {
                window.showCustomModal('Error', `Failed to add add-on domain: ${error.message}`, true);
            }
        }
        window.addAddonDomain = addAddonDomain; // Expose globally


        // Render Email Accounts (from Firestore)
        function renderEmailAccounts() {
            const emailAccountsTableBody = document.getElementById('emailAccountsTableBody');
            if (!emailAccountsTableBody) return;
            emailAccountsTableBody.innerHTML = '';
            
            if (appData.emailAccounts.length === 0) {
                 emailAccountsTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">No email accounts found.</td></tr>';
            }

            appData.emailAccounts.forEach(account => {
                const row = document.createElement('tr');
                const statusClass = account.status === 'Active' ? 'text-green-500' : 'text-yellow-500';
                row.innerHTML = `
                    <td class="font-semibold">${account.email}</td>
                    <td><span class="${statusClass}">${account.status}</span></td>
                    <td class="text-right">
                        <button class="text-blue-500 hover:text-blue-700 text-sm mr-2" onclick="window.showCustomModal('Edit Email', 'Edit email ${account.email} functionality coming soon! (Simulation)')">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-sm" onclick="deleteEmailAccount('${account.id}')">Delete</button>
                        <button class="form-action-button text-xs px-3 py-2 mt-2 ml-2" onclick="window.openEmailDraftModal('${account.email}')">
                            <i class="fas fa-envelope"></i> âœ¨ Draft Email
                        </button>
                    </td>
                `;
                emailAccountsTableBody.appendChild(row);
            });
        }

        // Create Email (Simulated via Firestore addDoc)
        async function createEmail() {
            const newEmailPrefix = document.getElementById('newEmailPrefix').value.trim();
            const newEmailDomain = document.getElementById('newEmailDomain').value.trim();
            if (!newEmailPrefix || !newEmailDomain) {
                window.showCustomModal('Input Required', 'Please enter both email prefix and domain.', true);
                return;
            }
            const newEmail = `${newEmailPrefix}@${newEmailDomain}`;
            const publicEmailAccountsPath = `artifacts/${APP_ID}/public/data/emailAccounts`;
            try {
                await window.firestoreAddDoc(publicEmailAccountsPath, { email: newEmail, status: 'Pending Activation' });
                window.showCustomModal('Email Created', `Email "${newEmail}" created successfully. Activation pending.`, true);
                document.getElementById('newEmailPrefix').value = ''; // Clear input
            } catch (error) {
                window.showCustomModal('Error', `Failed to create email: ${error.message}`, true);
            }
        }
        document.getElementById('createEmailBtn')?.addEventListener('click', createEmail);


        // Delete Email Account (Simulated via Firestore deleteDoc)
        async function deleteEmailAccount(docId) {
            if (confirm("Are you sure you want to delete this email account?")) {
                const publicEmailAccountsPath = `artifacts/${APP_ID}/public/data/emailAccounts`;
                try {
                    await deleteDoc(doc(window.firestoreDb, publicEmailAccountsPath, docId));
                    window.showCustomModal('Email Deleted', 'Email account deleted successfully.', true);
                } catch (error) {
                    console.error("Error deleting email account:", error);
                    window.showCustomModal('Error', `Failed to delete email account: ${error.message}`, true);
                }
            }
        }
        window.deleteEmailAccount = deleteEmailAccount; // Expose globally

        // Render company selection cards for settings panel
        function renderSettingsCompanySelection() {
            const settingsCompanySelectionGrid = document.getElementById('settingsCompanySelectionGrid');
            if (settingsCompanySelectionGrid) {
                settingsCompanySelectionGrid.innerHTML = ''; // Clear previous selections
                const mediaCompanies = Object.entries(companyData).filter(([key, company]) => company.sector_key === "media");

                if (mediaCompanies.length === 0) {
                     settingsCompanySelectionGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full">No company data found for this sector.</p>';
                }

                mediaCompanies.forEach(([key, company]) => {
                    const card = document.createElement('div');
                    card.className = 'company-select-card p-4 rounded-lg text-center shadow-md cursor-pointer bg-gray-700 hover:bg-gray-600 border border-gray-600'; // Added styling classes
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-white">${company.name}</h3>
                        <p class="text-gray-400 text-xs">Sector: ${sectorList[company.sector_key].name}</p>
                    `;
                    card.onclick = () => window.renderSettingsCompanyDetails(key);
                    settingsCompanySelectionGrid.appendChild(card);
                });
            }
        }

        // Render detailed company information in settings
        window.renderSettingsCompanyDetails = function(companyKey) {
            const company = companyData[companyKey];
            const detailsOutput = document.getElementById('settingsCompanyDetailsOutput');
            if (!company || !detailsOutput) return;

            detailsOutput.innerHTML = `
                <h4 class="text-xl font-bold mb-4 text-white">${company.name} Infrastructure Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                    ${Object.entries(company.details).map(([key, value]) => `
                        <div class="bg-gray-800 p-4 rounded-md border border-gray-700">
                            <strong class="text-red-400">${key}:</strong> ${value}
                        </div>
                    `).join('')}
                </div>
                <button class="form-action-button mt-4 bg-red-600 hover:bg-red-700" onclick="showCustomModal('Simulation', 'Advanced company management tools coming soon!', true)">
                    <i class="fas fa-cogs mr-1"></i> Manage Company Infrastructure
                </button>
            `;
            detailsOutput.classList.remove('hidden');
        };

        // --- Ecosystem Map Functions ---
        // Function to render the Ecosystem Map
        function renderEcosystemMap() {
            const sectorContainer = document.getElementById('sectorContainer')?.querySelector('.space-y-3');
            if (!sectorContainer) return;
            sectorContainer.innerHTML = ''; // Clear previous content

            // Only render the 'media' sector for this specific dashboard
            const sectorKey = 'media';
            const sector = allSectorsData[sectorKey];
            
            if (sector) {
                const sectorDiv = document.createElement('div');
                sectorDiv.className = 'border border-gray-700 rounded-lg p-4 mb-4 bg-gray-800';
                sectorDiv.innerHTML = `
                    <button class="toggle-section-btn flex justify-between items-center w-full text-left p-2 -mx-2 -my-2 rounded-md hover:bg-gray-700 transition-colors duration-200" onclick="window.toggleSection('sector-${sectorKey}')">
                        <span class="text-blue-400 text-xl font-bold">${sector.name} <span class="text-gray-400 text-sm">(${sector.baseUrl})</span></span>
                        <span><i class="fas fa-chevron-down text-gray-400"></i></span>
                    </button>
                    <div id="sector-${sectorKey}" class="repo-content-section hidden mt-4">
                        <h4 class="text-lg font-semibold text-red-400 mb-2">Repository & Base URL:</h4>
                        <div class="copy-square">
                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">${sector.repoName}/</pre>
                        </div>
                        <div class="copy-square mt-2">
                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                            <pre class="conversation-code-block">${sector.baseUrl}/index</pre>
                        </div>
                        
                        <h4 class="text-lg font-semibold text-red-400 mb-2 mt-4">Brands & Subnodes:</h4>
                        <div class="space-y-2">
                            ${sector.brands.map(brand => `
                                <div class="border border-gray-700 rounded-md p-3 bg-gray-700">
                                    <button class="toggle-section-btn !bg-transparent !shadow-none !text-left !px-0 !py-0 !mb-0 flex justify-between items-center w-full hover:bg-gray-600 transition-colors duration-200" onclick="window.toggleSection('brand-${sectorKey}-${brand.name.replace(/ /g, '-')}')">
                                        <span class="text-white font-medium">${brand.name}</span> <span><i class="fas fa-chevron-down"></i></span>
                                    </button>
                                    <div id="brand-${sectorKey}-${brand.name.replace(/ /g, '-')}" class="repo-content-section !border-none !bg-transparent !p-0 hidden mt-2">
                                        <div class="copy-square">
                                            <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                            <pre class="conversation-code-block">${sector.baseUrl}/brands/${encodeURIComponent(brand.name.toLowerCase().replace(/ /g, '-'))}/index</pre>
                                        </div>
                                        ${brand.subnodes.map(subnode => `
                                            <div class="copy-square ml-4 mt-2">
                                                <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                                <pre class="conversation-code-block">${sector.baseUrl}/brands/${encodeURIComponent(brand.name.toLowerCase().replace(/ /g, '-'))}/${encodeURIComponent(subnode.toLowerCase().replace(/ /g, '-'))}/index</pre>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <h4 class="text-lg font-semibold text-red-400 mb-2 mt-4">Global Footer Pages:</h4>
                        <div class="space-y-2">
                            <div class="copy-square">
                                <button class="copy-button" onclick="window.copyToClipboard(this)">Copy</button>
                                <pre class="conversation-code-block">
${[
    '/privacy', '/terms', '/contact', '/copyright', '/developers',
    '/vaultmesh', '/fruitful', '/faa.zone', '/about', '/accessibility'
].map(p => `${sector.baseUrl}${p}`).join('\n')}
                                </pre>
                            </div>
                        </div>
                    </div>
                `;
                sectorContainer.appendChild(sectorDiv);
                // Automatically expand the media sector
                window.toggleSection(`sector-${sectorKey}`);
            } else {
                 sectorContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">Ecosystem map data not yet loaded from Firestore or "media" sector data is missing.</p>';
            }
        }

        // Utility function to toggle section visibility (for ecosystem map)
        window.toggleSection = function(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.toggle('hidden');
                const icon = element.previousElementSibling.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            }
        };

        // Utility function to copy text to clipboard (for ecosystem map and emails)
        window.copyToClipboard = function(buttonElement) {
            const preElement = buttonElement.nextElementSibling; // Get the <pre> tag next to the button
            if (preElement && preElement.tagName === 'PRE') {
                const textToCopy = preElement.textContent.trim();
                try {
                    // Use execCommand for broader compatibility within iframes
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    
                    window.showCustomModal('Copied!', 'Text copied to clipboard.', true);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    window.showCustomModal('Copy Failed', 'Failed to copy text. Please try manually.', true);
                }
            }
        };


        // --- Login and Signup Form Logic ---
        document.getElementById('loginForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Simple client-side validation for demo
            if (email === "sonic.user@example.com" && password === "password123") {
                window.showCustomModal('Login Successful!', 'Welcome back, Sonic Maestro!', true);
                // Simulate successful login - redirect to dashboard after modal
                setTimeout(() => {
                    showView('dashboard');
                }, 1500);
            } else {
                window.showCustomModal('Login Failed', 'Invalid email or password. Please try again.', true);
            }
        });

        document.getElementById('signupForm')?.addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (password !== confirmPassword) {
                window.showCustomModal('Signup Failed', 'Passwords do not match. Please try again.', true);
                return;
            }
            if (password.length < 6) { // Basic password length validation
                window.showCustomModal('Signup Failed', 'Password must be at least 6 characters long.', true);
                return;
            }

            // Simulate successful registration
            window.showCustomModal('Registration Successful!', `Welcome, ${name}! Your account has been created. Please sign in.`, true);
            
            // Optionally clear form
            this.reset();
            // Redirect to login page after a short delay
            setTimeout(() => {
                showView('login');
            }, 1500);
        });


        // --- Initial App Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, ensure all CSS custom properties are computed and stored in appData.colors
            // This needs to happen BEFORE any charts or elements that rely on these colors are rendered.
            const rootStyles = getComputedStyle(document.documentElement);
            appData.colors.primary = rootStyles.getPropertyValue('--primary-color').trim();
            appData.colors.secondary = rootStyles.getPropertyValue('--secondary-color').trim();
            appData.colors.textDark = rootStyles.getPropertyValue('--text-color-dark').trim();
            appData.colors.borderColorDark = rootStyles.getPropertyValue('--border-color-dark').trim();
            appData.colors.accentGold = rootStyles.getPropertyValue('--accent-gold').trim();

            // Set up sidebar navigation clicks
            document.querySelectorAll('.sidebar .nav-list a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior
                    const viewId = e.currentTarget.getAttribute('data-view');
                    if (viewId) {
                        showView(viewId);
                    }
                });
            });

            // Set up settings tab clicks
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.currentTarget.getAttribute('data-settings-tab');
                    showSettingsTab(tabId);
                });
            });


            // Set the initial view based on hash or default to dashboard
            const initialView = window.location.hash.substring(1) || 'dashboard';
            showView(initialView);

            // Populate template select dropdowns initially
            populateTemplateSelects();
            
            // Setup file upload and URL import listeners
            setupFileUpload('uploadHtml', 'htmlCode', 'htmlRefineStatus');
            setupUrlImport('importHtmlUrlBtn', 'importHtmlUrl', 'htmlCode', 'htmlRefineStatus');
            setupFileUpload('uploadCss', 'cssCode', 'cssRefineStatus');
            setupUrlImport('importCssUrlBtn', 'importCssUrl', 'cssCode', 'cssRefineStatus');
            setupFileUpload('uploadJs', 'jsCode', 'jsRefineStatus');
            setupUrlImport('importJsUrlBtn', 'importJsUrl', 'jsCode', 'jsRefineStatus');

            // Setup DNS Explain button listener
            document.getElementById('explainDnsBtn')?.addEventListener('click', async (event) => {
                const dnsType = document.getElementById('dnsRecordTypeInput').value.trim();
                const button = event.currentTarget;
                if (!dnsType) {
                    window.showCustomModal('Input Required', 'Please enter a DNS record type (e.g., A, CNAME, MX) to explain.');
                    return;
                }
                const prompt = `Explain what a "${dnsType}" DNS record is, its primary purpose, and a typical use case. Keep the explanation concise and easy to understand for a non-expert.`;
                await window.callGeminiAPI(prompt, 'dnsExplanationOutput', 'dnsExplainStatus', button, 'Explain DNS Type');
            });

            // Event listener for Generate Email Draft Button (NEW)
            document.getElementById('generateEmailDraftBtn')?.addEventListener('click', async (event) => {
                const emailPurpose = document.getElementById('emailPurposeInput').value.trim();
                const button = event.currentTarget;
                if (!emailPurpose) {
                    window.showCustomModal('Input Required', 'Please enter a purpose for the email.');
                    return;
                }
                const prompt = `Draft a professional email (max 200 words) for the purpose of "${emailPurpose}" from the email address "${currentEmailForDraft}". Focus on a clear and polite tone. Provide only the email body.`;
                await window.callGeminiAPI(prompt, 'generatedEmailDraftOutput', 'emailDraftStatus', button, 'Draft Email');
            });


            // Event Listeners for AI buttons within the integrated editor (re-mapped IDs)
            document.getElementById('editorRefineCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden');
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to refine.'); return; }
                const prompt = `Refine the following HTML/CSS code for better accessibility, semantic structure, and performance, specifically for motion, media, or sonic content display. Provide the refined code only, no explanations. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssCode', 'editorHtmlCssStatus', button, 'Refine Code');
            });

            document.getElementById('editorExplainCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to explain.'); return; }
                const prompt = `Explain the key components and their purpose in the following HTML/CSS code, particularly focusing on elements related to media display (audio/video tags, canvas, etc.). Provide a high-level explanation. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssExplanationOutput', 'editorHtmlCssStatus', button, 'Explain Code');
            });

            document.getElementById('editorReviewCodeBtn')?.addEventListener('click', async (event) => {
                const code = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden');
                document.getElementById('editorGeneratedContentOutput').classList.add('hidden'); 
                if (!code.trim()) { window.showCustomModal('Input Required', 'Please paste code to review.'); return; }
                const prompt = `Provide a detailed code review for the following HTML/CSS, with a focus on best practices for embedding and presenting motion, media, and sonic content. Point out potential issues, suggest improvements for accessibility, semantic structure, and performance (e.g., lazy loading, proper codecs). Use a clear, constructive tone. \n\n${code}`;
                await window.callGeminiAPI(prompt, 'editorHtmlCssReviewOutput', 'editorHtmlCssStatus', button, 'Review Code');
            });

            document.getElementById('editorGenerateHeadlineBtn')?.addEventListener('click', async (event) => {
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!currentContent.trim()) {
                    window.showCustomModal('Input Required', 'Please provide some content in the editor to generate a headline.');
                    return;
                }
                const prompt = `Generate 3 concise and catchy headlines for a landing page based on the following HTML content. Focus on appealing to users and summarizing the value proposition. Provide only the headlines as a markdown list. \n\n${currentContent}`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate Headline');
            });

            document.getElementById('editorGenerateCTABtn')?.addEventListener('click', async (event) => {
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!currentContent.trim()) {
                    window.showCustomModal('Input Required', 'Please provide some content in the editor to generate a Call to Action.');
                    return;
                }
                const prompt = `Generate 3 compelling and concise Calls-to-Action (CTAs) for a landing page based on the following HTML content. Make them action-oriented and encourage conversion. Provide only the CTAs as a markdown list. \n\n${currentContent}`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate CTA');
            });

            document.getElementById('editorGenerateSectionContentBtn')?.addEventListener('click', async (event) => {
                const sectionTopic = document.getElementById('editorSectionTopicInput').value.trim();
                const currentContent = document.getElementById('editorHtmlCssCode').value;
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!sectionTopic) {
                    window.showCustomModal('Input Required', 'Please enter a topic for the section content.');
                    return;
                }
                const prompt = `Generate a 2-3 paragraph section about "${sectionTopic}" for a motion, media, or sonic content page. Integrate it smoothly with the existing content, which is: \n\n${currentContent}\n\n Focus on compelling language and key benefits.`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Generate Section Content');
            });

            document.getElementById('editorRephraseTextBtn')?.addEventListener('click', async (event) => {
                const textToRephrase = document.getElementById('editorRephraseTextInput').value.trim();
                const button = event.currentTarget;
                document.getElementById('editorHtmlCssExplanationOutput').classList.add('hidden'); 
                document.getElementById('editorHtmlCssReviewOutput').classList.add('hidden');  
                if (!textToRephrase) {
                    window.showCustomModal('Input Required', 'Please enter text into the "Rephrase/Improve Text" field.');
                    return;
                }
                const prompt = `Rephrase and improve the following text for clarity, conciseness, and impact, suitable for a motion, media, or sonic content page. Provide 3 different versions as a markdown list. \n\n"${textToRephrase}"`;
                await window.callGeminiAPI(prompt, 'editorGeneratedContentOutput', 'editorContentGenStatus', button, 'Rephrase/Improve');
            });

            // Function to update the integrated editor's iframe preview
            window.updateEditorPreview = function() {
                const code = document.getElementById('editorHtmlCssCode').value;
                const previewFrame = document.getElementById('editorLivePreviewFrame');
                if (previewFrame) {
                    const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    doc.open();
                    doc.write(`
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Preview</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                    min-height: 100vh;
                                    background-color: #f8f8f8;
                                }
                                /* Styling for the generated content within the iframe preview */
                                .generated-content-wrapper {
                                    width: 100%;
                                    max-width: 600px; /* Constrain width for better readability */
                                    padding: 20px;
                                    box-sizing: border-box;
                                }
                                .generated-content-wrapper h1, .generated-content-wrapper h2 {
                                    color: #ff3b30; /* Primary Sonic Color */
                                    margin-bottom: 0.5rem;
                                }
                                .generated-content-wrapper h1 span {
                                    color: #0071e3; /* Accent Blue */
                                }
                                .generated-content-wrapper p {
                                    color: #4a4a4a;
                                    line-height: 1.6;
                                }
                                .generated-content-wrapper button {
                                    background-color: #0071e3; /* Accent Blue Button */
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    margin-top: 15px;
                                    border: none;
                                    cursor: pointer;
                                }
                                audio, video {
                                    width: 100%;
                                    max-width: 500px;
                                    margin-top: 15px;
                                }
                                iframe {
                                    width: 100%;
                                    height: 250px;
                                    margin-top: 15px;
                                    border-radius: 8px;
                                    border: 1px solid #ccc;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="generated-content-wrapper">
                                ${code}
                            </div>
                        </body>
                        </html>
                    `);
                    doc.close();
                }
            };

            // Theme toggle logic
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    const isLightMode = document.body.classList.contains('light-mode');
                    themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                    
                    // Re-render charts to update colors based on new theme
                    renderViewContent(window.location.hash.substring(1) || 'dashboard');
                });
                // Set initial icon based on default theme
                const isLightMode = document.body.classList.contains('light-mode');
                themeToggleBtn.innerHTML = isLightMode ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            }
        });
    </script>
</body>
</html>
